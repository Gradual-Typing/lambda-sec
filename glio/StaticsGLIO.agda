module StaticsGLIO where

open import Data.Nat using (â„•; zero; suc; _â‰¤_; zâ‰¤n; sâ‰¤s) renaming (_âŠ”_ to _âŠ”â‚™_; _âŠ“_ to _âŠ“â‚™_; _â‰Ÿ_ to _â‰Ÿâ‚™_)
open import Data.Nat.Properties using (â‰¤-refl; _â‰¤?_)
open import Data.List using (List; []; _âˆ·_)
open import Data.Maybe
import Relation.Binary.PropositionalEquality as Eq
open Eq using (_â‰¡_; refl; sym; cong; congâ‚‚)
open import Relation.Nullary using (Dec; yes; no; Â¬_)
open import Data.Product using (_Ã—_; projâ‚; projâ‚‚) renaming (_,_ to âŸ¨_,_âŸ©)

import Syntax

{-
  +------------------------------------+
  |          Index of Relations        |
  +===+================================+
  | âŠ” | Label join (â„“)                 |
  | âŠ“ | Label meet (â„“)                 |
  | â‰¼ | Label partial order (â„“)        |
  +---+--------------------------------+
  | â‹ | Gradual label join (â„“Ì‚)         |
  | â‹ | Gradual label meet (â„“Ì‚)         |
  | âˆ | Gradual label intersection (â„“Ì‚) |
  | â‰¾ | Label consistent subtyping (â„“Ì‚) |
  +---+--------------------------------+
  | âˆ¨ | Type join (ğ•‹)                  |
  | âˆ§ | Type meet (ğ•‹)                  |
  | âˆ© | Type intersection (ğ•‹)          |
  | â‰² | Type consistent subtyping (ğ•‹)  |
  +---+--------------------------------+
-}

pattern âŸ¨_,_,_âŸ© x y z = âŸ¨ x , âŸ¨ y , z âŸ© âŸ©

infixr 6 _[_]â‡’[_]_
infixl 7 _Â·_
infixl 8 _`âŠ”_  -- join
infixl 8 _`âŠ“_  -- meet
infixl 9 _`â‰¼_  -- label leq

data â„’ : Set where
  l : â„• â†’ â„’

data â„’Ì‚ : Set where
  Â¿ : â„’Ì‚
  lÌ‚ : â„’ â†’ â„’Ì‚


-- Examples: low and high.
ğ¿ : â„’
ğ¿ = l 0
ğ¿Ì‚ = lÌ‚ ğ¿

ğ» : â„’
ğ» = l 1
ğ»Ì‚ = lÌ‚ ğ»

data ğ•‹ : Set where
  `âŠ¤ : ğ•‹                          -- Unit
  `ğ”¹ : ğ•‹                         -- Bool
  `â„’ : ğ•‹                         -- IF Label
  Ref : â„’Ì‚ â†’ ğ•‹ â†’ ğ•‹                -- Ref â„“Ì‚ T - reference
  Lab : â„’Ì‚ â†’ ğ•‹ â†’ ğ•‹                -- Lab â„“Ì‚ T - labeled type
  _[_]â‡’[_]_ : ğ•‹ â†’ â„’Ì‚ â†’ â„’Ì‚ â†’ ğ•‹ â†’ ğ•‹  -- Tâ‚ [ â„“Ì‚â‚ ]â‡’[ â„“Ì‚â‚‚ ] Tâ‚‚

-- Typing context
Context : Set
Context = List ğ•‹

nth : âˆ€ {A : Set} â†’ List A â†’ â„• â†’ Maybe A
nth [] k = nothing
nth (x âˆ· ls) zero = just x
nth (x âˆ· ls) (suc k) = nth ls k

-- We're using the ABT library.
open Syntax using (Sig; Rename; Î½; âˆ; â– ; _â€¢_; id; â†‘; âŸ°)

data Op : Set where
  op-let : Op
  op-true       : Op
  op-false      : Op
  op-unit       : Op
  op-if  : Op
  op-lam : Op
  op-app : Op
  op-get : Op
  op-set : Op
  op-new : â„’ â†’ Op
  op-new-dyn : Op
  op-eq-ref  : Op
  op-ref-label : Op
  op-lab-label : Op
  op-pc-label : Op
  op-label : â„’ â†’ Op       -- Note that although we have first class labels, they cannot be Â¿
  op-label-join : Op
  op-label-meet : Op
  op-label-leq : Op
  op-unlabel : Op
  op-to-label : â„’ â†’ Op
  op-to-label-dyn : Op

sig : Op â†’ List Sig
sig op-let      = â–  âˆ· (Î½ â– ) âˆ· []
sig op-true            = []
sig op-false           = []
sig op-unit            = []
sig op-if       = â–  âˆ· â–  âˆ· â–  âˆ· []
sig op-lam      = (Î½ â– ) âˆ· []
sig op-app      = â–  âˆ· â–  âˆ· []
sig op-get      = â–  âˆ· []
sig op-set      = â–  âˆ· â–  âˆ· []
sig (op-new â„“)  = â–  âˆ· []
sig op-new-dyn  = â–  âˆ· â–  âˆ· []
sig op-eq-ref   = â–  âˆ· â–  âˆ· []
sig op-ref-label = â–  âˆ· []
sig op-lab-label = â–  âˆ· []
sig op-pc-label  = []  -- does not have any sub-term
sig (op-label â„“) = []
sig op-label-join     = â–  âˆ· â–  âˆ· []
sig op-label-meet     = â–  âˆ· â–  âˆ· []
sig op-label-leq      = â–  âˆ· â–  âˆ· []
sig op-unlabel        = â–  âˆ· []
sig (op-to-label â„“)   = â–  âˆ· []
sig op-to-label-dyn   = â–  âˆ· â–  âˆ· []

open Syntax.OpSig Op sig
  using (`_; _â¦…_â¦†; cons; nil; bind; ast; _[_]; Subst; âŸª_âŸ«)
  renaming (ABT to Term) public

pattern `let M N = op-let â¦… cons (ast M) (cons (bind (ast N)) nil) â¦†
pattern `true = op-true â¦… nil â¦†
pattern `false = op-false â¦… nil â¦†
pattern `tt = op-unit â¦… nil â¦†
pattern if `x M N = op-if  â¦… cons (ast `x) (cons (ast M) (cons (ast N) nil)) â¦†
pattern Æ› N = op-lam â¦… cons (bind (ast N)) nil â¦†
pattern _Â·_ `x `y = op-app â¦… cons (ast `x) (cons (ast `y) nil) â¦†
pattern get `x = op-get â¦… cons (ast `x) nil â¦†
pattern set `x `y = op-set â¦… cons (ast `x) (cons (ast `y) nil) â¦†
pattern new â„“ `y = (op-new â„“) â¦… cons (ast `y) nil â¦†
pattern new-dyn `x `y = op-new-dyn â¦… cons (ast `x) (cons (ast `y) nil) â¦†
pattern eq-ref `x `y = op-eq-ref â¦… cons (ast `x) (cons (ast `y) nil) â¦†
pattern ref-label `x = op-ref-label â¦… cons (ast `x) nil â¦†
pattern lab-label `x = op-lab-label â¦… cons (ast `x) nil â¦†
pattern pc-label = op-pc-label â¦… nil â¦†
pattern label â„“ = (op-label â„“) â¦… nil â¦†
pattern _`âŠ”_ `x `y = op-label-join â¦… cons (ast `x) (cons (ast `y) nil) â¦†
pattern _`âŠ“_ `x `y = op-label-meet â¦… cons (ast `x) (cons (ast `y) nil) â¦†
pattern _`â‰¼_ `x `y = op-label-leq â¦… cons (ast `x) (cons (ast `y) nil) â¦†
pattern unlabel `x = op-unlabel â¦… cons (ast `x) nil â¦†
pattern to-label â„“ M = (op-to-label â„“) â¦… cons (ast M) nil â¦†
pattern to-label-dyn `x M = op-to-label-dyn â¦… cons (ast `x) (cons (ast M) nil) â¦†


infixl 9 _â‰¼_
infixl 9 _â‰¾_

-- Partial order of labels
data _â‰¼_ : â„’ â†’ â„’ â†’ Set where

  â‰¼-l : âˆ€ {n nâ€² : â„•}
      â†’ n â‰¤ nâ€²
      â†’ (l n) â‰¼ (l nâ€²)

-- Consistent subtyping for labels
data _â‰¾_ : â„’Ì‚ â†’ â„’Ì‚ â†’ Set where

  â‰¾-Â¿-r : âˆ€ {â„“Ì‚} â†’ â„“Ì‚ â‰¾ Â¿

  â‰¾-Â¿-l : âˆ€ {â„“Ì‚} â†’ Â¿ â‰¾ â„“Ì‚

  â‰¾-l : âˆ€ {â„“â‚ â„“â‚‚ : â„’} â†’ â„“â‚ â‰¼ â„“â‚‚ â†’ (lÌ‚ â„“â‚) â‰¾ (lÌ‚ â„“â‚‚)

_â‰¼?_ : (â„“â‚ â„“â‚‚ : â„’) â†’ Dec (â„“â‚ â‰¼ â„“â‚‚)
(l nâ‚) â‰¼? (l nâ‚‚) with nâ‚ â‰¤? nâ‚‚
... | yes nâ‚â‰¤nâ‚‚ = yes (â‰¼-l {nâ‚} {nâ‚‚} nâ‚â‰¤nâ‚‚)
... | no  nâ‚â‰°nâ‚‚ = no Î» {(â‰¼-l nâ‚â‰¤nâ‚‚) â†’ nâ‚â‰°nâ‚‚ nâ‚â‰¤nâ‚‚}

_â‰¾?_ : (â„“Ì‚â‚ â„“Ì‚â‚‚ : â„’Ì‚) â†’ Dec (â„“Ì‚â‚ â‰¾ â„“Ì‚â‚‚)
Â¿ â‰¾? _ = yes â‰¾-Â¿-l
_ â‰¾? Â¿ = yes â‰¾-Â¿-r
(lÌ‚ â„“â‚) â‰¾? (lÌ‚ â„“â‚‚) with â„“â‚ â‰¼? â„“â‚‚
... | yes â„“â‚â‰¼â„“â‚‚ = yes (â‰¾-l â„“â‚â‰¼â„“â‚‚)
... | no  Â¬â„“â‚â‰¼â„“â‚‚ = no Î» {(â‰¾-l â„“â‚â‰¼â„“â‚‚) â†’ Â¬â„“â‚â‰¼â„“â‚‚ â„“â‚â‰¼â„“â‚‚}

â‰¡-inv : âˆ€ {x y} â†’ l x â‰¡ l y â†’ x â‰¡ y
â‰¡-inv refl = refl

_â‰Ÿ_ : (â„“â‚ : â„’) â†’ (â„“â‚‚ : â„’) â†’ Dec (â„“â‚ â‰¡ â„“â‚‚)
(l nâ‚) â‰Ÿ (l nâ‚‚) with nâ‚ â‰Ÿâ‚™ nâ‚‚
... | yes nâ‚â‰¡nâ‚‚ = yes (cong (Î» â–¡ â†’ l â–¡) nâ‚â‰¡nâ‚‚)
... | no nâ‚â‰¢nâ‚‚ = no Î» â„“â‚â‰¡â„“â‚‚ â†’ nâ‚â‰¢nâ‚‚ (â‰¡-inv â„“â‚â‰¡â„“â‚‚)

-- Consistent subtyping for types
infixl 9 _â‰²_

data _â‰²_ : ğ•‹ â†’ ğ•‹ â†’ Set where

  â‰²-âŠ¤ :
    --------
    `âŠ¤ â‰² `âŠ¤

  â‰²-ğ”¹ :
    ---------
    `ğ”¹ â‰² `ğ”¹

  â‰²-â„’ :
    ---------
    `â„’ â‰² `â„’

  â‰²-Ref : âˆ€ {â„“Ì‚â‚ â„“Ì‚â‚‚ Tâ‚ Tâ‚‚}
    â†’ â„“Ì‚â‚ â‰¾ â„“Ì‚â‚‚
    â†’ â„“Ì‚â‚‚ â‰¾ â„“Ì‚â‚
    â†’ Tâ‚ â‰² Tâ‚‚
    â†’ Tâ‚‚ â‰² Tâ‚
      ----------------------
    â†’ Ref â„“Ì‚â‚ Tâ‚ â‰² Ref â„“Ì‚â‚‚ Tâ‚‚

  â‰²-Lab : âˆ€ {â„“Ì‚â‚ â„“Ì‚â‚‚ Tâ‚ Tâ‚‚}
    â†’ â„“Ì‚â‚ â‰¾ â„“Ì‚â‚‚
    â†’ Tâ‚ â‰² Tâ‚‚
      ----------------------
    â†’ Lab â„“Ì‚â‚ Tâ‚ â‰² Lab â„“Ì‚â‚‚ Tâ‚‚

  â‰²-â‡’ : âˆ€ {â„“Ì‚â‚ â„“Ì‚â‚‚ â„“Ì‚â‚â€² â„“Ì‚â‚‚â€² Tâ‚ Tâ‚‚ Tâ‚â€² Tâ‚‚â€²}
    â†’ â„“Ì‚â‚â€² â‰¾ â„“Ì‚â‚
    â†’ â„“Ì‚â‚‚  â‰¾ â„“Ì‚â‚‚â€²
    â†’ Tâ‚â€² â‰² Tâ‚
    â†’ Tâ‚‚  â‰² Tâ‚‚â€²
      --------------------------------------------------
    â†’ (Tâ‚ [ â„“Ì‚â‚ ]â‡’[ â„“Ì‚â‚‚ ] Tâ‚‚) â‰² (Tâ‚â€² [ â„“Ì‚â‚â€² ]â‡’[ â„“Ì‚â‚‚â€² ] Tâ‚‚â€²)

_â‰²?_ : (Tâ‚ Tâ‚‚ : ğ•‹) â†’ Dec (Tâ‚ â‰² Tâ‚‚)
`âŠ¤ â‰²? `âŠ¤ = yes â‰²-âŠ¤
`ğ”¹ â‰²? `ğ”¹ = yes â‰²-ğ”¹
`â„’ â‰²? `â„’ = yes â‰²-â„’
Ref â„“Ì‚â‚ Tâ‚ â‰²? Ref â„“Ì‚â‚‚ Tâ‚‚ with â„“Ì‚â‚ â‰¾? â„“Ì‚â‚‚
... | no Â¬â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ = no Î» { (â‰²-Ref â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ _ _ _) â†’ Â¬â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ }
... | yes â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ with â„“Ì‚â‚‚ â‰¾? â„“Ì‚â‚
...   | no Â¬â„“Ì‚â‚‚â‰¾â„“Ì‚â‚ = no Î» { (â‰²-Ref _ â„“Ì‚â‚‚â‰¾â„“Ì‚â‚ _ _) â†’ Â¬â„“Ì‚â‚‚â‰¾â„“Ì‚â‚ â„“Ì‚â‚‚â‰¾â„“Ì‚â‚ }
...   | yes â„“Ì‚â‚‚â‰¾â„“Ì‚â‚ with Tâ‚ â‰²? Tâ‚‚
...     | no Â¬Tâ‚â‰²Tâ‚‚ = no Î» { (â‰²-Ref _ _ Tâ‚â‰²Tâ‚‚ _) â†’ Â¬Tâ‚â‰²Tâ‚‚ Tâ‚â‰²Tâ‚‚ }
...     | yes Tâ‚â‰²Tâ‚‚ with Tâ‚‚ â‰²? Tâ‚
...       | no Â¬Tâ‚‚â‰²Tâ‚ = no Î» { (â‰²-Ref _ _ _ Tâ‚‚â‰²Tâ‚) â†’ Â¬Tâ‚‚â‰²Tâ‚ Tâ‚‚â‰²Tâ‚ }
...       | yes Tâ‚‚â‰²Tâ‚ = yes (â‰²-Ref â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ â„“Ì‚â‚‚â‰¾â„“Ì‚â‚ Tâ‚â‰²Tâ‚‚ Tâ‚‚â‰²Tâ‚)
Lab â„“Ì‚â‚ Tâ‚ â‰²? Lab â„“Ì‚â‚‚ Tâ‚‚ with â„“Ì‚â‚ â‰¾? â„“Ì‚â‚‚
... | no Â¬â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ = no Î» { (â‰²-Lab â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ _) â†’ Â¬â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ }
... | yes â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ with Tâ‚ â‰²? Tâ‚‚
...   | yes Tâ‚â‰²Tâ‚‚ = yes (â‰²-Lab â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ Tâ‚â‰²Tâ‚‚)
...   | no Â¬Tâ‚â‰²Tâ‚‚ = no Î» { (â‰²-Lab _ Tâ‚â‰²Tâ‚‚) â†’ Â¬Tâ‚â‰²Tâ‚‚ Tâ‚â‰²Tâ‚‚ }
(Tâ‚ [ â„“Ì‚â‚ ]â‡’[ â„“Ì‚â‚‚ ] Tâ‚‚) â‰²? (Tâ‚â€² [ â„“Ì‚â‚â€² ]â‡’[ â„“Ì‚â‚‚â€² ] Tâ‚‚â€²) with â„“Ì‚â‚â€² â‰¾? â„“Ì‚â‚
... | no Â¬â„“Ì‚â‚â€²â‰¾â„“Ì‚â‚ = no Î» { (â‰²-â‡’ â„“Ì‚â‚â€²â‰¾â„“Ì‚â‚ _ _ _) â†’ Â¬â„“Ì‚â‚â€²â‰¾â„“Ì‚â‚ â„“Ì‚â‚â€²â‰¾â„“Ì‚â‚ }
... | yes â„“Ì‚â‚â€²â‰¾â„“Ì‚â‚ with â„“Ì‚â‚‚ â‰¾? â„“Ì‚â‚‚â€²
...   | no Â¬â„“Ì‚â‚‚â‰¾â„“Ì‚â‚‚â€² = no Î» { (â‰²-â‡’ _ â„“Ì‚â‚‚â‰¾â„“Ì‚â‚‚â€² _ _) â†’ Â¬â„“Ì‚â‚‚â‰¾â„“Ì‚â‚‚â€² â„“Ì‚â‚‚â‰¾â„“Ì‚â‚‚â€² }
...   | yes â„“Ì‚â‚‚â‰¾â„“Ì‚â‚‚â€² with Tâ‚â€² â‰²? Tâ‚
...     | no Â¬Tâ‚â€²â‰²Tâ‚ = no Î» { (â‰²-â‡’ _ _ Tâ‚â€²â‰²Tâ‚ _) â†’ Â¬Tâ‚â€²â‰²Tâ‚ Tâ‚â€²â‰²Tâ‚ }
...     | yes Tâ‚â€²â‰²Tâ‚ with Tâ‚‚ â‰²? Tâ‚‚â€²
...       | no Â¬Tâ‚‚â‰²Tâ‚‚â€² = no Î» { (â‰²-â‡’ _ _ _ Tâ‚‚â‰²Tâ‚‚â€²) â†’ Â¬Tâ‚‚â‰²Tâ‚‚â€² Tâ‚‚â‰²Tâ‚‚â€² }
...       | yes Tâ‚‚â‰²Tâ‚‚â€² = yes (â‰²-â‡’ â„“Ì‚â‚â€²â‰¾â„“Ì‚â‚ â„“Ì‚â‚‚â‰¾â„“Ì‚â‚‚â€² Tâ‚â€²â‰²Tâ‚ Tâ‚‚â‰²Tâ‚‚â€²)
`âŠ¤ â‰²? `ğ”¹ = no Î» ()
`âŠ¤ â‰²? `â„’ = no Î» ()
`âŠ¤ â‰²? Ref _ _ = no Î» ()
`âŠ¤ â‰²? Lab _ _ = no Î» ()
`âŠ¤ â‰²? (_ [ _ ]â‡’[ _ ] _) = no Î» ()
`ğ”¹ â‰²? `âŠ¤ = no Î» ()
`ğ”¹ â‰²? `â„’ = no Î» ()
`ğ”¹ â‰²? Ref _ _ = no Î» ()
`ğ”¹ â‰²? Lab _ _ = no Î» ()
`ğ”¹ â‰²? (_ [ _ ]â‡’[ _ ] _) = no Î» ()
`â„’ â‰²? `âŠ¤ = no Î» ()
`â„’ â‰²? `ğ”¹ = no Î» ()
`â„’ â‰²? Ref _ _ = no Î» ()
`â„’ â‰²? Lab _ _ = no Î» ()
`â„’ â‰²? (_ [ _ ]â‡’[ _ ] _) = no Î» ()
Ref _ _ â‰²? `âŠ¤ = no Î» ()
Ref _ _ â‰²? `ğ”¹ = no Î» ()
Ref _ _ â‰²? `â„’ = no Î» ()
Ref _ _ â‰²? Lab _ _ = no Î» ()
Ref _ _ â‰²? (_ [ _ ]â‡’[ _ ] _) = no Î» ()
Lab _ _ â‰²? `âŠ¤ = no Î» ()
Lab _ _ â‰²? `ğ”¹ = no Î» ()
Lab _ _ â‰²? `â„’ = no Î» ()
Lab _ _ â‰²? Ref _ _ = no Î» ()
Lab _ _ â‰²? (_ [ _ ]â‡’[ _ ] _) = no Î» ()
(_ [ _ ]â‡’[ _ ] _) â‰²? `âŠ¤ = no Î» ()
(_ [ _ ]â‡’[ _ ] _) â‰²? `ğ”¹ = no Î» ()
(_ [ _ ]â‡’[ _ ] _) â‰²? `â„’ = no Î» ()
(_ [ _ ]â‡’[ _ ] _) â‰²? Lab _ _ = no Î» ()
(_ [ _ ]â‡’[ _ ] _) â‰²? Ref _ _ = no Î» ()


-- Label join
_âŠ”_ : â„’ â†’ â„’ â†’ â„’
(l nâ‚) âŠ” (l nâ‚‚) = l (nâ‚ âŠ”â‚™ nâ‚‚)

-- Label meet
_âŠ“_ : â„’ â†’ â„’ â†’ â„’
(l nâ‚) âŠ“ (l nâ‚‚) = l (nâ‚ âŠ“â‚™ nâ‚‚)

-- Label gradual join
_â‹_ : â„’Ì‚ â†’ â„’Ì‚ â†’ â„’Ì‚
Â¿      â‹ Â¿      = Â¿
(lÌ‚ _)  â‹ Â¿      = Â¿
Â¿      â‹ (lÌ‚ _)  = Â¿
(lÌ‚ â„“â‚) â‹ (lÌ‚ â„“â‚‚) = lÌ‚ (â„“â‚ âŠ” â„“â‚‚)

-- Label gradual meet
_â‹_ : â„’Ì‚ â†’ â„’Ì‚ â†’ â„’Ì‚
Â¿      â‹ Â¿      = Â¿
(lÌ‚ _)  â‹ Â¿      = Â¿
Â¿      â‹ (lÌ‚ _)  = Â¿
(lÌ‚ â„“â‚) â‹ (lÌ‚ â„“â‚‚) = lÌ‚ (â„“â‚ âŠ“ â„“â‚‚)

-- Label (gradual) intersection
_âˆ_ : â„’Ì‚ â†’ â„’Ì‚ â†’ Maybe â„’Ì‚
Â¿ âˆ Â¿ = just Â¿
Â¿ âˆ (lÌ‚ â„“) = just (lÌ‚ â„“)
(lÌ‚ â„“) âˆ Â¿ = just (lÌ‚ â„“)
(lÌ‚ â„“â‚) âˆ (lÌ‚ â„“â‚‚) with â„“â‚ â‰Ÿ â„“â‚‚
... | yes _ = just (lÌ‚ â„“â‚)
... | no _ = nothing

-- Type (gradual) intersection
_âˆ©_ : ğ•‹ â†’ ğ•‹ â†’ Maybe ğ•‹
`âŠ¤ âˆ© `âŠ¤ = just `âŠ¤
`ğ”¹ âˆ© `ğ”¹ = just `ğ”¹
`â„’ âˆ© `â„’ = just `â„’
(Ref â„“Ì‚â‚ Tâ‚) âˆ© (Ref â„“Ì‚â‚‚ Tâ‚‚) = do
  â„“Ì‚ â† â„“Ì‚â‚ âˆ â„“Ì‚â‚‚
  T â† Tâ‚ âˆ© Tâ‚‚
  just (Ref â„“Ì‚ T)
(Lab â„“Ì‚â‚ Tâ‚) âˆ© (Lab â„“Ì‚â‚‚ Tâ‚‚) = do
  â„“Ì‚ â† â„“Ì‚â‚ âˆ â„“Ì‚â‚‚
  T â† Tâ‚ âˆ© Tâ‚‚
  just (Lab â„“Ì‚ T)
(Tâ‚ [ â„“Ì‚â‚ ]â‡’[ â„“Ì‚â‚‚ ] Tâ‚‚) âˆ© (Tâ‚â€² [ â„“Ì‚â‚â€² ]â‡’[ â„“Ì‚â‚‚â€² ] Tâ‚‚â€²) = do
  â„“Ì‚â‚â€³ â† â„“Ì‚â‚ âˆ â„“Ì‚â‚â€²
  â„“Ì‚â‚‚â€³ â† â„“Ì‚â‚‚ âˆ â„“Ì‚â‚‚â€²
  Tâ‚â€³ â† Tâ‚ âˆ© Tâ‚â€²
  Tâ‚‚â€³ â† Tâ‚‚ âˆ© Tâ‚‚â€²
  just (Tâ‚â€³ [ â„“Ì‚â‚â€³ ]â‡’[ â„“Ì‚â‚‚â€³ ] Tâ‚‚â€³)
_ âˆ© _ = nothing


mutual
  -- Type (gradual) join
  _âˆ¨_ : ğ•‹ â†’ ğ•‹ â†’ Maybe ğ•‹
  `âŠ¤ âˆ¨ `âŠ¤ = just `âŠ¤
  `ğ”¹ âˆ¨ `ğ”¹ = just `ğ”¹
  `â„’ âˆ¨ `â„’ = just `â„’
  (Ref â„“Ì‚â‚ Tâ‚) âˆ¨ (Ref â„“Ì‚â‚‚ Tâ‚‚) = do
    â„“Ì‚ â† â„“Ì‚â‚ âˆ â„“Ì‚â‚‚
    T â† Tâ‚ âˆ© Tâ‚‚
    just (Ref â„“Ì‚ T)
  (Lab â„“Ì‚â‚ Tâ‚) âˆ¨ (Lab â„“Ì‚â‚‚ Tâ‚‚) = do
    T â† Tâ‚ âˆ¨ Tâ‚‚
    just (Lab (â„“Ì‚â‚ â‹ â„“Ì‚â‚‚) T)
  (Tâ‚ [ â„“Ì‚â‚ ]â‡’[ â„“Ì‚â‚‚ ] Tâ‚‚) âˆ¨ (Tâ‚â€² [ â„“Ì‚â‚â€² ]â‡’[ â„“Ì‚â‚‚â€² ] Tâ‚‚â€²) = do
    Tâ‚â€³ â† Tâ‚ âˆ§ Tâ‚â€²
    Tâ‚‚â€³ â† Tâ‚‚ âˆ¨ Tâ‚‚â€²
    just (Tâ‚â€³ [ â„“Ì‚â‚ â‹ â„“Ì‚â‚â€² ]â‡’[ â„“Ì‚â‚‚ â‹ â„“Ì‚â‚‚â€² ] Tâ‚‚â€³)
  _ âˆ¨ _ = nothing

  -- Type (gradual) meet
  _âˆ§_ : ğ•‹ â†’ ğ•‹ â†’ Maybe ğ•‹
  `âŠ¤ âˆ§ `âŠ¤ = just `âŠ¤
  `ğ”¹ âˆ§ `ğ”¹ = just `ğ”¹
  `â„’ âˆ§ `â„’ = just `â„’
  (Ref â„“Ì‚â‚ Tâ‚) âˆ§ (Ref â„“Ì‚â‚‚ Tâ‚‚) = do
    â„“Ì‚ â† â„“Ì‚â‚ âˆ â„“Ì‚â‚‚
    T â† Tâ‚ âˆ© Tâ‚‚
    just (Ref â„“Ì‚ T)
  (Lab â„“Ì‚â‚ Tâ‚) âˆ§ (Lab â„“Ì‚â‚‚ Tâ‚‚) = do
    T â† Tâ‚ âˆ§ Tâ‚‚
    just (Lab (â„“Ì‚â‚ â‹ â„“Ì‚â‚‚) T)
  (Tâ‚ [ â„“Ì‚â‚ ]â‡’[ â„“Ì‚â‚‚ ] Tâ‚‚) âˆ§ (Tâ‚â€² [ â„“Ì‚â‚â€² ]â‡’[ â„“Ì‚â‚‚â€² ] Tâ‚‚â€²) = do
    Tâ‚â€³ â† Tâ‚ âˆ¨ Tâ‚â€²
    Tâ‚‚â€³ â† Tâ‚‚ âˆ§ Tâ‚‚â€²
    just (Tâ‚â€³ [ â„“Ì‚â‚ â‹ â„“Ì‚â‚â€² ]â‡’[ â„“Ì‚â‚‚ â‹ â„“Ì‚â‚‚â€² ] Tâ‚‚â€³)
  _ âˆ§ _ = nothing


-- -- Typing judgements
infix 4 _[_,_]âŠ¢_â¦‚_

data _[_,_]âŠ¢_â¦‚_ : Context â†’ â„’Ì‚ â†’ â„’Ì‚ â†’ Term â†’ ğ•‹ â†’ Set where

  âŠ¢` : âˆ€ {Î“ x T â„“Ì‚}
    â†’ nth Î“ x â‰¡ just T
      -------------------- Var
    â†’ Î“ [ â„“Ì‚ , â„“Ì‚ ]âŠ¢ ` x â¦‚ T

  âŠ¢tt : âˆ€ {Î“ â„“Ì‚}
      ---------------------- Unit
    â†’ Î“ [ â„“Ì‚ , â„“Ì‚ ]âŠ¢ `tt â¦‚ `âŠ¤

  âŠ¢true : âˆ€ {Î“ â„“Ì‚}
      ----------------------- True
    â†’ Î“ [ â„“Ì‚ , â„“Ì‚ ]âŠ¢ `true â¦‚ `ğ”¹

  âŠ¢false : âˆ€ {Î“ â„“Ì‚}
      ------------------------ False
    â†’ Î“ [ â„“Ì‚ , â„“Ì‚ ]âŠ¢ `false â¦‚ `ğ”¹

  âŠ¢let : âˆ€ {Î“ T Tâ€² S M N â„“Ì‚â‚ â„“Ì‚â‚‚ â„“Ì‚â‚ƒ}
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚‚ ]âŠ¢ M â¦‚ Tâ€²
    â†’ T âˆ· Î“ [ â„“Ì‚â‚‚ , â„“Ì‚â‚ƒ ]âŠ¢ N â¦‚ S
    â†’ Tâ€² â‰² T
      --------------------------- Let
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚ƒ ]âŠ¢ `let M N â¦‚ S

  âŠ¢if : âˆ€ {Î“ x T Tâ€² Tâ€³ M N â„“Ì‚â‚ â„“Ì‚â‚‚ â„“Ì‚â‚‚â€²}
    â†’ nth Î“ x â‰¡ just `ğ”¹
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚‚ ]âŠ¢ M â¦‚ T
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚‚â€² ]âŠ¢ N â¦‚ Tâ€²
    â†’ T âˆ¨ Tâ€² â‰¡ just Tâ€³
      --------------------------------------- If
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚‚ â‹ â„“Ì‚â‚‚â€² ]âŠ¢ if (` x) M N â¦‚ Tâ€³

  âŠ¢get : âˆ€ {Î“ x T â„“Ì‚â‚ â„“Ì‚}
    â†’ nth Î“ x â‰¡ just (Ref â„“Ì‚ T)
      --------------------------------- Get
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚ â‹ â„“Ì‚ ]âŠ¢ get (` x) â¦‚ T

  âŠ¢set : âˆ€ {Î“ x y T Tâ€² â„“Ì‚â‚ â„“Ì‚}
    â†’ nth Î“ x â‰¡ just (Ref â„“Ì‚ T)
    â†’ nth Î“ y â‰¡ just Tâ€²
    â†’ Tâ€² â‰² T  -- the heap location need to be more secure
    â†’ â„“Ì‚â‚ â‰¾ â„“Ì‚  -- cannot observe the control flow since the heap location is more sensitive
      ----------------------------------- Set
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚ ]âŠ¢ set (` x) (` y) â¦‚ `âŠ¤

  âŠ¢new : âˆ€ {Î“ y T â„“Ì‚â‚ â„“}
    â†’ nth Î“ y â‰¡ just T
    â†’ â„“Ì‚â‚ â‰¾ (lÌ‚ â„“)
      ---------------------------------------- New
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚ ]âŠ¢ new â„“ (` y) â¦‚ Ref (lÌ‚ â„“) T

  âŠ¢new-dyn : âˆ€ {Î“ x y T â„“Ì‚â‚}
    â†’ nth Î“ x â‰¡ just `â„’
    â†’ nth Î“ y â‰¡ just T
      -------------------------------------------- NewDyn
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚ ]âŠ¢ new-dyn (` x) (` y) â¦‚ Ref Â¿ T

  âŠ¢eq-ref : âˆ€ {Î“ x y Tâ‚ Tâ‚‚ â„“Ì‚â‚ â„“Ì‚â‚‚ â„“Ì‚}
    â†’ nth Î“ x â‰¡ just (Ref â„“Ì‚â‚ Tâ‚)
    â†’ nth Î“ y â‰¡ just (Ref â„“Ì‚â‚‚ Tâ‚‚)
    â†’ Tâ‚ â‰² Tâ‚‚
    â†’ Tâ‚‚ â‰² Tâ‚
      ------------------------------------- EqRef
    â†’ Î“ [ â„“Ì‚ , â„“Ì‚ ]âŠ¢ eq-ref (` x) (` y) â¦‚ `ğ”¹

  âŠ¢Æ› : âˆ€ {Î“ T S N â„“Ì‚â‚ â„“Ì‚â‚‚ â„“Ì‚}
    â†’ T âˆ· Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚‚ ]âŠ¢ N â¦‚ S
      ------------------------------------ Fun
    â†’ Î“ [ â„“Ì‚ , â„“Ì‚ ]âŠ¢ Æ› N â¦‚ T [ â„“Ì‚â‚ ]â‡’[ â„“Ì‚â‚‚ ] S

  âŠ¢Â· : âˆ€ {Î“ x y T Tâ€² S â„“Ì‚â‚ â„“Ì‚â‚â€² â„“Ì‚â‚‚}
    â†’ nth Î“ x â‰¡ just (T [ â„“Ì‚â‚ ]â‡’[ â„“Ì‚â‚‚ ] S)
    â†’ nth Î“ y â‰¡ just Tâ€²
    â†’ Tâ€² â‰² T
    â†’ â„“Ì‚â‚â€² â‰¾ â„“Ì‚â‚
      --------------------------------- App
    â†’ Î“ [ â„“Ì‚â‚â€² , â„“Ì‚â‚‚ ]âŠ¢ (` x) Â· (` y) â¦‚ S

  âŠ¢ref-label : âˆ€ {Î“ x T â„“Ì‚ â„“Ì‚â‚}
    â†’ nth Î“ x â‰¡ just (Ref â„“Ì‚ T)
      ------------------------------------ RefLabel
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚ ]âŠ¢ ref-label (` x) â¦‚ `â„’

  âŠ¢lab-label : âˆ€ {Î“ x T â„“Ì‚ â„“Ì‚â‚}
    â†’ nth Î“ x â‰¡ just (Lab â„“Ì‚ T)
      ------------------------------------ LabLabel
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚ ]âŠ¢ lab-label (` x) â¦‚ `â„’

  âŠ¢pc-label : âˆ€ {Î“ â„“Ì‚}
      --------------------------- PC
    â†’ Î“ [ â„“Ì‚ , â„“Ì‚ ]âŠ¢ pc-label â¦‚ `â„’

  âŠ¢label : âˆ€ {Î“ â„“Ì‚ â„“}
      -------------------------- Label
    â†’ Î“ [ â„“Ì‚ , â„“Ì‚ ]âŠ¢ label â„“ â¦‚ `â„’

  âŠ¢â‰¼ : âˆ€ {Î“ x y â„“Ì‚}
    â†’ nth Î“ x â‰¡ just `â„’
    â†’ nth Î“ y â‰¡ just `â„’
      --------------------------------- `â‰¼
    â†’ Î“ [ â„“Ì‚ , â„“Ì‚ ]âŠ¢ (` x) `â‰¼ (` y) â¦‚ `ğ”¹

  âŠ¢âŠ” : âˆ€ {Î“ x y â„“Ì‚}
    â†’ nth Î“ x â‰¡ just `â„’
    â†’ nth Î“ y â‰¡ just `â„’
      --------------------------------- `âŠ”
    â†’ Î“ [ â„“Ì‚ , â„“Ì‚ ]âŠ¢ (` x) `âŠ” (` y) â¦‚ `â„’

  âŠ¢âŠ“ : âˆ€ {Î“ x y â„“Ì‚}
    â†’ nth Î“ x â‰¡ just `â„’
    â†’ nth Î“ y â‰¡ just `â„’
      --------------------------------- `âŠ“
    â†’ Î“ [ â„“Ì‚ , â„“Ì‚ ]âŠ¢ (` x) `âŠ“ (` y) â¦‚ `â„’

  âŠ¢unlabel : âˆ€ {Î“ x T â„“Ì‚ â„“Ì‚â‚}
    â†’ nth Î“ x â‰¡ just (Lab â„“Ì‚ T)
      -------------------------------------- Unlabel
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚ â‹ â„“Ì‚ ]âŠ¢ unlabel (` x) â¦‚ T

  âŠ¢to-label : âˆ€ {Î“ T M â„“Ì‚â‚ â„“Ì‚â‚‚ â„“}
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚‚ ]âŠ¢ M â¦‚ T
    â†’ â„“Ì‚â‚‚ â‰¾ ((lÌ‚ â„“) â‹ â„“Ì‚â‚)
      -------------------------------------- ToLab
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚ ]âŠ¢ to-label â„“ M â¦‚ Lab (lÌ‚ â„“) T

  âŠ¢to-label-dyn : âˆ€ {Î“ x T M â„“Ì‚â‚ â„“Ì‚â‚‚}
    â†’ nth Î“ x â‰¡ just `â„’
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚‚ ]âŠ¢ M â¦‚ T
      --------------------------------------------- ToLabDyn
    â†’ Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚ ]âŠ¢ to-label-dyn (` x) M â¦‚ Lab Â¿ T
