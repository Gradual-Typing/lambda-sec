open import Data.Nat using (â„•; zero; suc; _â‰¤_; zâ‰¤n; sâ‰¤s) renaming (_âŠ”_ to _âŠ”â‚™_; _âŠ“_ to _âŠ“â‚™_; _â‰Ÿ_ to _â‰Ÿâ‚™_)
open import Data.Nat.Properties using (mâ‰¤mâŠ”n)
open import Data.Empty using (âŠ¥; âŠ¥-elim)
open import Data.Product using (_Ã—_; âˆƒ; âˆƒ-syntax; Î£; Î£-syntax; projâ‚; projâ‚‚) renaming (_,_ to âŸ¨_,_âŸ©)
open import Data.Maybe using (Maybe; just; nothing)
open import Data.List using (List; []; _âˆ·_; length)
import Relation.Binary.PropositionalEquality as Eq
open Eq using (_â‰¡_; _â‰¢_; refl; sym; trans; subst; inspect; [_])
open import Relation.Nullary using (Dec; yes; no; Â¬_)

open import StaticsGLIO
open import Lemmas
open import Interp
open import WellTypedness using (_âŠ¢áµ¥_â¦‚_)
open import Store
open import WellTypedness
open import CastStateIdem
open import InterpSafe
open import Subtyping



-- CastL â„“Ì‚â‚ â‡› â„“Ì‚â‚‚ never fails if â„“Ì‚â‚ â‰º: â„“Ì‚â‚‚
â‰º:â†’no-blame : âˆ€ {Î¼ pc â„“Ì‚â‚ â„“Ì‚â‚‚}
  â†’ (lÌ‚ pc) â‰¾ â„“Ì‚â‚
  â†’ (â„“Ì‚â‚â‰º:â„“Ì‚â‚‚ : â„“Ì‚â‚ â‰º: â„“Ì‚â‚‚)
    --------------------------------------------------
  â†’ castL Î¼ pc â„“Ì‚â‚ â„“Ì‚â‚‚ (â‰º:â†’â‰¾ â„“Ì‚â‚â‰º:â„“Ì‚â‚‚) â‰¡ result âŸ¨ Î¼ , V-tt , pc âŸ©
â‰º:â†’no-blame {pc = pc} {â„“Ì‚â‚} {â„“Ì‚â‚‚} pcâ‰¾â„“â‚ â„“â‚â‰º:â„“â‚‚
  with (lÌ‚ pc) â‰¾? â„“Ì‚â‚‚
... | yes pcâ‰¾â„“â‚‚ = refl
... | no pcâŠ€â„“â‚‚ = âŠ¥-elim (pcâŠ€â„“â‚‚ pcâ‰¾â„“â‚‚)
  where
  pcâ‰¾â„“â‚‚ = â„“â‚â‰¾â„“â‚‚â†’â„“â‚‚â‰º:â„“â‚ƒâ†’â„“â‚â‰¾â„“â‚ƒ pcâ‰¾â„“â‚ â„“â‚â‰º:â„“â‚‚


-- Cast Tâ‚ â‡› Tâ‚‚ never fails if Tâ‚ <: Tâ‚‚
<:â†’no-blame : âˆ€ {Î¼ pc Tâ‚ Tâ‚‚ v}
  â†’ Î¼ âŠ¢áµ¥ v â¦‚ Tâ‚
  â†’ (Tâ‚<:Tâ‚‚ : Tâ‚ <: Tâ‚‚)
    ------------------------------------------------------------------
  â†’ âˆƒ[ w ] (castTâ€² Î¼ pc Tâ‚ Tâ‚‚ (<:â†’â‰² Tâ‚<:Tâ‚‚) v â‰¡ result âŸ¨ Î¼ , w , pc âŸ©)
<:â†’no-blame âŠ¢áµ¥tt <:-âŠ¤ = âŸ¨ V-tt , refl âŸ©
<:â†’no-blame âŠ¢áµ¥true <:-ğ”¹ = âŸ¨ V-true , refl âŸ©
<:â†’no-blame âŠ¢áµ¥false <:-ğ”¹ = âŸ¨ V-false , refl âŸ©
<:â†’no-blame âŠ¢áµ¥label <:-â„’ = âŸ¨ V-label _ , refl âŸ©
<:â†’no-blame (âŠ¢áµ¥ref _) (<:-Ref â‰‚-Â¿ Tâ‚â‰²Tâ‚‚ Tâ‚‚â‰²Tâ‚) = âŸ¨ V-ref _ , refl âŸ©
<:â†’no-blame (âŠ¢áµ¥ref _) (<:-Ref {â„“Ì‚â‚‚ = lÌ‚ â„“â‚‚} â‰‚-l Tâ‚â‰²Tâ‚‚ Tâ‚‚â‰²Tâ‚)
  with â„“â‚‚ â‰Ÿ â„“â‚‚
... | yes _ = âŸ¨ V-ref _ , refl âŸ©
... | no â„“â‚‚â‰¢â„“â‚‚ = âŠ¥-elim (â„“â‚‚â‰¢â„“â‚‚ refl)
<:â†’no-blame (âŠ¢áµ¥ref-dyn _) (<:-Ref â‰‚-Â¿ Tâ‚â‰²Tâ‚‚ Tâ‚‚â‰²Tâ‚) = âŸ¨ V-ref _ , refl âŸ©
<:â†’no-blame {pc = pc} (âŠ¢áµ¥lab {â„“ = â„“} â„“â‰¼â„“â€² âŠ¢v) (<:-Lab â‰º:-Â¿ Tâ‚<:Tâ‚‚)
  with <:â†’no-blame {pc = pc} âŠ¢v Tâ‚<:Tâ‚‚
... | âŸ¨ w , eq âŸ© rewrite eq = âŸ¨ V-lab â„“ w , refl âŸ©
<:â†’no-blame {pc = pc} (âŠ¢áµ¥lab {â„“ = â„“} â„“â‰¼â„“â€² âŠ¢v) (<:-Lab (â‰º:-l {â„“â‚‚ = â„“â‚‚} ğ“µâ€²â‰¼â„“â‚‚) Tâ‚<:Tâ‚‚)
  with â„“ â‰¼? â„“â‚‚
... | no â„“âŠ€â„“â‚‚ = âŠ¥-elim (â„“âŠ€â„“â‚‚ â„“â‰¼â„“â‚‚)
  where
  â„“â‰¼â„“â‚‚ = â‰¼-trans â„“â‰¼â„“â€² ğ“µâ€²â‰¼â„“â‚‚
... | yes _ with <:â†’no-blame {pc = pc} âŠ¢v Tâ‚<:Tâ‚‚
...   | âŸ¨ w , eq âŸ© rewrite eq = âŸ¨ V-lab â„“ w , refl âŸ©
<:â†’no-blame {pc = pc} (âŠ¢áµ¥lab-dyn âŠ¢v) (<:-Lab â‰º:-Â¿ Tâ‚<:Tâ‚‚) with <:â†’no-blame {pc = pc} âŠ¢v Tâ‚<:Tâ‚‚
... | âŸ¨ w , eq âŸ© rewrite eq = âŸ¨ V-lab _ w , refl âŸ©
<:â†’no-blame (âŠ¢áµ¥clos _ _) (<:-â‡’ _ _ _ _) = âŸ¨ V-proxy _ _ _ _ _ _ _ _ _ _ _ _ _ , refl âŸ©
<:â†’no-blame (âŠ¢áµ¥proxy _) (<:-â‡’ _ _ _ _) = âŸ¨ V-proxy _ _ _ _ _ _ _ _ _ _ _ _ _ , refl âŸ©



private
  timeoutâ‰¢result : âˆ€ {conf : Conf} â†’ timeout â‰¢ result conf
  timeoutâ‰¢result ()

  errorâ‰¢result : âˆ€ {err} {conf : Conf} â†’ error err â‰¢ result conf
  errorâ‰¢result ()

  resultâ‰¡â†’â„“á¶œâ‰¡ : âˆ€ {Î¼â‚ Î¼â‚‚ : Store} {vâ‚ vâ‚‚ : Value} {â„“á¶œâ‚ â„“á¶œâ‚‚ : â„’}
    â†’ result âŸ¨ Î¼â‚ , vâ‚ , â„“á¶œâ‚ âŸ© â‰¡ result âŸ¨ Î¼â‚‚ , vâ‚‚ , â„“á¶œâ‚‚ âŸ©
    â†’ â„“á¶œâ‚ â‰¡ â„“á¶œâ‚‚
  resultâ‰¡â†’â„“á¶œâ‰¡ resâ‰¡ =
    let confâ‚â‰¡confâ‚‚ = result-â‰¡-inv resâ‰¡ in
    let cdrâ‚â‰¡cdrâ‚‚ = projâ‚‚ (Ã—-â‰¡-inv confâ‚â‰¡confâ‚‚) in
      projâ‚‚ (Ã—-â‰¡-inv cdrâ‚â‰¡cdrâ‚‚)

  castLâ†’â„“á¶œâ‰¡ : âˆ€ {Î¼â‚ Î¼â‚‚ â„“á¶œâ‚ â„“á¶œâ‚‚ â„“Ì‚â‚ â„“Ì‚â‚‚ v}
    â†’ (â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ : â„“Ì‚â‚ â‰¾ â„“Ì‚â‚‚)
    â†’ castL Î¼â‚ â„“á¶œâ‚ â„“Ì‚â‚ â„“Ì‚â‚‚ â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ â‰¡ result âŸ¨ Î¼â‚‚ , v , â„“á¶œâ‚‚ âŸ©
    â†’ â„“á¶œâ‚ â‰¡ â„“á¶œâ‚‚
  castLâ†’â„“á¶œâ‰¡ {â„“á¶œâ‚ = â„“á¶œâ‚} {â„“Ì‚â‚ = â„“Ì‚â‚} {â„“Ì‚â‚‚} â„“â‚â‰¾â„“â‚‚ eq with (lÌ‚ â„“á¶œâ‚) â‰¾? â„“Ì‚â‚‚
  ... | yes _ = resultâ‰¡â†’â„“á¶œâ‰¡ eq
  ... | no  _ = âŠ¥-elim (errorâ‰¢result eq)

  castTâ€²â†’â„“á¶œâ‰¡ : âˆ€ {Î¼â‚ Î¼â‚‚ â„“á¶œâ‚ â„“á¶œâ‚‚ vâ‚‚ Tâ‚ Tâ‚‚}
    â†’ (Tâ‚â‰²Tâ‚‚ : Tâ‚ â‰² Tâ‚‚)
    â†’ (vâ‚ : Value)
    â†’ castTâ€² Î¼â‚ â„“á¶œâ‚ Tâ‚ Tâ‚‚ Tâ‚â‰²Tâ‚‚ vâ‚ â‰¡ result âŸ¨ Î¼â‚‚ , vâ‚‚ , â„“á¶œâ‚‚ âŸ©
    â†’ â„“á¶œâ‚ â‰¡ â„“á¶œâ‚‚
  castTâ€²â†’â„“á¶œâ‰¡ â‰²-âŠ¤ V-tt eq = resultâ‰¡â†’â„“á¶œâ‰¡ eq
  castTâ€²â†’â„“á¶œâ‰¡ â‰²-ğ”¹ V-true eq = resultâ‰¡â†’â„“á¶œâ‰¡ eq
  castTâ€²â†’â„“á¶œâ‰¡ â‰²-ğ”¹ V-false eq = resultâ‰¡â†’â„“á¶œâ‰¡ eq
  castTâ€²â†’â„“á¶œâ‰¡ â‰²-â„’ (V-label _) eq = resultâ‰¡â†’â„“á¶œâ‰¡ eq
  castTâ€²â†’â„“á¶œâ‰¡ (â‰²-Ref {â„“Ì‚â‚‚ = â„“Ì‚â‚‚} _ _ _ _) (V-ref âŸ¨ _ , _ , â„“â‚‚ âŸ©) eq with â„“Ì‚â‚‚
  ... | Â¿ = resultâ‰¡â†’â„“á¶œâ‰¡ eq
  ... | (lÌ‚ â„“â‚‚â€²) with â„“â‚‚ â‰Ÿ â„“â‚‚â€²
  ...   | yes _ = resultâ‰¡â†’â„“á¶œâ‰¡ eq
  ...   | no  _ = âŠ¥-elim (errorâ‰¢result eq)
  castTâ€²â†’â„“á¶œâ‰¡ {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (â‰²-Lab {â„“Ì‚â‚‚ = â„“Ì‚â‚‚} _ Tâ‚â‰²Tâ‚‚) (V-lab â„“ v) eq with (lÌ‚ â„“) â‰¾? â„“Ì‚â‚‚
  ... | no _ = âŠ¥-elim (errorâ‰¢result eq)
  ... | yes _ with castTâ€² Î¼â‚ â„“á¶œâ‚ _ _ Tâ‚â‰²Tâ‚‚ v | inspect (Î» v â†’ castTâ€² Î¼â‚ â„“á¶œâ‚ _ _ Tâ‚â‰²Tâ‚‚ v) v
  ...   | result âŸ¨ Î¼â€² , vâ€² , â„“á¶œâ€² âŸ© | [ eqâ‚ ] =
    let â„“á¶œâ‚â‰¡â„“á¶œâ€² = castTâ€²â†’â„“á¶œâ‰¡ Tâ‚â‰²Tâ‚‚ v eqâ‚ in
    let â„“á¶œâ€²â‰¡â„“á¶œâ‚‚ = resultâ‰¡â†’â„“á¶œâ‰¡ eq in
      trans â„“á¶œâ‚â‰¡â„“á¶œâ€² â„“á¶œâ€²â‰¡â„“á¶œâ‚‚
  ...   | error err | _ = âŠ¥-elim (errorâ‰¢result eq)
  ...   | timeout | _ = âŠ¥-elim (timeoutâ‰¢result eq)
  castTâ€²â†’â„“á¶œâ‰¡ (â‰²-â‡’ _ _ _ _) (V-clos _) eq = resultâ‰¡â†’â„“á¶œâ‰¡ eq
  castTâ€²â†’â„“á¶œâ‰¡ (â‰²-â‡’ _ _ _ _) (V-proxy _ _ _ _ _ _ _ _  _ _ _ _ _) eq = resultâ‰¡â†’â„“á¶œâ‰¡ eq

  castTâ†’â„“á¶œâ‰¡ : âˆ€ {Î¼â‚ Î¼â‚‚ â„“á¶œâ‚ â„“á¶œâ‚‚ vâ‚‚ Tâ‚ Tâ‚‚}
    â†’ (vâ‚ : Value)
    â†’ castT Î¼â‚ â„“á¶œâ‚ Tâ‚ Tâ‚‚ vâ‚ â‰¡ result âŸ¨ Î¼â‚‚ , vâ‚‚ , â„“á¶œâ‚‚ âŸ©
    â†’ â„“á¶œâ‚ â‰¡ â„“á¶œâ‚‚
  castTâ†’â„“á¶œâ‰¡ {Tâ‚ = Tâ‚} {Tâ‚‚} vâ‚ eq with Tâ‚ â‰²? Tâ‚‚
  ... | yes Tâ‚â‰²Tâ‚‚ = castTâ€²â†’â„“á¶œâ‰¡ Tâ‚â‰²Tâ‚‚ vâ‚ eq
  ... | no _ = âŠ¥-elim (errorâ‰¢result eq)

  castL-no-blame-inv : âˆ€ {Î¼ Î¼â€² â„“Ì‚â‚ â„“Ì‚â‚‚ â„“á¶œ â„“á¶œâ€² v}
    â†’ (â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ : â„“Ì‚â‚ â‰¾ â„“Ì‚â‚‚)
    â†’ castL Î¼ â„“á¶œ â„“Ì‚â‚ â„“Ì‚â‚‚ â„“Ì‚â‚â‰¾â„“Ì‚â‚‚ â‰¡ result âŸ¨ Î¼â€² , v , â„“á¶œâ€² âŸ©
    â†’ (lÌ‚ â„“á¶œ) â‰¾ â„“Ì‚â‚‚
  castL-no-blame-inv {â„“Ì‚â‚‚ = â„“Ì‚â‚‚} {â„“á¶œ = â„“á¶œ} _ eq with (lÌ‚ â„“á¶œ) â‰¾? â„“Ì‚â‚‚
  ... | yes â„“á¶œâ‰¾â„“â‚‚ = â„“á¶œâ‰¾â„“â‚‚


apply-pcâ‰¾ : âˆ€ {Î“ Î³ Î¼ Î¼â€² T S â„“Ì‚â‚ â„“Ì‚â‚‚ â„“á¶œ â„“á¶œâ€² v w vâ€² k}
  â†’ (lÌ‚ â„“á¶œ) â‰¾ â„“Ì‚â‚
  â†’ Î¼ âŠ¢â‚› Î¼
  â†’ Î“ âˆ£ Î¼ âŠ¢â‚‘ Î³
  â†’ length Î¼ âˆ‰domâ‚™ Î¼
  â†’ Î¼ âŠ¢áµ¥ v â¦‚ T [ â„“Ì‚â‚ ]â‡’[ â„“Ì‚â‚‚ ] S
  â†’ Î¼ âŠ¢áµ¥ w â¦‚ T
  â†’ apply Î³ v w Î¼ â„“á¶œ k â‰¡ result âŸ¨ Î¼â€² , vâ€² , â„“á¶œâ€² âŸ©
  â†’ (lÌ‚ â„“á¶œâ€²) â‰¾ â„“Ì‚â‚‚

ğ’±-pres-pcâ‰² : âˆ€ {Î“ Î³ Î¼â‚ Î¼â‚‚ â„“á¶œâ‚ â„“á¶œâ‚‚ â„“Ì‚â‚ â„“Ì‚â‚‚ M v T}
  â†’ (k : â„•)
  â†’ (lÌ‚ â„“á¶œâ‚) â‰¾ â„“Ì‚â‚
  â†’ Î¼â‚ âŠ¢â‚› Î¼â‚
  â†’ Î“ âˆ£ Î¼â‚ âŠ¢â‚‘ Î³
  â†’ length Î¼â‚ âˆ‰domâ‚™ Î¼â‚
  â†’ (âŠ¢M : Î“ [ â„“Ì‚â‚ , â„“Ì‚â‚‚ ]âŠ¢ M â¦‚ T)
  â†’ ğ’± Î³ M âŠ¢M Î¼â‚ â„“á¶œâ‚ k â‰¡ result âŸ¨ Î¼â‚‚ , v , â„“á¶œâ‚‚ âŸ©
    -------------------------------------------
  â†’ (lÌ‚ â„“á¶œâ‚‚) â‰¾ â„“Ì‚â‚‚

apply-pcâ‰¾ {k = k} â„“á¶œâ‰¾â„“â‚ âŠ¢Î¼ _ fresh (âŠ¢áµ¥clos âŠ¢Î³ âŠ¢M) âŠ¢w eq = ğ’±-pres-pcâ‰² k â„“á¶œâ‰¾â„“â‚ âŠ¢Î¼ (âŠ¢â‚‘âˆ· âŠ¢w âŠ¢Î³) fresh âŠ¢M eq
apply-pcâ‰¾ {Î³ = Î³} {Î¼} {â„“á¶œ = â„“á¶œ} {w = w} {k = k} â„“á¶œâ‰¾â„“â‚ âŠ¢Î¼ âŠ¢Î³ fresh
          (âŠ¢áµ¥proxy {S = S} {T} {Sâ€²} {Tâ€²} {v} {â„“Ì‚â‚} {â„“Ì‚â‚‚} {â„“Ì‚â‚â€²} {â„“Ì‚â‚‚â€²} {Sâ€²â‰²S} {Tâ‰²Tâ€²} {â„“Ì‚â‚â€²â‰¾â„“Ì‚â‚} {â„“Ì‚â‚‚â‰¾â„“Ì‚â‚‚â€²} âŠ¢v) âŠ¢w eq
  with castT Î¼ â„“á¶œ Sâ€² S w | castT-state-idem {Î¼} {â„“á¶œ} {Sâ€²} {S} âŠ¢w | âŠ¢castT {Î¼} {â„“á¶œ} {Sâ€²} {S} âŠ¢Î¼ âŠ¢w
... | result âŸ¨ Î¼â‚ , wâ€² , â„“á¶œâ‚ âŸ© | â–¹result Î¼â‰¡Î¼â‚ â„“á¶œâ‰¡â„“á¶œâ‚ | âŠ¢áµ£result âŠ¢Î¼â‚ âŠ¢wâ€²
  {- NOTE:
    In this step, we perform a cast âŸ¨ â„“Ì‚â‚â€² â‡› â„“Ì‚â‚ âŸ©, and since it succeeds (otherwise is blamed and contradicts `eq`),
    we have â„“á¶œ â‰¾ â„“Ì‚â‚ .
  -}
  with castL Î¼â‚ â„“á¶œâ‚ â„“Ì‚â‚â€² â„“Ì‚â‚ â„“Ì‚â‚â€²â‰¾â„“Ì‚â‚
...   | result âŸ¨ Î¼â‚‚ , _ , â„“á¶œâ‚‚ âŸ©
  with apply Î³ v wâ€² Î¼â‚‚ â„“á¶œâ‚‚ k
...     | result âŸ¨ Î¼â‚ƒ , vâ‚ , â„“á¶œâ‚ƒ âŸ©
  with castL Î¼â‚ƒ â„“á¶œâ‚ƒ â„“Ì‚â‚‚ â„“Ì‚â‚‚â€² â„“Ì‚â‚‚â‰¾â„“Ì‚â‚‚â€² | inspect (Î» Î¼ â†’ castL Î¼ â„“á¶œâ‚ƒ â„“Ì‚â‚‚ â„“Ì‚â‚‚â€² â„“Ì‚â‚‚â‰¾â„“Ì‚â‚‚â€²) Î¼â‚ƒ | castL-state-idem {Î¼â‚ƒ} {â„“á¶œâ‚ƒ} â„“Ì‚â‚‚â‰¾â„“Ì‚â‚‚â€²
...       | result âŸ¨ Î¼â‚„ , _ , â„“á¶œâ‚„ âŸ© | [ eqâ‚ ] | â–¹result _ â„“á¶œâ‚ƒâ‰¡â„“á¶œâ‚„
  with castT Î¼â‚„ â„“á¶œâ‚„ T Tâ€² vâ‚ | inspect (Î» Î¼ â†’ castT Î¼ â„“á¶œâ‚„ T Tâ€² vâ‚) Î¼â‚„
...         | result âŸ¨ Î¼â‚… , vâ‚‚ , â„“á¶œâ‚… âŸ© | [ eqâ‚‚ ] =
  let â„“á¶œâ‚ƒâ‰¾â„“Ì‚â‚‚â€² = castL-no-blame-inv â„“Ì‚â‚‚â‰¾â„“Ì‚â‚‚â€² eqâ‚ in
  let â„“á¶œâ‚„â‰¡â„“á¶œâ‚… = castTâ†’â„“á¶œâ‰¡ {Î¼â‚ = Î¼â‚„} {â„“á¶œâ‚ = â„“á¶œâ‚„} {Tâ‚ = T} {Tâ€²} vâ‚ eqâ‚‚ in
  let â„“á¶œâ‚…â‰¡â„“á¶œâ€² = resultâ‰¡â†’â„“á¶œâ‰¡ eq in
    subst (Î» â–¡ â†’ lÌ‚ â–¡ â‰¾ _) (trans â„“á¶œâ‚ƒâ‰¡â„“á¶œâ‚„ (trans â„“á¶œâ‚„â‰¡â„“á¶œâ‚… â„“á¶œâ‚…â‰¡â„“á¶œâ€²)) â„“á¶œâ‚ƒâ‰¾â„“Ì‚â‚‚â€²


ğ’±-pres-pcâ‰² 0 _ _ _ _ _ ()
ğ’±-pres-pcâ‰² {Î³ = Î³} (suc k) â„“á¶œâ‚â‰¾â„“â‚ _ _ _ (âŠ¢` {x = x} eq) eqâ‚
  with nth Î³ x
... | just _ rewrite sym (resultâ‰¡â†’â„“á¶œâ‰¡ eqâ‚) = â„“á¶œâ‚â‰¾â„“â‚
ğ’±-pres-pcâ‰² (suc k) â„“á¶œâ‚â‰¾â„“â‚ _ _ _ âŠ¢tt eq rewrite sym (resultâ‰¡â†’â„“á¶œâ‰¡ eq) = â„“á¶œâ‚â‰¾â„“â‚
ğ’±-pres-pcâ‰² (suc k) â„“á¶œâ‚â‰¾â„“â‚ _ _ _ âŠ¢true eq rewrite sym (resultâ‰¡â†’â„“á¶œâ‰¡ eq) = â„“á¶œâ‚â‰¾â„“â‚
ğ’±-pres-pcâ‰² (suc k) â„“á¶œâ‚â‰¾â„“â‚ _ _ _ âŠ¢false eq rewrite sym (resultâ‰¡â†’â„“á¶œâ‰¡ eq) = â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢let {T = T} {Tâ€²} {M = M} {N} {â„“Ì‚â‚} {â„“Ì‚â‚‚} {â„“Ì‚â‚ƒ} âŠ¢M âŠ¢N Tâ€²â‰²T) eq
  with ğ’± Î³ M âŠ¢M Î¼â‚ â„“á¶œâ‚ k
     | ğ’±-safe {Î“} k â„“á¶œâ‚ âŠ¢Î¼â‚ fresh âŠ¢Î³ âŠ¢M
     | ğ’±-pres-WFaddr {Î“} {Î³} {Î¼ = Î¼â‚} {â„“á¶œâ‚} {k} âŠ¢M âŠ¢Î¼â‚ âŠ¢Î³ fresh
     | ğ’±-pres-âŠ¢â‚‘ {pc = â„“á¶œâ‚} {k} âŠ¢M âŠ¢Î¼â‚ âŠ¢Î³ âŠ¢Î³ fresh
     | inspect (Î» â–¡ â†’ ğ’± Î³ M â–¡ Î¼â‚ â„“á¶œâ‚ k) âŠ¢M
... | result âŸ¨ Î¼â€² , vâ€² , â„“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ€² | WFresult freshÎ¼â€² | WTenv-result Î¼â€²âŠ¢Î³ | [ eqâ‚ ]
  with castT Î¼â€² â„“á¶œâ€² Tâ€² T vâ€² | âŠ¢castT {Î¼â€²} {â„“á¶œâ€²} {Tâ€²} {T} âŠ¢Î¼â€² âŠ¢vâ€² | castT-state-idem {Î¼â€²} {â„“á¶œâ€²} {Tâ€²} {T} âŠ¢vâ€²
...   | result âŸ¨ Î¼â€³ , vâ€³ , â„“á¶œâ€³ âŸ© | âŠ¢áµ£result âŠ¢Î¼â€³ âŠ¢vâ€³ | â–¹result Î¼â€²â‰¡Î¼â€³ â„“á¶œâ€²â‰¡â„“á¶œâ€³ rewrite (sym Î¼â€²â‰¡Î¼â€³) =
  let â„“á¶œâ€²â‰¾â„“â‚‚ = ğ’±-pres-pcâ‰² k â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh âŠ¢M eqâ‚ in
  let â„“á¶œâ€³â‰¾â„“â‚‚ = subst (Î» â–¡ â†’ lÌ‚ â–¡ â‰¾ â„“Ì‚â‚‚) â„“á¶œâ€²â‰¡â„“á¶œâ€³ â„“á¶œâ€²â‰¾â„“â‚‚ in
    ğ’±-pres-pcâ‰² k â„“á¶œâ€³â‰¾â„“â‚‚ âŠ¢Î¼â€³ (âŠ¢â‚‘âˆ· âŠ¢vâ€³ Î¼â€²âŠ¢Î³) freshÎ¼â€² âŠ¢N eq

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢if {x = x} {T = T} {Tâ€²} {Tâ€³} {â„“Ì‚â‚‚ = â„“Ì‚â‚‚} {â„“Ì‚â‚‚â€²} _ âŠ¢M âŠ¢N _) eq
  with nth Î³ x
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢if {x = x} {T = T} {Tâ€²} {Tâ€³} {â„“Ì‚â‚‚ = â„“Ì‚â‚‚} {â„“Ì‚â‚‚â€²} _ âŠ¢M âŠ¢N _) eq | just V-true
  with ğ’± Î³ _ âŠ¢M Î¼â‚ â„“á¶œâ‚ k | ğ’±-safe {Î“} k â„“á¶œâ‚ âŠ¢Î¼â‚ fresh âŠ¢Î³ âŠ¢M | inspect (Î» âŠ¢M â†’ ğ’± Î³ _ âŠ¢M Î¼â‚ â„“á¶œâ‚ k) âŠ¢M
... | result âŸ¨ Î¼â€² , vâ‚˜ , â„“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚˜ | [ eqâ‚ ]
  with castL Î¼â€² â„“á¶œâ€² â„“Ì‚â‚‚ (â„“Ì‚â‚‚ â‹ â„“Ì‚â‚‚â€²) (â„“Ì‚â‰¾â„“Ì‚â‹â„“Ì‚â€² _ _) | castL-state-idem {Î¼â€²} {â„“á¶œâ€²} {â„“Ì‚â‚‚} {â„“Ì‚â‚‚ â‹ â„“Ì‚â‚‚â€²} (â„“Ì‚â‰¾â„“Ì‚â‹â„“Ì‚â€² _ _)
...   | result âŸ¨ Î¼â€³ , _ , â„“á¶œâ€³ âŸ© | â–¹result Î¼â€²â‰¡Î¼â€³ â„“á¶œâ€²â‰¡â„“á¶œâ€³
  with castT Î¼â€³ â„“á¶œâ€³ T Tâ€³ vâ‚˜ | castT-state-idem {Î¼â€³} {â„“á¶œâ€³} {T} {Tâ€³} Î¼â€³âŠ¢vâ‚˜
  where
  Î¼â€³âŠ¢vâ‚˜ = subst (Î» â–¡ â†’ â–¡ âŠ¢áµ¥ vâ‚˜ â¦‚ _) Î¼â€²â‰¡Î¼â€³ âŠ¢vâ‚˜
...     | result _ | â–¹result _ â„“á¶œâ€³â‰¡â„“á¶œâ‚‚â€² =
  let â„“á¶œâ€²â‰¾â„“â‚‚ = ğ’±-pres-pcâ‰² k â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh âŠ¢M eqâ‚ in
  let â„“á¶œâ‚‚â€²â‰¡â„“á¶œâ‚‚ = resultâ‰¡â†’â„“á¶œâ‰¡ eq in
  let â„“á¶œâ‚‚â‰¾â„“â‚‚ = subst (Î» â–¡ â†’ lÌ‚ â–¡ â‰¾ â„“Ì‚â‚‚) (trans â„“á¶œâ€²â‰¡â„“á¶œâ€³ (trans â„“á¶œâ€³â‰¡â„“á¶œâ‚‚â€² â„“á¶œâ‚‚â€²â‰¡â„“á¶œâ‚‚)) â„“á¶œâ€²â‰¾â„“â‚‚ in
    â„“â‰¾â„“â‚â†’â„“â‰¾â„“â‚â‹â„“â‚‚ â„“á¶œâ‚‚â‰¾â„“â‚‚
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢if {x = x} {T = T} {Tâ€²} {Tâ€³} {â„“Ì‚â‚‚ = â„“Ì‚â‚‚} {â„“Ì‚â‚‚â€²} _ âŠ¢M âŠ¢N _) eq | just V-false
  with ğ’± Î³ _ âŠ¢N Î¼â‚ â„“á¶œâ‚ k | ğ’±-safe {Î“} k â„“á¶œâ‚ âŠ¢Î¼â‚ fresh âŠ¢Î³ âŠ¢N | inspect (Î» âŠ¢N â†’ ğ’± Î³ _ âŠ¢N Î¼â‚ â„“á¶œâ‚ k) âŠ¢N
... | result âŸ¨ Î¼â€² , vâ‚™ , â„“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚™ | [ eqâ‚ ]
  with castL Î¼â€² â„“á¶œâ€² â„“Ì‚â‚‚â€² (â„“Ì‚â‚‚ â‹ â„“Ì‚â‚‚â€²) (â„“Ì‚â‰¾â„“Ì‚â€²â‹â„“Ì‚ _ _) | castL-state-idem {Î¼â€²} {â„“á¶œâ€²} {â„“Ì‚â‚‚â€²} {â„“Ì‚â‚‚ â‹ â„“Ì‚â‚‚â€²} (â„“Ì‚â‰¾â„“Ì‚â€²â‹â„“Ì‚ _ _)
...   | result âŸ¨ Î¼â€³ , _ , â„“á¶œâ€³ âŸ© | â–¹result Î¼â€²â‰¡Î¼â€³ â„“á¶œâ€²â‰¡â„“á¶œâ€³
  with castT Î¼â€³ â„“á¶œâ€³ Tâ€² Tâ€³ vâ‚™ | castT-state-idem {Î¼â€³} {â„“á¶œâ€³} {Tâ€²} {Tâ€³} Î¼â€³âŠ¢vâ‚™
  where
  Î¼â€³âŠ¢vâ‚™ = subst (Î» â–¡ â†’ â–¡ âŠ¢áµ¥ vâ‚™ â¦‚ _) Î¼â€²â‰¡Î¼â€³ âŠ¢vâ‚™
...     | result _ | â–¹result _ â„“á¶œâ€³â‰¡â„“á¶œâ‚‚â€² =
  let â„“á¶œâ€²â‰¾â„“â‚‚â€² = ğ’±-pres-pcâ‰² k â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh âŠ¢N eqâ‚ in
  let â„“á¶œâ‚‚â€²â‰¡â„“á¶œâ‚‚ = resultâ‰¡â†’â„“á¶œâ‰¡ eq in
  let â„“á¶œâ‚‚â‰¾â„“â‚‚â€² = subst (Î» â–¡ â†’ lÌ‚ â–¡ â‰¾ â„“Ì‚â‚‚â€²) (trans â„“á¶œâ€²â‰¡â„“á¶œâ€³ (trans â„“á¶œâ€³â‰¡â„“á¶œâ‚‚â€² â„“á¶œâ‚‚â€²â‰¡â„“á¶œâ‚‚)) â„“á¶œâ€²â‰¾â„“â‚‚â€² in
    subst (Î» â–¡ â†’ lÌ‚ _ â‰¾ â–¡) (â‹-comm â„“Ì‚â‚‚â€² â„“Ì‚â‚‚) (â„“â‰¾â„“â‚â†’â„“â‰¾â„“â‚â‹â„“â‚‚ â„“á¶œâ‚‚â‰¾â„“â‚‚â€²)

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} {â„“á¶œâ‚‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢get {x = x} {T} {â„“Ì‚â‚} eqâ‚) eq
  with nth Î³ x | inspect (Î» Î³ â†’ nth Î³ x) Î³
... | just (V-ref âŸ¨ n , â„“â‚ , â„“â‚‚ âŸ©) | [ eqâ‚‚ ]
  with lookup Î¼â‚ âŸ¨ n , â„“â‚ , â„“â‚‚ âŸ© | inspect (Î» Î¼ â†’ lookup Î¼ âŸ¨ n , â„“â‚ , â„“â‚‚ âŸ©) Î¼â‚
...   | just âŸ¨ Tâ€² , v âŸ© | [ eqâ‚ƒ ]
  with castT Î¼â‚ (â„“á¶œâ‚ âŠ” â„“â‚‚) Tâ€² T v | castT-state-idem {Î¼â‚} {â„“á¶œâ‚ âŠ” â„“â‚‚} {Tâ€²} {T} âŠ¢v
  where
  âŠ¢v = lookup-safe âŠ¢Î¼â‚ eqâ‚ƒ
...     | result _  | â–¹result _ â„“á¶œâ‰¡ with âŠ¢â‚‘â†’nthâŠ¢áµ¥ âŠ¢Î³ eqâ‚‚ eqâ‚
...       | âŠ¢áµ¥ref {â„“â‚‚ = â„“â‚‚} _ rewrite sym (trans â„“á¶œâ‰¡ (resultâ‰¡â†’â„“á¶œâ‰¡ eq)) = â„“â‚â‰¾â„“Ì‚â†’â„“â‚âŠ”â„“â‚‚â‰¾â„“Ì‚â‹â„“â‚‚ â„“á¶œâ‚â‰¾â„“â‚
...       | âŠ¢áµ¥ref-dyn _ rewrite â„“Ì‚â‹Â¿â‰¡Â¿ â„“Ì‚â‚ = â‰¾-Â¿-r

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢set {x = x} {y} {T} {Tâ€²} _ _ _ _) eq
  with nth Î³ x | nth Î³ y
... | just (V-ref âŸ¨ n , â„“â‚ , â„“â‚‚ âŸ©) | just v
  with lookup Î¼â‚ âŸ¨ n , â„“â‚ , â„“â‚‚ âŸ©
...   | just âŸ¨ Tâ€³ , _ âŸ©
  {- NOTE:
    Since we don't upgrade â„“á¶œ with the join of â„“â‚‚ in the operational semantics anymore,
    the case-split here is updated accordingly.
  -}
  with castT Î¼â‚ â„“á¶œâ‚ Tâ€² T v | inspect (Î» Î¼ â†’ castT Î¼ â„“á¶œâ‚ Tâ€² T v) Î¼â‚
...     | result âŸ¨ Î¼â€² , vâ€² , â„“á¶œâ€² âŸ© | [ eqâ‚ ]
  with castT Î¼â€² â„“á¶œâ€² T Tâ€³ vâ€² | inspect (Î» Î¼ â†’ castT Î¼ â„“á¶œâ€² T Tâ€³ vâ€²) Î¼â€²
...       | result âŸ¨ Î¼â€³ , vâ€³ , â„“á¶œâ€³ âŸ© | [ eqâ‚‚ ]
  with â„“á¶œâ€³ â‰¼? â„“â‚‚
...         | yes _ rewrite sym (resultâ‰¡â†’â„“á¶œâ‰¡ eq) =
  let â„“á¶œâ‚â‰¡â„“á¶œâ€² = castTâ†’â„“á¶œâ‰¡ {Î¼â‚ = Î¼â‚} {â„“á¶œâ‚ = â„“á¶œâ‚} {Tâ‚ = Tâ€²} {T} v eqâ‚ in
  let â„“á¶œâ€²â‰¡â„“á¶œâ€³ = castTâ†’â„“á¶œâ‰¡ {Î¼â‚ = Î¼â€²} {â„“á¶œâ‚ = â„“á¶œâ€²} {Tâ‚ = T} {Tâ€³} vâ€² eqâ‚‚ in
    subst (Î» â–¡ â†’ lÌ‚ â–¡ â‰¾ _) (trans â„“á¶œâ‚â‰¡â„“á¶œâ€² â„“á¶œâ€²â‰¡â„“á¶œâ€³) â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢new {y = y} {â„“ = â„“} _ _) eq
  with â„“á¶œâ‚ â‰¼? â„“
... | yes _
  with nth Î³ y
...   | just v rewrite sym (resultâ‰¡â†’â„“á¶œâ‰¡ eq) = â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢new-dyn {x = x} {y} _ _) eq
  with nth Î³ x | nth Î³ y
... | just (V-label â„“) | just _
  with â„“á¶œâ‚ â‰¼? â„“
...   | yes _ rewrite sym (resultâ‰¡â†’â„“á¶œâ‰¡ eq) = â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢eq-ref {x = x} {y} _ _ _ _) eq
  with nth Î³ x | nth Î³ y
... | just (V-ref loc) | just (V-ref locâ€²) rewrite resultâ‰¡â†’â„“á¶œâ‰¡ eq = â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢Æ› _) eq rewrite resultâ‰¡â†’â„“á¶œâ‰¡ eq = â„“á¶œâ‚â‰¾â„“â‚


ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚â€² âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢Â· {x = x} {y} {T} {Tâ€²} {S} {â„“Ì‚â‚} {â„“Ì‚â‚â€²} eqâ‚ eqâ‚‚ _ â„“Ì‚â‚â€²â‰¾â„“Ì‚â‚) eq
  rewrite projâ‚‚ (âŠ¢Î³â†’âˆƒv âŠ¢Î³ eqâ‚) | projâ‚‚ (âŠ¢Î³â†’âˆƒv âŠ¢Î³ eqâ‚‚)
  with projâ‚ (âŠ¢Î³â†’âˆƒv âŠ¢Î³ eqâ‚) | (âŠ¢Î³â†’âŠ¢v âŠ¢Î³ eqâ‚) | projâ‚ (âŠ¢Î³â†’âˆƒv âŠ¢Î³ eqâ‚‚) | (âŠ¢Î³â†’âŠ¢v âŠ¢Î³ eqâ‚‚)
... | v | âŠ¢v | w | âŠ¢w
  with castT Î¼â‚ â„“á¶œâ‚ Tâ€² T w | âŠ¢castT {pc = â„“á¶œâ‚} {Tâ€²} {T} âŠ¢Î¼â‚ âŠ¢w | castT-state-idem {Î¼â‚} {â„“á¶œâ‚} {Tâ€²} {T} âŠ¢w
...   | result âŸ¨ Î¼â€² , wâ€² , â„“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢wâ€² | â–¹result Î¼â‚â‰¡Î¼â€² â„“á¶œâ‚â‰¡â„“á¶œâ€²
  with castL Î¼â€² â„“á¶œâ€² â„“Ì‚â‚â€² â„“Ì‚â‚ â„“Ì‚â‚â€²â‰¾â„“Ì‚â‚ | inspect (Î» Î¼ â†’ castL Î¼ â„“á¶œâ€² â„“Ì‚â‚â€² â„“Ì‚â‚ â„“Ì‚â‚â€²â‰¾â„“Ì‚â‚) Î¼â€²
...     | result âŸ¨ Î¼â€³ , _ , â„“á¶œâ€³ âŸ© | [ eqâ‚ƒ ]
  with apply Î³ v wâ€² Î¼â‚ â„“á¶œâ‚ k | inspect (Î» Î³ â†’ apply Î³ v wâ€² Î¼â‚ â„“á¶œâ‚ k) Î³
...       | result _ | [ eqâ‚„ ] rewrite (sym (resultâ‰¡â†’â„“á¶œâ‰¡ eq)) =
  let â„“á¶œâ‚â‰¾â„“â‚ = subst (Î» â–¡ â†’ lÌ‚ â–¡ â‰¾ _) (sym â„“á¶œâ‚â‰¡â„“á¶œâ€²) (castL-no-blame-inv â„“Ì‚â‚â€²â‰¾â„“Ì‚â‚ eqâ‚ƒ) in
  let Î¼â‚âŠ¢wâ€² = subst (Î» â–¡ â†’ â–¡ âŠ¢áµ¥ _ â¦‚ _) (sym Î¼â‚â‰¡Î¼â€²) âŠ¢wâ€² in
    apply-pcâ‰¾ â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh âŠ¢v Î¼â‚âŠ¢wâ€² eqâ‚„

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢ref-label {x = x} _) eq
  with nth Î³ x
... | just (V-ref âŸ¨ n , â„“â‚ , â„“â‚‚ âŸ©) rewrite resultâ‰¡â†’â„“á¶œâ‰¡ eq = â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢lab-label {x = x} _) eq
  with nth Î³ x
... | just (V-lab â„“ v) rewrite resultâ‰¡â†’â„“á¶œâ‰¡ eq = â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh âŠ¢pc-label eq rewrite resultâ‰¡â†’â„“á¶œâ‰¡ eq = â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh âŠ¢label eq rewrite resultâ‰¡â†’â„“á¶œâ‰¡ eq = â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢â‰¼ {x = x} {y} _ _) eq
  with nth Î³ x | nth Î³ y
... | just (V-label â„“Ë£) | just (V-label â„“Ê¸) with â„“Ë£ â‰¼? â„“Ê¸
...   | yes _ rewrite resultâ‰¡â†’â„“á¶œâ‰¡ eq = â„“á¶œâ‚â‰¾â„“â‚
...   | no  _ rewrite resultâ‰¡â†’â„“á¶œâ‰¡ eq = â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢âŠ” {x = x} {y} _ _) eq
  with nth Î³ x | nth Î³ y
... | just (V-label _ ) | just (V-label _) rewrite resultâ‰¡â†’â„“á¶œâ‰¡ eq = â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢âŠ“ {x = x} {y} _ _) eq
  with nth Î³ x | nth Î³ y
... | just (V-label _) | just (V-label _) rewrite resultâ‰¡â†’â„“á¶œâ‰¡ eq = â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} {â„“á¶œâ‚‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢unlabel {x = x} {â„“Ì‚â‚ = â„“Ì‚â‚} eqâ‚) eq
  with nth Î³ x | inspect (Î» Î³ â†’ nth Î³ x) Î³
... | just (V-lab â„“ _) | [ eqâ‚‚ ]
  with âŠ¢â‚‘â†’nthâŠ¢áµ¥ âŠ¢Î³ eqâ‚‚ eqâ‚
...   | âŠ¢áµ¥lab â„“â‰¼â„“â€² _ rewrite sym (resultâ‰¡â†’â„“á¶œâ‰¡ eq) = â„“â‰¾â„“Ì‚â†’â„“â‚â‰¼â„“â‚‚â†’â„“âŠ”â„“â‚â‰¾â„“Ì‚â‹â„“â‚‚ â„“á¶œâ‚â‰¾â„“â‚ â„“â‰¼â„“â€²
...   | âŠ¢áµ¥lab-dyn _ rewrite sym (resultâ‰¡â†’â„“á¶œâ‰¡ eq) | â„“Ì‚â‹Â¿â‰¡Â¿ â„“Ì‚â‚ = â‰¾-Â¿-r

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢to-label {M = M} {â„“ = â„“} âŠ¢M _) eq
  with ğ’± Î³ M âŠ¢M Î¼â‚ â„“á¶œâ‚ k
... | result âŸ¨ Î¼â€² , v , â„“á¶œâ€² âŸ©
  with â„“á¶œâ€² â‰¼? (â„“á¶œâ‚ âŠ” â„“)
...   | yes _ rewrite sym (resultâ‰¡â†’â„“á¶œâ‰¡ eq) = â„“á¶œâ‚â‰¾â„“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {â„“á¶œâ‚} (suc k) â„“á¶œâ‚â‰¾â„“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢to-label-dyn {x = x} {M = M} _ âŠ¢M) eq
  with nth Î³ x
... | just (V-label â„“)
  with ğ’± Î³ M âŠ¢M Î¼â‚ â„“á¶œâ‚ k
...   | result âŸ¨ Î¼â€² , v , â„“á¶œâ€² âŸ©
  with â„“á¶œâ€² â‰¼? (â„“á¶œâ‚ âŠ” â„“)
...     | yes _ rewrite sym (resultâ‰¡â†’â„“á¶œâ‰¡ eq) = â„“á¶œâ‚â‰¾â„“â‚
