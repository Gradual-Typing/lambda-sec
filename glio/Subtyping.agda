module Subtyping where

open import Data.Nat using (â„•; zero; suc; _â‰¤_; zâ‰¤n; sâ‰¤s) renaming (_âŠ”_ to _âŠ”â‚™_; _âŠ“_ to _âŠ“â‚™_; _â‰Ÿ_ to _â‰Ÿâ‚™_)
open import Data.Nat.Properties using (mâ‰¤mâŠ”n)
open import Data.Empty using (âŠ¥; âŠ¥-elim)
open import Data.Product using (_Ã—_; âˆƒ; âˆƒ-syntax; Î£; Î£-syntax; projâ‚; projâ‚‚) renaming (_,_ to âŸ¨_,_âŸ©)
open import Data.Maybe using (Maybe; just; nothing)
open import Data.List using (List; []; _âˆ·_; length)
import Relation.Binary.PropositionalEquality as Eq
open Eq using (_â‰¡_; _â‰¢_; refl; sym; trans; subst; inspect; [_])
open import Relation.Nullary using (Dec; yes; no; Â¬_)

open import StaticsGLIO
open import Lemmas
open import Interp
open import WellTypedness using (_âŠ¢áµ¥_â¦‚_)
open import Store



infixl 9 _â‰º:_

data _â‰º:_ : â„’Ì‚ â†’ â„’Ì‚ â†’ Set where

  â‰º:-Â¿ : âˆ€ {â„“Ì‚}
       ------
    â†’ â„“Ì‚ â‰º: Â¿

  â‰º:-l : âˆ€ {â„“â‚ â„“â‚‚}
    â†’ â„“â‚ â‰¼ â„“â‚‚
      -----------------
    â†’ (lÌ‚ â„“â‚) â‰º: (lÌ‚ â„“â‚‚)



â„“â‰¾â„“â‚â†’â„“â‰º:â„“â‚â‹â„“â‚‚ : âˆ€ {â„“ â„“Ì‚â‚}
  â†’ (â„“Ì‚â‚‚ : â„’Ì‚)
  â†’ (lÌ‚ â„“) â‰¾ â„“Ì‚â‚
    -----------------
  â†’ (lÌ‚ â„“) â‰º: â„“Ì‚â‚ â‹ â„“Ì‚â‚‚
â„“â‰¾â„“â‚â†’â„“â‰º:â„“â‚â‹â„“â‚‚ {â„“} {â„“Ì‚â‚} Â¿ â„“â‰¾â„“â‚ rewrite â„“Ì‚â‹Â¿â‰¡Â¿ â„“Ì‚â‚ = â‰º:-Â¿
â„“â‰¾â„“â‚â†’â„“â‰º:â„“â‚â‹â„“â‚‚ {â„“} {Â¿} (lÌ‚ _) _ = â‰º:-Â¿
â„“â‰¾â„“â‚â†’â„“â‰º:â„“â‚â‹â„“â‚‚ {â„“} {lÌ‚ â„“â‚} (lÌ‚ â„“â‚‚) (â‰¾-l â„“â‰¼â„“â‚) = â‰º:-l (â„“â‰¼â„“â‚â†’â„“â‰¼â„“â‚âŠ”â„“â‚‚ â„“â‚‚ â„“â‰¼â„“â‚)

â„“â‰º:â„“â‹â„“â€² : âˆ€ â„“Ì‚ â„“Ì‚â€² â†’ â„“Ì‚ â‰º: â„“Ì‚ â‹ â„“Ì‚â€²
â„“â‰º:â„“â‹â„“â€² â„“Ì‚ Â¿ rewrite â„“Ì‚â‹Â¿â‰¡Â¿ â„“Ì‚ = â‰º:-Â¿
â„“â‰º:â„“â‹â„“â€² Â¿ (lÌ‚ â„“â€²) = â‰º:-Â¿
â„“â‰º:â„“â‹â„“â€² (lÌ‚ â„“) (lÌ‚ â„“â€²) = â‰º:-l (â„“â‰¼â„“âŠ”â„“â€² â„“ â„“â€²)

-- â‰º: is smaller than â‰¾
â‰º:â†’â‰¾ : âˆ€ {â„“ â„“â€²}
  â†’ â„“ â‰º: â„“â€²
    --------
  â†’ â„“ â‰¾ â„“â€²
â‰º:â†’â‰¾ â‰º:-Â¿ = â‰¾-Â¿-r
â‰º:â†’â‰¾ (â‰º:-l â„“â‚â‰¼â„“â‚‚) = â‰¾-l â„“â‚â‰¼â„“â‚‚

-- Consistent subtyping â‰¾ is not transitive; alternatively, we have:
â„“â‚â‰¾â„“â‚‚â†’â„“â‚‚â‰º:â„“â‚ƒâ†’â„“â‚â‰¾â„“â‚ƒ : âˆ€ {â„“Ì‚â‚ â„“Ì‚â‚‚ â„“Ì‚â‚ƒ}
  â†’ â„“Ì‚â‚ â‰¾ â„“Ì‚â‚‚
  â†’ â„“Ì‚â‚‚ â‰º: â„“Ì‚â‚ƒ
    ---------
  â†’ â„“Ì‚â‚ â‰¾ â„“Ì‚â‚ƒ
â„“â‚â‰¾â„“â‚‚â†’â„“â‚‚â‰º:â„“â‚ƒâ†’â„“â‚â‰¾â„“â‚ƒ â‰¾-Â¿-r â‰º:-Â¿ = â‰¾-Â¿-r
â„“â‚â‰¾â„“â‚‚â†’â„“â‚‚â‰º:â„“â‚ƒâ†’â„“â‚â‰¾â„“â‚ƒ â‰¾-Â¿-l â‰º:-Â¿ = â‰¾-Â¿-r
â„“â‚â‰¾â„“â‚‚â†’â„“â‚‚â‰º:â„“â‚ƒâ†’â„“â‚â‰¾â„“â‚ƒ (â‰¾-l _) â‰º:-Â¿ = â‰¾-Â¿-r
â„“â‚â‰¾â„“â‚‚â†’â„“â‚‚â‰º:â„“â‚ƒâ†’â„“â‚â‰¾â„“â‚ƒ â‰¾-Â¿-l (â‰º:-l _) = â‰¾-Â¿-l
â„“â‚â‰¾â„“â‚‚â†’â„“â‚‚â‰º:â„“â‚ƒâ†’â„“â‚â‰¾â„“â‚ƒ {lÌ‚ â„“â‚} {lÌ‚ â„“â‚‚} {lÌ‚ â„“â‚ƒ} (â‰¾-l â„“â‚â‰¼â„“â‚‚) (â‰º:-l â„“â‚‚â‰¼â„“â‚ƒ) = â‰¾-l (â‰¼-trans â„“â‚â‰¼â„“â‚‚ â„“â‚‚â‰¼â„“â‚ƒ)



infixl 9 _â‰‚_

data _â‰‚_ : â„’Ì‚ â†’ â„’Ì‚ â†’ Set where

  â‰‚-Â¿ : âˆ€ {â„“Ì‚}
      ------
    â†’ â„“Ì‚ â‰‚ Â¿

  â‰‚-l : âˆ€ {â„“}
      ---------------
    â†’ (lÌ‚ â„“) â‰‚ (lÌ‚ â„“)

infixl 9 _<:_

data _<:_ : ğ•‹ â†’ ğ•‹ â†’ Set where

  <:-âŠ¤ : `âŠ¤ <: `âŠ¤

  <:-ğ”¹ : `ğ”¹ <: `ğ”¹

  <:-â„’ : `â„’ <: `â„’

  <:-Ref : âˆ€ {â„“Ì‚â‚ â„“Ì‚â‚‚ Tâ‚ Tâ‚‚}
    â†’ â„“Ì‚â‚ â‰‚ â„“Ì‚â‚‚
    â†’ Tâ‚ â‰² Tâ‚‚ â†’ Tâ‚‚ â‰² Tâ‚
      -----------------------
    â†’ Ref â„“Ì‚â‚ Tâ‚ <: Ref â„“Ì‚â‚‚ Tâ‚‚

  <:-Lab : âˆ€ {â„“Ì‚â‚ â„“Ì‚â‚‚ Tâ‚ Tâ‚‚}
    â†’ â„“Ì‚â‚ â‰º: â„“Ì‚â‚‚
    â†’ Tâ‚ <: Tâ‚‚
      -----------------------
    â†’ Lab â„“Ì‚â‚ Tâ‚ <: Lab â„“Ì‚â‚‚ Tâ‚‚

  <:-â‡’ : âˆ€ {â„“Ì‚â‚ â„“Ì‚â‚‚ â„“Ì‚â‚â€² â„“Ì‚â‚‚â€² Sâ‚ Sâ‚‚ Tâ‚ Tâ‚‚}
    â†’ â„“Ì‚â‚â€² â‰º: â„“Ì‚â‚
    â†’ â„“Ì‚â‚‚ â‰º: â„“Ì‚â‚‚â€²
    â†’ Tâ‚ <: Sâ‚
    â†’ Sâ‚‚ <: Tâ‚‚
      ---------------------------------------------------
    â†’ (Sâ‚ [ â„“Ì‚â‚ ]â‡’[ â„“Ì‚â‚‚ ] Sâ‚‚) <: (Tâ‚ [ â„“Ì‚â‚â€² ]â‡’[ â„“Ì‚â‚‚â€² ] Tâ‚‚)



â‰‚â†’â‰¾ : âˆ€ {â„“Ì‚â‚ â„“Ì‚â‚‚}
  â†’ â„“Ì‚â‚ â‰‚ â„“Ì‚â‚‚
    ------------------
  â†’ â„“Ì‚â‚ â‰¾ â„“Ì‚â‚‚ Ã— â„“Ì‚â‚‚ â‰¾ â„“Ì‚â‚
â‰‚â†’â‰¾ â‰‚-Â¿ = âŸ¨ â‰¾-Â¿-r , â‰¾-Â¿-l âŸ©
â‰‚â†’â‰¾ â‰‚-l = âŸ¨ â‰¾-refl _ , â‰¾-refl _ âŸ©

-- <: is smaller than â‰²
<:â†’â‰² : âˆ€ {Tâ‚ Tâ‚‚}
  â†’ Tâ‚ <: Tâ‚‚
    ----------
  â†’ Tâ‚ â‰² Tâ‚‚
<:â†’â‰² <:-âŠ¤ = â‰²-âŠ¤
<:â†’â‰² <:-ğ”¹ = â‰²-ğ”¹
<:â†’â‰² <:-â„’ = â‰²-â„’
<:â†’â‰² (<:-Ref â„“â‚â‰‚â„“â‚‚ Tâ‚â‰²Tâ‚‚ Tâ‚‚â‰²Tâ‚) =
  let âŸ¨ â„“â‚â‰¾â„“â‚‚ , â„“â‚‚â‰¾â„“â‚ âŸ© = â‰‚â†’â‰¾ â„“â‚â‰‚â„“â‚‚ in
    â‰²-Ref â„“â‚â‰¾â„“â‚‚ â„“â‚‚â‰¾â„“â‚ Tâ‚â‰²Tâ‚‚ Tâ‚‚â‰²Tâ‚
<:â†’â‰² (<:-Lab â„“â‚â‰º:â„“â‚‚ Tâ‚<:Tâ‚‚) = â‰²-Lab (â‰º:â†’â‰¾ â„“â‚â‰º:â„“â‚‚) (<:â†’â‰² Tâ‚<:Tâ‚‚)
<:â†’â‰² (<:-â‡’ â„“â‚â€²â‰º:â„“â‚ â„“â‚‚â‰º:â„“â‚‚â€² Tâ‚<:Sâ‚ Sâ‚‚<:Tâ‚‚) = â‰²-â‡’ (â‰º:â†’â‰¾ â„“â‚â€²â‰º:â„“â‚) (â‰º:â†’â‰¾ â„“â‚‚â‰º:â„“â‚‚â€²) (<:â†’â‰² Tâ‚<:Sâ‚) (<:â†’â‰² Sâ‚‚<:Tâ‚‚)
