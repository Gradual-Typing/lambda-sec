open import Data.Nat using (â„•; zero; suc; _â‰¤_; zâ‰¤n; sâ‰¤s) renaming (_âŠ”_ to _âŠ”â‚™_; _âŠ“_ to _âŠ“â‚™_; _â‰Ÿ_ to _â‰Ÿâ‚™_)
open import Data.Nat.Properties using (mâ‰¤mâŠ”n; mâ‰¤nâ‡’mâ‰¤nâŠ”o)
open import Data.Empty using (âŠ¥; âŠ¥-elim)
import Relation.Binary.PropositionalEquality as Eq
open Eq using (_â‰¡_; _â‰¢_; refl)
open import Relation.Nullary using (Dec; yes; no; Â¬_)

open import StaticsGLIO
import Syntax
open Syntax.OpSig Op sig
  using (`_; _â¦…_â¦†; cons; nil; bind; ast; _[_]; Subst; âŸª_âŸ«; âŸ¦_âŸ§; exts; rename)
  renaming (ABT to Term)
open import Lemmas
open import Interp



infixl 9 _â‰º:_

data _â‰º:_ : â„’Ì‚ â†’ â„’Ì‚ â†’ Set where

  â‰º:-Â¿ : âˆ€ {ğ“Ì‚}
       ------
    â†’ ğ“Ì‚ â‰º: Â¿

  â‰º-l : âˆ€ {ğ“â‚ ğ“â‚‚}
    â†’ ğ“â‚ â‰¼ ğ“â‚‚
      -----------------
    â†’ (lÌ‚ ğ“â‚) â‰º: (lÌ‚ ğ“â‚‚)



ğ“â‹Â¿â‰¡Â¿ : âˆ€ ğ“Ì‚ â†’ ğ“Ì‚ â‹ Â¿ â‰¡ Â¿
ğ“â‹Â¿â‰¡Â¿ Â¿ = refl
ğ“â‹Â¿â‰¡Â¿ (lÌ‚ _) = refl

ğ“â‰¼ğ“â‚â†’ğ“â‰¼ğ“â‚âŠ”ğ“â‚‚ : âˆ€ {ğ“ ğ“â‚}
  â†’ (ğ“â‚‚ : â„’)
  â†’ ğ“ â‰¼ ğ“â‚
  â†’ ğ“ â‰¼ ğ“â‚ âŠ” ğ“â‚‚
ğ“â‰¼ğ“â‚â†’ğ“â‰¼ğ“â‚âŠ”ğ“â‚‚ {l n} {l nâ‚} (l nâ‚‚) (â‰¼-l nâ‰¤nâ‚) = â‰¼-l (mâ‰¤nâ‡’mâ‰¤nâŠ”o nâ‚‚ nâ‰¤nâ‚)

ğ“â‰¾ğ“â‚â†’ğ“â‰º:ğ“â‚â‹ğ“â‚‚ : âˆ€ {ğ“ ğ“Ì‚â‚}
  â†’ (ğ“Ì‚â‚‚ : â„’Ì‚)
  â†’ (lÌ‚ ğ“) â‰¾ ğ“Ì‚â‚
  â†’ (lÌ‚ ğ“) â‰º: ğ“Ì‚â‚ â‹ ğ“Ì‚â‚‚
ğ“â‰¾ğ“â‚â†’ğ“â‰º:ğ“â‚â‹ğ“â‚‚ {ğ“} {ğ“Ì‚â‚} Â¿ ğ“â‰¾ğ“â‚ rewrite ğ“â‹Â¿â‰¡Â¿ ğ“Ì‚â‚ = â‰º:-Â¿
ğ“â‰¾ğ“â‚â†’ğ“â‰º:ğ“â‚â‹ğ“â‚‚ {ğ“} {Â¿} (lÌ‚ _) _ = â‰º:-Â¿
ğ“â‰¾ğ“â‚â†’ğ“â‰º:ğ“â‚â‹ğ“â‚‚ {ğ“} {lÌ‚ ğ“â‚} (lÌ‚ ğ“â‚‚) (â‰¾-l ğ“â‰¼ğ“â‚) = â‰º-l (ğ“â‰¼ğ“â‚â†’ğ“â‰¼ğ“â‚âŠ”ğ“â‚‚ ğ“â‚‚ ğ“â‰¼ğ“â‚)

ğ“â‰º:ğ“â‹ğ“â€² : âˆ€ ğ“Ì‚ ğ“Ì‚â€² â†’ ğ“Ì‚ â‰º: ğ“Ì‚ â‹ ğ“Ì‚â€²
ğ“â‰º:ğ“â‹ğ“â€² ğ“Ì‚ Â¿ rewrite ğ“â‹Â¿â‰¡Â¿ ğ“Ì‚ = â‰º:-Â¿
ğ“â‰º:ğ“â‹ğ“â€² Â¿ (lÌ‚ ğ“â€²) = â‰º:-Â¿
ğ“â‰º:ğ“â‹ğ“â€² (lÌ‚ ğ“) (lÌ‚ ğ“â€²) = â‰º-l (ğ“â‰¼ğ“âŠ”ğ“â€² ğ“ ğ“â€²)

-- â‰º: is smaller than â‰¾
ğ“â‰º:ğ“â€²â†’ğ“â‰¾ğ“â€² : âˆ€ {ğ“ ğ“â€²}
  â†’ ğ“ â‰º: ğ“â€²
  â†’ ğ“ â‰¾ ğ“â€²
ğ“â‰º:ğ“â€²â†’ğ“â‰¾ğ“â€² â‰º:-Â¿ = â‰¾-Â¿-r
ğ“â‰º:ğ“â€²â†’ğ“â‰¾ğ“â€² (â‰º-l ğ“â‚â‰¼ğ“â‚‚) = â‰¾-l ğ“â‚â‰¼ğ“â‚‚

-- Consistent subtyping â‰¾ is not transitive; alternatively, we have:
ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ : âˆ€ {ğ“Ì‚â‚ ğ“Ì‚â‚‚ ğ“Ì‚â‚ƒ}
  â†’ ğ“Ì‚â‚ â‰¾ ğ“Ì‚â‚‚
  â†’ ğ“Ì‚â‚‚ â‰º: ğ“Ì‚â‚ƒ
  â†’ ğ“Ì‚â‚ â‰¾ ğ“Ì‚â‚ƒ
ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ â‰¾-Â¿-r â‰º:-Â¿ = â‰¾-Â¿-r
ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ â‰¾-Â¿-l â‰º:-Â¿ = â‰¾-Â¿-r
ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ (â‰¾-l _) â‰º:-Â¿ = â‰¾-Â¿-r
ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ â‰¾-Â¿-l (â‰º-l _) = â‰¾-Â¿-l
ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ {lÌ‚ ğ“â‚} {lÌ‚ ğ“â‚‚} {lÌ‚ ğ“â‚ƒ} (â‰¾-l ğ“â‚â‰¼ğ“â‚‚) (â‰º-l ğ“â‚‚â‰¼ğ“â‚ƒ) = â‰¾-l (â‰¼-trans ğ“â‚â‰¼ğ“â‚‚ ğ“â‚‚â‰¼ğ“â‚ƒ)

-- CastL ğ“Ì‚â‚ â‡› ğ“Ì‚â‚‚ never fails if ğ“Ì‚â‚ â‰º: ğ“Ì‚â‚‚
â‰º:â†’no-blame : âˆ€ {Î¼ pc ğ“Ì‚â‚ ğ“Ì‚â‚‚}
  â†’ (lÌ‚ pc) â‰¾ ğ“Ì‚â‚
  â†’ (ğ“Ì‚â‚â‰º:ğ“Ì‚â‚‚ : ğ“Ì‚â‚ â‰º: ğ“Ì‚â‚‚)
  â†’ castL Î¼ pc ğ“Ì‚â‚ ğ“Ì‚â‚‚ (ğ“â‰º:ğ“â€²â†’ğ“â‰¾ğ“â€² ğ“Ì‚â‚â‰º:ğ“Ì‚â‚‚) â‰¢ error castError
â‰º:â†’no-blame {pc = pc} {ğ“Ì‚â‚} {ğ“Ì‚â‚‚} pcâ‰¾ğ“â‚ ğ“â‚â‰º:ğ“â‚‚
  with (lÌ‚ pc) â‰¾? ğ“Ì‚â‚‚
... | yes pcâ‰¾ğ“â‚‚ = Î» ()
... | no pcâŠ€ğ“â‚‚ = âŠ¥-elim (pcâŠ€ğ“â‚‚ pcâ‰¾ğ“â‚‚)
  where
  pcâ‰¾ğ“â‚‚ = ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ pcâ‰¾ğ“â‚ ğ“â‚â‰º:ğ“â‚‚



infixl 9 _â‰ƒ_

data _â‰ƒ_ : â„’Ì‚ â†’ â„’Ì‚ â†’ Set where

  â‰ƒ-Â¿ : âˆ€ {ğ“Ì‚}
      ------
    â†’ ğ“Ì‚ â‰ƒ Â¿

  â‰ƒ-l : âˆ€ {ğ“}
      ---------------
    â†’ (lÌ‚ ğ“) â‰ƒ (lÌ‚ ğ“)

infixl 9 _<:_

data _<:_ : ğ•‹ â†’ ğ•‹ â†’ Set where

  <:-âŠ¤ : `âŠ¤ <: `âŠ¤

  <:-ğ”¹ : `ğ”¹ <: `ğ”¹

  <:-â„’ : `â„’ <: `â„’

  <:-Ref : âˆ€ {ğ“Ì‚â‚ ğ“Ì‚â‚‚ Tâ‚ Tâ‚‚}
    â†’ ğ“Ì‚â‚ â‰ƒ ğ“Ì‚â‚‚
      -----------------------
    â†’ Ref ğ“Ì‚â‚ Tâ‚ <: Ref ğ“Ì‚â‚‚ Tâ‚‚

  <:-Lab : âˆ€ {ğ“Ì‚â‚ ğ“Ì‚â‚‚ Tâ‚ Tâ‚‚}
    â†’ ğ“Ì‚â‚ â‰º: ğ“Ì‚â‚‚
    â†’ Tâ‚ <: Tâ‚‚
      -----------------------
    â†’ Lab ğ“Ì‚â‚ Tâ‚ <: Lab ğ“Ì‚â‚‚ Tâ‚‚

  <:-â‡’ : âˆ€ {ğ“Ì‚â‚ ğ“Ì‚â‚‚ ğ“Ì‚â‚â€² ğ“Ì‚â‚‚â€² Sâ‚ Sâ‚‚ Tâ‚ Tâ‚‚}
    â†’ ğ“Ì‚â‚â€² â‰º: ğ“Ì‚â‚
    â†’ ğ“Ì‚â‚‚ â‰º: ğ“Ì‚â‚‚â€²
    â†’ Tâ‚ <: Sâ‚
    â†’ Sâ‚‚ <: Tâ‚‚
      ---------------------------------------------------
    â†’ (Sâ‚ [ ğ“Ì‚â‚ ]â‡’[ ğ“Ì‚â‚‚ ] Sâ‚‚) <: (Tâ‚ [ ğ“Ì‚â‚â€² ]â‡’[ ğ“Ì‚â‚‚â€² ] Tâ‚‚)
