open import Data.Nat using (â„•; zero; suc; _â‰¤_; zâ‰¤n; sâ‰¤s) renaming (_âŠ”_ to _âŠ”â‚™_; _âŠ“_ to _âŠ“â‚™_; _â‰Ÿ_ to _â‰Ÿâ‚™_)
open import Data.Nat.Properties using (mâ‰¤mâŠ”n)
open import Data.Empty using (âŠ¥; âŠ¥-elim)
open import Data.Product using (_Ã—_; âˆƒ; âˆƒ-syntax; Î£; Î£-syntax; projâ‚; projâ‚‚) renaming (_,_ to âŸ¨_,_âŸ©)
open import Data.Maybe using (Maybe; just; nothing)
open import Data.List using (List; []; _âˆ·_; length)
import Relation.Binary.PropositionalEquality as Eq
open Eq using (_â‰¡_; _â‰¢_; refl; sym; trans; subst; inspect; [_])
open import Relation.Nullary using (Dec; yes; no; Â¬_)

open import StaticsGLIO
import Syntax
open Syntax.OpSig Op sig
  using (`_; _â¦…_â¦†; cons; nil; bind; ast; _[_]; Subst; âŸª_âŸ«; âŸ¦_âŸ§; exts; rename)
  renaming (ABT to Term)
open import Lemmas
open import Interp
open import WellTypedness using (_âŠ¢áµ¥_â¦‚_)
open _âŠ¢áµ¥_â¦‚_
open import Store
open import WellTypedness
open import CastStateIdem
open import InterpSafe



infixl 9 _â‰º:_

data _â‰º:_ : â„’Ì‚ â†’ â„’Ì‚ â†’ Set where

  â‰º:-Â¿ : âˆ€ {ğ“Ì‚}
       ------
    â†’ ğ“Ì‚ â‰º: Â¿

  â‰º:-l : âˆ€ {ğ“â‚ ğ“â‚‚}
    â†’ ğ“â‚ â‰¼ ğ“â‚‚
      -----------------
    â†’ (lÌ‚ ğ“â‚) â‰º: (lÌ‚ ğ“â‚‚)



ğ“â‰¾ğ“â‚â†’ğ“â‰º:ğ“â‚â‹ğ“â‚‚ : âˆ€ {ğ“ ğ“Ì‚â‚}
  â†’ (ğ“Ì‚â‚‚ : â„’Ì‚)
  â†’ (lÌ‚ ğ“) â‰¾ ğ“Ì‚â‚
    -----------------
  â†’ (lÌ‚ ğ“) â‰º: ğ“Ì‚â‚ â‹ ğ“Ì‚â‚‚
ğ“â‰¾ğ“â‚â†’ğ“â‰º:ğ“â‚â‹ğ“â‚‚ {ğ“} {ğ“Ì‚â‚} Â¿ ğ“â‰¾ğ“â‚ rewrite ğ“Ì‚â‹Â¿â‰¡Â¿ ğ“Ì‚â‚ = â‰º:-Â¿
ğ“â‰¾ğ“â‚â†’ğ“â‰º:ğ“â‚â‹ğ“â‚‚ {ğ“} {Â¿} (lÌ‚ _) _ = â‰º:-Â¿
ğ“â‰¾ğ“â‚â†’ğ“â‰º:ğ“â‚â‹ğ“â‚‚ {ğ“} {lÌ‚ ğ“â‚} (lÌ‚ ğ“â‚‚) (â‰¾-l ğ“â‰¼ğ“â‚) = â‰º:-l (ğ“â‰¼ğ“â‚â†’ğ“â‰¼ğ“â‚âŠ”ğ“â‚‚ ğ“â‚‚ ğ“â‰¼ğ“â‚)

ğ“â‰º:ğ“â‹ğ“â€² : âˆ€ ğ“Ì‚ ğ“Ì‚â€² â†’ ğ“Ì‚ â‰º: ğ“Ì‚ â‹ ğ“Ì‚â€²
ğ“â‰º:ğ“â‹ğ“â€² ğ“Ì‚ Â¿ rewrite ğ“Ì‚â‹Â¿â‰¡Â¿ ğ“Ì‚ = â‰º:-Â¿
ğ“â‰º:ğ“â‹ğ“â€² Â¿ (lÌ‚ ğ“â€²) = â‰º:-Â¿
ğ“â‰º:ğ“â‹ğ“â€² (lÌ‚ ğ“) (lÌ‚ ğ“â€²) = â‰º:-l (ğ“â‰¼ğ“âŠ”ğ“â€² ğ“ ğ“â€²)

-- â‰º: is smaller than â‰¾
â‰º:â†’â‰¾ : âˆ€ {ğ“ ğ“â€²}
  â†’ ğ“ â‰º: ğ“â€²
    --------
  â†’ ğ“ â‰¾ ğ“â€²
â‰º:â†’â‰¾ â‰º:-Â¿ = â‰¾-Â¿-r
â‰º:â†’â‰¾ (â‰º:-l ğ“â‚â‰¼ğ“â‚‚) = â‰¾-l ğ“â‚â‰¼ğ“â‚‚

-- Consistent subtyping â‰¾ is not transitive; alternatively, we have:
ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ : âˆ€ {ğ“Ì‚â‚ ğ“Ì‚â‚‚ ğ“Ì‚â‚ƒ}
  â†’ ğ“Ì‚â‚ â‰¾ ğ“Ì‚â‚‚
  â†’ ğ“Ì‚â‚‚ â‰º: ğ“Ì‚â‚ƒ
    ---------
  â†’ ğ“Ì‚â‚ â‰¾ ğ“Ì‚â‚ƒ
ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ â‰¾-Â¿-r â‰º:-Â¿ = â‰¾-Â¿-r
ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ â‰¾-Â¿-l â‰º:-Â¿ = â‰¾-Â¿-r
ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ (â‰¾-l _) â‰º:-Â¿ = â‰¾-Â¿-r
ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ â‰¾-Â¿-l (â‰º:-l _) = â‰¾-Â¿-l
ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ {lÌ‚ ğ“â‚} {lÌ‚ ğ“â‚‚} {lÌ‚ ğ“â‚ƒ} (â‰¾-l ğ“â‚â‰¼ğ“â‚‚) (â‰º:-l ğ“â‚‚â‰¼ğ“â‚ƒ) = â‰¾-l (â‰¼-trans ğ“â‚â‰¼ğ“â‚‚ ğ“â‚‚â‰¼ğ“â‚ƒ)

-- CastL ğ“Ì‚â‚ â‡› ğ“Ì‚â‚‚ never fails if ğ“Ì‚â‚ â‰º: ğ“Ì‚â‚‚
â‰º:â†’no-blame : âˆ€ {Î¼ pc ğ“Ì‚â‚ ğ“Ì‚â‚‚}
  â†’ (lÌ‚ pc) â‰¾ ğ“Ì‚â‚
  â†’ (ğ“Ì‚â‚â‰º:ğ“Ì‚â‚‚ : ğ“Ì‚â‚ â‰º: ğ“Ì‚â‚‚)
    --------------------------------------------------
  â†’ castL Î¼ pc ğ“Ì‚â‚ ğ“Ì‚â‚‚ (â‰º:â†’â‰¾ ğ“Ì‚â‚â‰º:ğ“Ì‚â‚‚) â‰¡ result âŸ¨ Î¼ , V-tt , pc âŸ©
â‰º:â†’no-blame {pc = pc} {ğ“Ì‚â‚} {ğ“Ì‚â‚‚} pcâ‰¾ğ“â‚ ğ“â‚â‰º:ğ“â‚‚
  with (lÌ‚ pc) â‰¾? ğ“Ì‚â‚‚
... | yes pcâ‰¾ğ“â‚‚ = refl
... | no pcâŠ€ğ“â‚‚ = âŠ¥-elim (pcâŠ€ğ“â‚‚ pcâ‰¾ğ“â‚‚)
  where
  pcâ‰¾ğ“â‚‚ = ğ“â‚â‰¾ğ“â‚‚â†’ğ“â‚‚â‰º:ğ“â‚ƒâ†’ğ“â‚â‰¾ğ“â‚ƒ pcâ‰¾ğ“â‚ ğ“â‚â‰º:ğ“â‚‚



infixl 9 _â‰‚_

data _â‰‚_ : â„’Ì‚ â†’ â„’Ì‚ â†’ Set where

  â‰‚-Â¿ : âˆ€ {ğ“Ì‚}
      ------
    â†’ ğ“Ì‚ â‰‚ Â¿

  â‰‚-l : âˆ€ {ğ“}
      ---------------
    â†’ (lÌ‚ ğ“) â‰‚ (lÌ‚ ğ“)

infixl 9 _<:_

data _<:_ : ğ•‹ â†’ ğ•‹ â†’ Set where

  <:-âŠ¤ : `âŠ¤ <: `âŠ¤

  <:-ğ”¹ : `ğ”¹ <: `ğ”¹

  <:-â„’ : `â„’ <: `â„’

  <:-Ref : âˆ€ {ğ“Ì‚â‚ ğ“Ì‚â‚‚ Tâ‚ Tâ‚‚}
    â†’ ğ“Ì‚â‚ â‰‚ ğ“Ì‚â‚‚
    â†’ Tâ‚ â‰² Tâ‚‚ â†’ Tâ‚‚ â‰² Tâ‚
      -----------------------
    â†’ Ref ğ“Ì‚â‚ Tâ‚ <: Ref ğ“Ì‚â‚‚ Tâ‚‚

  <:-Lab : âˆ€ {ğ“Ì‚â‚ ğ“Ì‚â‚‚ Tâ‚ Tâ‚‚}
    â†’ ğ“Ì‚â‚ â‰º: ğ“Ì‚â‚‚
    â†’ Tâ‚ <: Tâ‚‚
      -----------------------
    â†’ Lab ğ“Ì‚â‚ Tâ‚ <: Lab ğ“Ì‚â‚‚ Tâ‚‚

  <:-â‡’ : âˆ€ {ğ“Ì‚â‚ ğ“Ì‚â‚‚ ğ“Ì‚â‚â€² ğ“Ì‚â‚‚â€² Sâ‚ Sâ‚‚ Tâ‚ Tâ‚‚}
    â†’ ğ“Ì‚â‚â€² â‰º: ğ“Ì‚â‚
    â†’ ğ“Ì‚â‚‚ â‰º: ğ“Ì‚â‚‚â€²
    â†’ Tâ‚ <: Sâ‚
    â†’ Sâ‚‚ <: Tâ‚‚
      ---------------------------------------------------
    â†’ (Sâ‚ [ ğ“Ì‚â‚ ]â‡’[ ğ“Ì‚â‚‚ ] Sâ‚‚) <: (Tâ‚ [ ğ“Ì‚â‚â€² ]â‡’[ ğ“Ì‚â‚‚â€² ] Tâ‚‚)



â‰‚â†’â‰¾ : âˆ€ {ğ“Ì‚â‚ ğ“Ì‚â‚‚}
  â†’ ğ“Ì‚â‚ â‰‚ ğ“Ì‚â‚‚
    ------------------
  â†’ ğ“Ì‚â‚ â‰¾ ğ“Ì‚â‚‚ Ã— ğ“Ì‚â‚‚ â‰¾ ğ“Ì‚â‚
â‰‚â†’â‰¾ â‰‚-Â¿ = âŸ¨ â‰¾-Â¿-r , â‰¾-Â¿-l âŸ©
â‰‚â†’â‰¾ â‰‚-l = âŸ¨ â‰¾-refl _ , â‰¾-refl _ âŸ©

-- <: is smaller than â‰²
<:â†’â‰² : âˆ€ {Tâ‚ Tâ‚‚}
  â†’ Tâ‚ <: Tâ‚‚
    ----------
  â†’ Tâ‚ â‰² Tâ‚‚
<:â†’â‰² <:-âŠ¤ = â‰²-âŠ¤
<:â†’â‰² <:-ğ”¹ = â‰²-ğ”¹
<:â†’â‰² <:-â„’ = â‰²-â„’
<:â†’â‰² (<:-Ref ğ“â‚â‰‚ğ“â‚‚ Tâ‚â‰²Tâ‚‚ Tâ‚‚â‰²Tâ‚) =
  let âŸ¨ ğ“â‚â‰¾ğ“â‚‚ , ğ“â‚‚â‰¾ğ“â‚ âŸ© = â‰‚â†’â‰¾ ğ“â‚â‰‚ğ“â‚‚ in
    â‰²-Ref ğ“â‚â‰¾ğ“â‚‚ ğ“â‚‚â‰¾ğ“â‚ Tâ‚â‰²Tâ‚‚ Tâ‚‚â‰²Tâ‚
<:â†’â‰² (<:-Lab ğ“â‚â‰º:ğ“â‚‚ Tâ‚<:Tâ‚‚) = â‰²-Lab (â‰º:â†’â‰¾ ğ“â‚â‰º:ğ“â‚‚) (<:â†’â‰² Tâ‚<:Tâ‚‚)
<:â†’â‰² (<:-â‡’ ğ“â‚â€²â‰º:ğ“â‚ ğ“â‚‚â‰º:ğ“â‚‚â€² Tâ‚<:Sâ‚ Sâ‚‚<:Tâ‚‚) = â‰²-â‡’ (â‰º:â†’â‰¾ ğ“â‚â€²â‰º:ğ“â‚) (â‰º:â†’â‰¾ ğ“â‚‚â‰º:ğ“â‚‚â€²) (<:â†’â‰² Tâ‚<:Sâ‚) (<:â†’â‰² Sâ‚‚<:Tâ‚‚)

-- Cast Tâ‚ â‡› Tâ‚‚ never fails if Tâ‚ <: Tâ‚‚
<:â†’no-blame : âˆ€ {Î¼ pc Tâ‚ Tâ‚‚ v}
  â†’ Î¼ âŠ¢áµ¥ v â¦‚ Tâ‚
  â†’ (Tâ‚<:Tâ‚‚ : Tâ‚ <: Tâ‚‚)
    ------------------------------------------------------------------
  â†’ âˆƒ[ w ] (castTâ€² Î¼ pc Tâ‚ Tâ‚‚ (<:â†’â‰² Tâ‚<:Tâ‚‚) v â‰¡ result âŸ¨ Î¼ , w , pc âŸ©)
<:â†’no-blame âŠ¢áµ¥tt <:-âŠ¤ = âŸ¨ V-tt , refl âŸ©
<:â†’no-blame âŠ¢áµ¥true <:-ğ”¹ = âŸ¨ V-true , refl âŸ©
<:â†’no-blame âŠ¢áµ¥false <:-ğ”¹ = âŸ¨ V-false , refl âŸ©
<:â†’no-blame âŠ¢áµ¥label <:-â„’ = âŸ¨ V-label _ , refl âŸ©
<:â†’no-blame (âŠ¢áµ¥ref _) (<:-Ref â‰‚-Â¿ Tâ‚â‰²Tâ‚‚ Tâ‚‚â‰²Tâ‚) = âŸ¨ V-ref _ , refl âŸ©
<:â†’no-blame (âŠ¢áµ¥ref _) (<:-Ref {ğ“Ì‚â‚‚ = lÌ‚ ğ“â‚‚} â‰‚-l Tâ‚â‰²Tâ‚‚ Tâ‚‚â‰²Tâ‚)
  with ğ“â‚‚ â‰Ÿ ğ“â‚‚
... | yes _ = âŸ¨ V-ref _ , refl âŸ©
... | no ğ“â‚‚â‰¢ğ“â‚‚ = âŠ¥-elim (ğ“â‚‚â‰¢ğ“â‚‚ refl)
<:â†’no-blame (âŠ¢áµ¥ref-dyn _) (<:-Ref â‰‚-Â¿ Tâ‚â‰²Tâ‚‚ Tâ‚‚â‰²Tâ‚) = âŸ¨ V-ref _ , refl âŸ©
<:â†’no-blame {pc = pc} (âŠ¢áµ¥lab {ğ“ = ğ“} ğ“â‰¼ğ“â€² âŠ¢v) (<:-Lab â‰º:-Â¿ Tâ‚<:Tâ‚‚)
  with <:â†’no-blame {pc = pc} âŠ¢v Tâ‚<:Tâ‚‚
... | âŸ¨ w , eq âŸ© rewrite eq = âŸ¨ V-lab ğ“ w , refl âŸ©
<:â†’no-blame {pc = pc} (âŠ¢áµ¥lab {ğ“ = ğ“} ğ“â‰¼ğ“â€² âŠ¢v) (<:-Lab (â‰º:-l {ğ“â‚‚ = ğ“â‚‚} ğ“µâ€²â‰¼ğ“â‚‚) Tâ‚<:Tâ‚‚)
  with ğ“ â‰¼? ğ“â‚‚
... | no ğ“âŠ€ğ“â‚‚ = âŠ¥-elim (ğ“âŠ€ğ“â‚‚ ğ“â‰¼ğ“â‚‚)
  where
  ğ“â‰¼ğ“â‚‚ = â‰¼-trans ğ“â‰¼ğ“â€² ğ“µâ€²â‰¼ğ“â‚‚
... | yes _ with <:â†’no-blame {pc = pc} âŠ¢v Tâ‚<:Tâ‚‚
...   | âŸ¨ w , eq âŸ© rewrite eq = âŸ¨ V-lab ğ“ w , refl âŸ©
<:â†’no-blame {pc = pc} (âŠ¢áµ¥lab-dyn âŠ¢v) (<:-Lab â‰º:-Â¿ Tâ‚<:Tâ‚‚) with <:â†’no-blame {pc = pc} âŠ¢v Tâ‚<:Tâ‚‚
... | âŸ¨ w , eq âŸ© rewrite eq = âŸ¨ V-lab _ w , refl âŸ©
<:â†’no-blame (âŠ¢áµ¥clos _ _) (<:-â‡’ _ _ _ _) = âŸ¨ V-proxy _ _ _ _ _ _ _ _ _ _ _ _ _ , refl âŸ©
<:â†’no-blame (âŠ¢áµ¥proxy _) (<:-â‡’ _ _ _ _) = âŸ¨ V-proxy _ _ _ _ _ _ _ _ _ _ _ _ _ , refl âŸ©

private
  timeoutâ‰¢result : âˆ€ {conf : Conf} â†’ timeout â‰¢ result conf
  timeoutâ‰¢result ()

  errorâ‰¢result : âˆ€ {err} {conf : Conf} â†’ error err â‰¢ result conf
  errorâ‰¢result ()

  resultâ‰¡â†’ğ“á¶œâ‰¡ : âˆ€ {Î¼â‚ Î¼â‚‚ : Store} {vâ‚ vâ‚‚ : Value} {ğ“á¶œâ‚ ğ“á¶œâ‚‚ : â„’}
    â†’ result âŸ¨ Î¼â‚ , vâ‚ , ğ“á¶œâ‚ âŸ© â‰¡ result âŸ¨ Î¼â‚‚ , vâ‚‚ , ğ“á¶œâ‚‚ âŸ©
    â†’ ğ“á¶œâ‚ â‰¡ ğ“á¶œâ‚‚
  resultâ‰¡â†’ğ“á¶œâ‰¡ resâ‰¡ =
    let confâ‚â‰¡confâ‚‚ = result-â‰¡-inv resâ‰¡ in
    let cdrâ‚â‰¡cdrâ‚‚ = projâ‚‚ (Ã—-â‰¡-inv confâ‚â‰¡confâ‚‚) in
      projâ‚‚ (Ã—-â‰¡-inv cdrâ‚â‰¡cdrâ‚‚)

  castLâ†’ğ“á¶œâ‰¡ : âˆ€ {Î¼â‚ Î¼â‚‚ ğ“á¶œâ‚ ğ“á¶œâ‚‚ ğ“Ì‚â‚ ğ“Ì‚â‚‚ v}
    â†’ (ğ“Ì‚â‚â‰¾ğ“Ì‚â‚‚ : ğ“Ì‚â‚ â‰¾ ğ“Ì‚â‚‚)
    â†’ castL Î¼â‚ ğ“á¶œâ‚ ğ“Ì‚â‚ ğ“Ì‚â‚‚ ğ“Ì‚â‚â‰¾ğ“Ì‚â‚‚ â‰¡ result âŸ¨ Î¼â‚‚ , v , ğ“á¶œâ‚‚ âŸ©
    â†’ ğ“á¶œâ‚ â‰¡ ğ“á¶œâ‚‚
  castLâ†’ğ“á¶œâ‰¡ {ğ“á¶œâ‚ = ğ“á¶œâ‚} {ğ“Ì‚â‚ = ğ“Ì‚â‚} {ğ“Ì‚â‚‚} ğ“â‚â‰¾ğ“â‚‚ eq with (lÌ‚ ğ“á¶œâ‚) â‰¾? ğ“Ì‚â‚‚
  ... | yes _ = resultâ‰¡â†’ğ“á¶œâ‰¡ eq
  ... | no  _ = âŠ¥-elim (errorâ‰¢result eq)

  castTâ€²â†’ğ“á¶œâ‰¡ : âˆ€ {Î¼â‚ Î¼â‚‚ ğ“á¶œâ‚ ğ“á¶œâ‚‚ vâ‚‚ Tâ‚ Tâ‚‚}
    â†’ (Tâ‚â‰²Tâ‚‚ : Tâ‚ â‰² Tâ‚‚)
    â†’ (vâ‚ : Value)
    â†’ castTâ€² Î¼â‚ ğ“á¶œâ‚ Tâ‚ Tâ‚‚ Tâ‚â‰²Tâ‚‚ vâ‚ â‰¡ result âŸ¨ Î¼â‚‚ , vâ‚‚ , ğ“á¶œâ‚‚ âŸ©
    â†’ ğ“á¶œâ‚ â‰¡ ğ“á¶œâ‚‚
  castTâ€²â†’ğ“á¶œâ‰¡ â‰²-âŠ¤ V-tt eq = resultâ‰¡â†’ğ“á¶œâ‰¡ eq
  castTâ€²â†’ğ“á¶œâ‰¡ â‰²-ğ”¹ V-true eq = resultâ‰¡â†’ğ“á¶œâ‰¡ eq
  castTâ€²â†’ğ“á¶œâ‰¡ â‰²-ğ”¹ V-false eq = resultâ‰¡â†’ğ“á¶œâ‰¡ eq
  castTâ€²â†’ğ“á¶œâ‰¡ â‰²-â„’ (V-label _) eq = resultâ‰¡â†’ğ“á¶œâ‰¡ eq
  castTâ€²â†’ğ“á¶œâ‰¡ (â‰²-Ref {ğ“Ì‚â‚‚ = ğ“Ì‚â‚‚} _ _ _ _) (V-ref âŸ¨ _ , _ , ğ“â‚‚ âŸ©) eq with ğ“Ì‚â‚‚
  ... | Â¿ = resultâ‰¡â†’ğ“á¶œâ‰¡ eq
  ... | (lÌ‚ ğ“â‚‚â€²) with ğ“â‚‚ â‰Ÿ ğ“â‚‚â€²
  ...   | yes _ = resultâ‰¡â†’ğ“á¶œâ‰¡ eq
  ...   | no  _ = âŠ¥-elim (errorâ‰¢result eq)
  castTâ€²â†’ğ“á¶œâ‰¡ {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (â‰²-Lab {ğ“Ì‚â‚‚ = ğ“Ì‚â‚‚} _ Tâ‚â‰²Tâ‚‚) (V-lab ğ“ v) eq with (lÌ‚ ğ“) â‰¾? ğ“Ì‚â‚‚
  ... | no _ = âŠ¥-elim (errorâ‰¢result eq)
  ... | yes _ with castTâ€² Î¼â‚ ğ“á¶œâ‚ _ _ Tâ‚â‰²Tâ‚‚ v | inspect (Î» v â†’ castTâ€² Î¼â‚ ğ“á¶œâ‚ _ _ Tâ‚â‰²Tâ‚‚ v) v
  ...   | result âŸ¨ Î¼â€² , vâ€² , ğ“á¶œâ€² âŸ© | [ eqâ‚ ] =
    let ğ“á¶œâ‚â‰¡ğ“á¶œâ€² = castTâ€²â†’ğ“á¶œâ‰¡ Tâ‚â‰²Tâ‚‚ v eqâ‚ in
    let ğ“á¶œâ€²â‰¡ğ“á¶œâ‚‚ = resultâ‰¡â†’ğ“á¶œâ‰¡ eq in
      trans ğ“á¶œâ‚â‰¡ğ“á¶œâ€² ğ“á¶œâ€²â‰¡ğ“á¶œâ‚‚
  ...   | error err | _ = âŠ¥-elim (errorâ‰¢result eq)
  ...   | timeout | _ = âŠ¥-elim (timeoutâ‰¢result eq)
  castTâ€²â†’ğ“á¶œâ‰¡ (â‰²-â‡’ _ _ _ _) (V-clos _) eq = resultâ‰¡â†’ğ“á¶œâ‰¡ eq
  castTâ€²â†’ğ“á¶œâ‰¡ (â‰²-â‡’ _ _ _ _) (V-proxy _ _ _ _ _ _ _ _  _ _ _ _ _) eq = resultâ‰¡â†’ğ“á¶œâ‰¡ eq

  castTâ†’ğ“á¶œâ‰¡ : âˆ€ {Î¼â‚ Î¼â‚‚ ğ“á¶œâ‚ ğ“á¶œâ‚‚ vâ‚‚ Tâ‚ Tâ‚‚}
    â†’ (vâ‚ : Value)
    â†’ castT Î¼â‚ ğ“á¶œâ‚ Tâ‚ Tâ‚‚ vâ‚ â‰¡ result âŸ¨ Î¼â‚‚ , vâ‚‚ , ğ“á¶œâ‚‚ âŸ©
    â†’ ğ“á¶œâ‚ â‰¡ ğ“á¶œâ‚‚
  castTâ†’ğ“á¶œâ‰¡ {Tâ‚ = Tâ‚} {Tâ‚‚} vâ‚ eq with Tâ‚ â‰²? Tâ‚‚
  ... | yes Tâ‚â‰²Tâ‚‚ = castTâ€²â†’ğ“á¶œâ‰¡ Tâ‚â‰²Tâ‚‚ vâ‚ eq
  ... | no _ = âŠ¥-elim (errorâ‰¢result eq)

ğ’±-pres-pcâ‰² : âˆ€ {Î“ Î³ Î¼â‚ Î¼â‚‚ ğ“á¶œâ‚ ğ“á¶œâ‚‚ ğ“Ì‚â‚ ğ“Ì‚â‚‚ M v T}
  â†’ (k : â„•)
  â†’ (lÌ‚ ğ“á¶œâ‚) â‰¾ ğ“Ì‚â‚
  â†’ Î¼â‚ âŠ¢â‚› Î¼â‚
  â†’ Î“ âˆ£ Î¼â‚ âŠ¢â‚‘ Î³
  â†’ length Î¼â‚ âˆ‰domâ‚™ Î¼â‚
  â†’ (âŠ¢M : Î“ [ ğ“Ì‚â‚ , ğ“Ì‚â‚‚ ]âŠ¢ M â¦‚ T)
  â†’ ğ’± Î³ M âŠ¢M Î¼â‚ ğ“á¶œâ‚ k â‰¡ result âŸ¨ Î¼â‚‚ , v , ğ“á¶œâ‚‚ âŸ©
    -------------------------------------------
  â†’ (lÌ‚ ğ“á¶œâ‚‚) â‰¾ ğ“Ì‚â‚‚
ğ’±-pres-pcâ‰² 0 _ _ _ _ _ ()
ğ’±-pres-pcâ‰² {Î³ = Î³} (suc k) ğ“á¶œâ‚â‰¾ğ“â‚ _ _ _ (âŠ¢` {x = x} eq) eqâ‚
  with nth Î³ x
... | nothing = âŠ¥-elim (errorâ‰¢result eqâ‚)
... | just _ rewrite sym (resultâ‰¡â†’ğ“á¶œâ‰¡ eqâ‚) = ğ“á¶œâ‚â‰¾ğ“â‚
ğ’±-pres-pcâ‰² (suc k) ğ“á¶œâ‚â‰¾ğ“â‚ _ _ _ âŠ¢tt eq rewrite sym (resultâ‰¡â†’ğ“á¶œâ‰¡ eq) = ğ“á¶œâ‚â‰¾ğ“â‚
ğ’±-pres-pcâ‰² (suc k) ğ“á¶œâ‚â‰¾ğ“â‚ _ _ _ âŠ¢true eq rewrite sym (resultâ‰¡â†’ğ“á¶œâ‰¡ eq) = ğ“á¶œâ‚â‰¾ğ“â‚
ğ’±-pres-pcâ‰² (suc k) ğ“á¶œâ‚â‰¾ğ“â‚ _ _ _ âŠ¢false eq rewrite sym (resultâ‰¡â†’ğ“á¶œâ‰¡ eq) = ğ“á¶œâ‚â‰¾ğ“â‚

ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) ğ“á¶œâ‚â‰¾ğ“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢let {T = T} {Tâ€²} {M = M} {N} {ğ“Ì‚â‚} {ğ“Ì‚â‚‚} {ğ“Ì‚â‚ƒ} âŠ¢M âŠ¢N Tâ€²â‰²T) eq
  with ğ’± Î³ M âŠ¢M Î¼â‚ ğ“á¶œâ‚ k
     | ğ’±-safe {Î“} k ğ“á¶œâ‚ âŠ¢Î¼â‚ fresh âŠ¢Î³ âŠ¢M
     | ğ’±-pres-WFaddr {Î“} {Î³} {Î¼ = Î¼â‚} {ğ“á¶œâ‚} {k} âŠ¢M âŠ¢Î¼â‚ âŠ¢Î³ fresh
     | ğ’±-pres-âŠ¢â‚‘ {pc = ğ“á¶œâ‚} {k} âŠ¢M âŠ¢Î¼â‚ âŠ¢Î³ âŠ¢Î³ fresh
     | inspect (Î» â–¡ â†’ ğ’± Î³ M â–¡ Î¼â‚ ğ“á¶œâ‚ k) âŠ¢M
... | error _ | _ | _ | _ | _ = âŠ¥-elim (errorâ‰¢result eq)
... | result âŸ¨ Î¼â€² , vâ€² , ğ“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ€² | WFresult freshÎ¼â€² | WTenv-result Î¼â€²âŠ¢Î³ | [ eqâ‚ ]
  with castT Î¼â€² ğ“á¶œâ€² Tâ€² T vâ€² | âŠ¢castT {Î¼â€²} {ğ“á¶œâ€²} {Tâ€²} {T} âŠ¢Î¼â€² âŠ¢vâ€² | castT-state-idem {Î¼â€²} {ğ“á¶œâ€²} {Tâ€²} {T} âŠ¢vâ€²
...   | result âŸ¨ Î¼â€³ , vâ€³ , ğ“á¶œâ€³ âŸ© | âŠ¢áµ£result âŠ¢Î¼â€³ âŠ¢vâ€³ | â–¹result Î¼â€²â‰¡Î¼â€³ ğ“á¶œâ€²â‰¡ğ“á¶œâ€³ rewrite (sym Î¼â€²â‰¡Î¼â€³) =
  let ğ“á¶œâ€²â‰¾ğ“â‚‚ = ğ’±-pres-pcâ‰² k ğ“á¶œâ‚â‰¾ğ“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh âŠ¢M eqâ‚ in
  let ğ“á¶œâ€³â‰¾ğ“â‚‚ = subst (Î» â–¡ â†’ lÌ‚ â–¡ â‰¾ ğ“Ì‚â‚‚) ğ“á¶œâ€²â‰¡ğ“á¶œâ€³ ğ“á¶œâ€²â‰¾ğ“â‚‚ in
    ğ’±-pres-pcâ‰² k ğ“á¶œâ€³â‰¾ğ“â‚‚ âŠ¢Î¼â€³ (âŠ¢â‚‘âˆ· âŠ¢vâ€³ Î¼â€²âŠ¢Î³) freshÎ¼â€² âŠ¢N eq


ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) ğ“á¶œâ‚â‰¾ğ“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢if {x = x} _ âŠ¢M âŠ¢N _) eq with nth Î³ x
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢if _ âŠ¢M âŠ¢N _) eq | just V-true
  with ğ’± Î³ _ âŠ¢M Î¼â‚ ğ“á¶œâ‚ k | ğ’±-safe {Î“} k ğ“á¶œâ‚ âŠ¢Î¼â‚ fresh âŠ¢Î³ âŠ¢M | inspect (Î» âŠ¢M â†’ ğ’± Î³ _ âŠ¢M Î¼â‚ ğ“á¶œâ‚ k) âŠ¢M
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if _ âŠ¢M âŠ¢N _) eq
  | just V-true | error _ | _ | _ = âŠ¥-elim (errorâ‰¢result eq)
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if {ğ“Ì‚â‚‚ = ğ“Ì‚â‚‚} {ğ“Ì‚â‚‚â€²} _ âŠ¢M âŠ¢N _) eq
  | just V-true | result âŸ¨ Î¼â€² , vâ‚˜ , ğ“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚˜ | _
  with castL Î¼â€² ğ“á¶œâ€² ğ“Ì‚â‚‚ (ğ“Ì‚â‚‚ â‹ ğ“Ì‚â‚‚â€²) (ğ“Ì‚â‰¾ğ“Ì‚â‹ğ“Ì‚â€² _ _) | castL-state-idem {Î¼â€²} {ğ“á¶œâ€²} {ğ“Ì‚â‚‚} {ğ“Ì‚â‚‚ â‹ ğ“Ì‚â‚‚â€²} (ğ“Ì‚â‰¾ğ“Ì‚â‹ğ“Ì‚â€² _ _)
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if _ âŠ¢M âŠ¢N _) eq
  | just V-true | result âŸ¨ Î¼â€² , vâ‚˜ , ğ“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚˜ | _ | timeout | _ = âŠ¥-elim (timeoutâ‰¢result eq)
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if _ âŠ¢M âŠ¢N _) eq
  | just V-true | result âŸ¨ Î¼â€² , vâ‚˜ , ğ“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚˜ | _ | error _ | _ = âŠ¥-elim (errorâ‰¢result eq)
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if {T = T} {Tâ€²} {Tâ€³} _ âŠ¢M âŠ¢N _) eq
  | just V-true | result âŸ¨ Î¼â€² , vâ‚˜ , ğ“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚˜ | _ | result âŸ¨ Î¼â€³ , _ , ğ“á¶œâ€³ âŸ© | â–¹result Î¼â€²â‰¡Î¼â€³ _
  with castT Î¼â€³ ğ“á¶œâ€³ T Tâ€³ vâ‚˜ | castT-state-idem {Î¼â€³} {ğ“á¶œâ€³} {T} {Tâ€³} Î¼â€³âŠ¢vâ‚˜
  where
  Î¼â€³âŠ¢vâ‚˜ = subst (Î» â–¡ â†’ â–¡ âŠ¢áµ¥ vâ‚˜ â¦‚ _) Î¼â€²â‰¡Î¼â€³ âŠ¢vâ‚˜
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if _ âŠ¢M âŠ¢N _) eq
  | just V-true | result _ | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚˜ | _ | result âŸ¨ Î¼â€³ , _ , ğ“á¶œâ€³ âŸ© | _ | timeout | _ = âŠ¥-elim (timeoutâ‰¢result eq)
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if _ âŠ¢M âŠ¢N _) eq
  | just V-true | result _ | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚˜ | _ | result âŸ¨ Î¼â€³ , _ , ğ“á¶œâ€³ âŸ© | _ | error _ | _ = âŠ¥-elim (errorâ‰¢result eq)
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) ğ“á¶œâ‚â‰¾ğ“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢if {T = T} {Tâ€²} {Tâ€³} {ğ“Ì‚â‚‚ = ğ“Ì‚â‚‚} {ğ“Ì‚â‚‚â€²} _ âŠ¢M âŠ¢N _) eq
  | just V-true | result _ | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚˜ | [ eqâ‚ ] | result _ | â–¹result _ ğ“á¶œâ€²â‰¡ğ“á¶œâ€³ | result _ | â–¹result _ ğ“á¶œâ€³â‰¡ğ“á¶œâ‚‚â€² =
  let ğ“á¶œâ€²â‰¾ğ“â‚‚ = ğ’±-pres-pcâ‰² k ğ“á¶œâ‚â‰¾ğ“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh âŠ¢M eqâ‚ in
  let ğ“á¶œâ‚‚â€²â‰¡ğ“á¶œâ‚‚ = resultâ‰¡â†’ğ“á¶œâ‰¡ eq in
  let ğ“á¶œâ‚‚â‰¾ğ“â‚‚ = subst (Î» â–¡ â†’ lÌ‚ â–¡ â‰¾ ğ“Ì‚â‚‚) (trans ğ“á¶œâ€²â‰¡ğ“á¶œâ€³ (trans ğ“á¶œâ€³â‰¡ğ“á¶œâ‚‚â€² ğ“á¶œâ‚‚â€²â‰¡ğ“á¶œâ‚‚)) ğ“á¶œâ€²â‰¾ğ“â‚‚ in
    ğ“â‰¾ğ“â‚â†’ğ“â‰¾ğ“â‚â‹ğ“â‚‚ ğ“á¶œâ‚‚â‰¾ğ“â‚‚
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢if _ âŠ¢M âŠ¢N _) eq | just V-false
  with ğ’± Î³ _ âŠ¢N Î¼â‚ ğ“á¶œâ‚ k | ğ’±-safe {Î“} k ğ“á¶œâ‚ âŠ¢Î¼â‚ fresh âŠ¢Î³ âŠ¢N | inspect (Î» âŠ¢N â†’ ğ’± Î³ _ âŠ¢N Î¼â‚ ğ“á¶œâ‚ k) âŠ¢N
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if _ âŠ¢M âŠ¢N _) eq
  | just V-false | error _ | _ | _ = âŠ¥-elim (errorâ‰¢result eq)
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if {ğ“Ì‚â‚‚ = ğ“Ì‚â‚‚} {ğ“Ì‚â‚‚â€²} _ âŠ¢M âŠ¢N _) eq
  | just V-false | result âŸ¨ Î¼â€² , vâ‚™ , ğ“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚™ | _
  with castL Î¼â€² ğ“á¶œâ€² ğ“Ì‚â‚‚â€² (ğ“Ì‚â‚‚ â‹ ğ“Ì‚â‚‚â€²) (ğ“Ì‚â‰¾ğ“Ì‚â€²â‹ğ“Ì‚ _ _) | castL-state-idem {Î¼â€²} {ğ“á¶œâ€²} {ğ“Ì‚â‚‚â€²} {ğ“Ì‚â‚‚ â‹ ğ“Ì‚â‚‚â€²} (ğ“Ì‚â‰¾ğ“Ì‚â€²â‹ğ“Ì‚ _ _)
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if _ âŠ¢M âŠ¢N _) eq
  | just V-false | result âŸ¨ Î¼â€² , vâ‚™ , ğ“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚™ | _ | timeout | _ = âŠ¥-elim (timeoutâ‰¢result eq)
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if _ âŠ¢M âŠ¢N _) eq
  | just V-false | result âŸ¨ Î¼â€² , vâ‚™ , ğ“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚™ | _ | error _ | _ = âŠ¥-elim (errorâ‰¢result eq)
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if {T = T} {Tâ€²} {Tâ€³} _ âŠ¢M âŠ¢N _) eq
  | just V-false | result âŸ¨ Î¼â€² , vâ‚™ , ğ“á¶œâ€² âŸ© | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚™ | _ | result âŸ¨ Î¼â€³ , _ , ğ“á¶œâ€³ âŸ© | â–¹result Î¼â€²â‰¡Î¼â€³ _
  with castT Î¼â€³ ğ“á¶œâ€³ Tâ€² Tâ€³ vâ‚™ | castT-state-idem {Î¼â€³} {ğ“á¶œâ€³} {Tâ€²} {Tâ€³} Î¼â€³âŠ¢vâ‚™
  where
  Î¼â€³âŠ¢vâ‚™ = subst (Î» â–¡ â†’ â–¡ âŠ¢áµ¥ vâ‚™ â¦‚ _) Î¼â€²â‰¡Î¼â€³ âŠ¢vâ‚™
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if _ âŠ¢M âŠ¢N _) eq
  | just V-false | result _ | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚™ | _ | result âŸ¨ Î¼â€³ , _ , ğ“á¶œâ€³ âŸ© | _ | timeout | _ = âŠ¥-elim (timeoutâ‰¢result eq)
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) _ _ _ _ (âŠ¢if _ âŠ¢M âŠ¢N _) eq
  | just V-false | result _ | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚™ | _ | result âŸ¨ Î¼â€³ , _ , ğ“á¶œâ€³ âŸ© | _ | error _ | _ = âŠ¥-elim (errorâ‰¢result eq)
ğ’±-pres-pcâ‰² {Î“} {Î³} {Î¼â‚} {Î¼â‚‚} {ğ“á¶œâ‚} (suc k) ğ“á¶œâ‚â‰¾ğ“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh (âŠ¢if {T = T} {Tâ€²} {Tâ€³} {ğ“Ì‚â‚‚ = ğ“Ì‚â‚‚} {ğ“Ì‚â‚‚â€²} _ âŠ¢M âŠ¢N _) eq
  | just V-false | result _ | âŠ¢áµ£result âŠ¢Î¼â€² âŠ¢vâ‚™ | [ eqâ‚ ] | result _ | â–¹result _ ğ“á¶œâ€²â‰¡ğ“á¶œâ€³ | result _ | â–¹result _ ğ“á¶œâ€³â‰¡ğ“á¶œâ‚‚â€² =
  let ğ“á¶œâ€²â‰¾ğ“â‚‚â€² = ğ’±-pres-pcâ‰² k ğ“á¶œâ‚â‰¾ğ“â‚ âŠ¢Î¼â‚ âŠ¢Î³ fresh âŠ¢N eqâ‚ in
  let ğ“á¶œâ‚‚â€²â‰¡ğ“á¶œâ‚‚ = resultâ‰¡â†’ğ“á¶œâ‰¡ eq in
  let ğ“á¶œâ‚‚â‰¾ğ“â‚‚â€² = subst (Î» â–¡ â†’ lÌ‚ â–¡ â‰¾ ğ“Ì‚â‚‚â€²) (trans ğ“á¶œâ€²â‰¡ğ“á¶œâ€³ (trans ğ“á¶œâ€³â‰¡ğ“á¶œâ‚‚â€² ğ“á¶œâ‚‚â€²â‰¡ğ“á¶œâ‚‚)) ğ“á¶œâ€²â‰¾ğ“â‚‚â€² in
    subst (Î» â–¡ â†’ lÌ‚ _ â‰¾ â–¡) (â‹-comm ğ“Ì‚â‚‚â€² ğ“Ì‚â‚‚) (ğ“â‰¾ğ“â‚â†’ğ“â‰¾ğ“â‚â‹ğ“â‚‚ ğ“á¶œâ‚‚â‰¾ğ“â‚‚â€²)


-- ğ’±-pres-pcâ‰² {Î³ = Î³} {Î¼â‚ = Î¼â‚} {ğ“á¶œâ‚ = ğ“á¶œâ‚} {ğ“á¶œâ‚‚} (suc k) ğ“á¶œâ‚â‰¾ğ“â‚ âŠ¢Î³ (âŠ¢get {x = x} _) eq with nth Î³ x | inspect (Î» â–¡ â†’ nth â–¡ x) Î³
-- ... | nothing | _ = âŠ¥-elim (errorâ‰¢result eq)
-- ... | just (V-ref âŸ¨ n , ğ“â‚ , ğ“â‚‚ âŸ©) | [ eqâ‚ ] with lookup Î¼â‚ âŸ¨ n , ğ“â‚ , ğ“â‚‚ âŸ©
-- ...   | just âŸ¨ Tâ€² , v âŸ© = {!!}
-- ...   | nothing = âŠ¥-elim (errorâ‰¢result eq)

-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢set x xâ‚ xâ‚‚ xâ‚ƒ) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢new x xâ‚) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢new-dyn x xâ‚) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢eq-ref x xâ‚ xâ‚‚ xâ‚ƒ) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢Æ› tM) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢Â· x xâ‚ xâ‚‚ xâ‚ƒ) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢ref-label x) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢lab-label x) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ âŠ¢pc-label eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ âŠ¢label eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢â‰¼ x xâ‚) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢âŠ” x xâ‚) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢âŠ“ x xâ‚) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢unlabel x) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢to-label tM x) eq = {!!}
-- ğ’±-pres-pcâ‰² ğ“á¶œâ‰¾ğ“â‚ (âŠ¢to-label-dyn x tM) eq = {!!}
