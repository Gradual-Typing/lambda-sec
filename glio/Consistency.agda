module Consistency where

open import Data.Product using (_Γ—_; projβ‚; projβ‚‚) renaming (_,_ to β¨_,_β©)

open import StaticsGLIO
open import Lemmas using (β‰Ό-refl; β‰Ό-antisym)
open import Iff using (_β‡”_)



-- Consistency for labels
infixl 9 _~_

data _~_ : β„’Μ‚ β†’ β„’Μ‚ β†’ Set where

  ~-ΒΏ-r : β€ {π“Μ‚} β†’ π“Μ‚ ~ ΒΏ

  ~-ΒΏ-l : β€ {π“Μ‚} β†’ ΒΏ ~ π“Μ‚

  ~-l : β€ {π“} β†’ (lΜ‚ π“) ~ (lΜ‚ π“)

-- Consistency for types
infixl 9 _βΌ_

data _βΌ_ : π•‹ β†’ π•‹ β†’ Set where

  βΌ-β¤ : `β¤ βΌ `β¤

  βΌ-π”Ή : `π”Ή βΌ `π”Ή

  βΌ-β„’ : `β„’ βΌ `β„’

  βΌ-Ref : β€ {π“Μ‚β‚ π“Μ‚β‚‚ Tβ‚ Tβ‚‚}
    β†’ π“Μ‚β‚ ~ π“Μ‚β‚‚
    β†’ Tβ‚ βΌ Tβ‚‚
      ----------------------
    β†’ Ref π“Μ‚β‚ Tβ‚ βΌ Ref π“Μ‚β‚‚ Tβ‚‚

  βΌ-Lab : β€ {π“Μ‚β‚ π“Μ‚β‚‚ Tβ‚ Tβ‚‚}
    β†’ π“Μ‚β‚ ~ π“Μ‚β‚‚
    β†’ Tβ‚ βΌ Tβ‚‚
      ----------------------
    β†’ Lab π“Μ‚β‚ Tβ‚ βΌ Lab π“Μ‚β‚‚ Tβ‚‚

  βΌ-β‡’ : β€ {π“Μ‚β‚ π“Μ‚β‚‚ π“Μ‚β‚β€² π“Μ‚β‚‚β€² Sβ‚ Sβ‚‚ Tβ‚ Tβ‚‚}
    β†’ π“Μ‚β‚ ~ π“Μ‚β‚β€²
    β†’ π“Μ‚β‚‚ ~ π“Μ‚β‚‚β€²
    β†’ Sβ‚ βΌ Tβ‚
    β†’ Sβ‚‚ βΌ Tβ‚‚
      ---------------------------------------------------
    β†’ (Sβ‚ [ π“Μ‚β‚ ]β‡’[ π“Μ‚β‚‚ ] Sβ‚‚) βΌ (Tβ‚ [ π“Μ‚β‚β€² ]β‡’[ π“Μ‚β‚‚β€² ] Tβ‚‚)

π“~π“β€²β‡”π“β‰Ύπ“β€²Γ—π“β€²β‰Ύπ“ : β€ π“Μ‚ π“Μ‚β€² β†’ (π“Μ‚ ~ π“Μ‚β€²) β‡” (π“Μ‚ β‰Ύ π“Μ‚β€² Γ— π“Μ‚β€² β‰Ύ π“Μ‚)
π“~π“β€²β‡”π“β‰Ύπ“β€²Γ—π“β€²β‰Ύπ“ π“Μ‚ π“Μ‚β€² = record { to = to ; from = from }
  where
  to : π“Μ‚ ~ π“Μ‚β€² β†’ π“Μ‚ β‰Ύ π“Μ‚β€² Γ— π“Μ‚β€² β‰Ύ π“Μ‚
  to ~-ΒΏ-r = β¨ β‰Ύ-ΒΏ-r , β‰Ύ-ΒΏ-l β©
  to ~-ΒΏ-l = β¨ β‰Ύ-ΒΏ-l , β‰Ύ-ΒΏ-r β©
  to ~-l = β¨ β‰Ύ-l (β‰Ό-refl _) , β‰Ύ-l (β‰Ό-refl _) β©

  from : π“Μ‚ β‰Ύ π“Μ‚β€² Γ— π“Μ‚β€² β‰Ύ π“Μ‚ β†’ π“Μ‚ ~ π“Μ‚β€²
  from β¨ β‰Ύ-ΒΏ-r , _ β© = ~-ΒΏ-r
  from β¨ β‰Ύ-ΒΏ-l , _ β© = ~-ΒΏ-l
  from β¨ β‰Ύ-l π“β‰Όπ“β€² , β‰Ύ-l π“β€²β‰Όπ“ β© rewrite β‰Ό-antisym π“β‰Όπ“β€² π“β€²β‰Όπ“ = ~-l

SβΌTβ‡”Sβ‰²TΓ—Tβ‰²S : β€ S T β†’ (S βΌ T) β‡” (S β‰² T Γ— T β‰² S)
SβΌTβ‡”Sβ‰²TΓ—Tβ‰²S S T = record { to = to ; from = from }
  where
  to : S βΌ T β†’ S β‰² T Γ— T β‰² S
  to βΌ-β¤ = β¨ β‰²-β¤ , β‰²-β¤ β©
  to βΌ-π”Ή = β¨ β‰²-π”Ή , β‰²-π”Ή β©
  to βΌ-β„’ = β¨ β‰²-β„’ , β‰²-β„’ β©
  to (βΌ-Ref π“β‚~π“β‚‚ SβΌT) =
    let β¨ π“β‚β‰Ύπ“β‚‚ , π“β‚‚β‰Ύπ“β‚ β© = _β‡”_.to (π“~π“β€²β‡”π“β‰Ύπ“β€²Γ—π“β€²β‰Ύπ“ _ _) π“β‚~π“β‚‚ in
    let β¨ Tβ‚β‰²Tβ‚‚ , Tβ‚‚β‰²Tβ‚ β© = _β‡”_.to (SβΌTβ‡”Sβ‰²TΓ—Tβ‰²S _ _) SβΌT in
      β¨ β‰²-Ref π“β‚β‰Ύπ“β‚‚ π“β‚‚β‰Ύπ“β‚ Tβ‚β‰²Tβ‚‚ Tβ‚‚β‰²Tβ‚ , β‰²-Ref π“β‚‚β‰Ύπ“β‚ π“β‚β‰Ύπ“β‚‚ Tβ‚‚β‰²Tβ‚ Tβ‚β‰²Tβ‚‚ β©
  to (βΌ-Lab π“β‚~π“β‚‚ SβΌT) =
    let β¨ π“β‚β‰Ύπ“β‚‚ , π“β‚‚β‰Ύπ“β‚ β© = _β‡”_.to (π“~π“β€²β‡”π“β‰Ύπ“β€²Γ—π“β€²β‰Ύπ“ _ _) π“β‚~π“β‚‚ in
    let β¨ Tβ‚β‰²Tβ‚‚ , Tβ‚‚β‰²Tβ‚ β© = _β‡”_.to (SβΌTβ‡”Sβ‰²TΓ—Tβ‰²S _ _) SβΌT in
      β¨ β‰²-Lab π“β‚β‰Ύπ“β‚‚ Tβ‚β‰²Tβ‚‚ , β‰²-Lab π“β‚‚β‰Ύπ“β‚ Tβ‚‚β‰²Tβ‚ β©
  to (βΌ-β‡’ π“β‚~π“β‚β€² π“β‚‚~π“β‚‚β€² Sβ‚βΌTβ‚ Sβ‚‚βΌTβ‚‚) =
    let β¨ π“β‚β‰Ύπ“β‚β€² , π“β‚β€²β‰Ύπ“β‚ β© = _β‡”_.to (π“~π“β€²β‡”π“β‰Ύπ“β€²Γ—π“β€²β‰Ύπ“ _ _) π“β‚~π“β‚β€² in
    let β¨ π“β‚‚β‰Ύπ“β‚‚β€² , π“β‚‚β€²β‰Ύπ“β‚‚ β© = _β‡”_.to (π“~π“β€²β‡”π“β‰Ύπ“β€²Γ—π“β€²β‰Ύπ“ _ _) π“β‚‚~π“β‚‚β€² in
    let β¨ Sβ‚β‰²Tβ‚ , Tβ‚β‰²Sβ‚ β© = _β‡”_.to (SβΌTβ‡”Sβ‰²TΓ—Tβ‰²S _ _) Sβ‚βΌTβ‚ in
    let β¨ Sβ‚‚β‰²Tβ‚‚ , Tβ‚‚β‰²Sβ‚‚ β© = _β‡”_.to (SβΌTβ‡”Sβ‰²TΓ—Tβ‰²S _ _) Sβ‚‚βΌTβ‚‚ in
      β¨ β‰²-β‡’ π“β‚β€²β‰Ύπ“β‚ π“β‚‚β‰Ύπ“β‚‚β€² Tβ‚β‰²Sβ‚ Sβ‚‚β‰²Tβ‚‚ , β‰²-β‡’ π“β‚β‰Ύπ“β‚β€² π“β‚‚β€²β‰Ύπ“β‚‚ Sβ‚β‰²Tβ‚ Tβ‚‚β‰²Sβ‚‚ β©

  from : S β‰² T Γ— T β‰² S β†’ S βΌ T
  from β¨ β‰²-β¤ , β‰²-β¤ β© = βΌ-β¤
  from β¨ β‰²-π”Ή , β‰²-π”Ή β© = βΌ-π”Ή
  from β¨ β‰²-β„’ , β‰²-β„’ β© = βΌ-β„’
  from β¨ β‰²-Ref π“β‚β‰Ύπ“β‚‚ π“β‚‚β‰Ύπ“β‚ Tβ‚β‰²Tβ‚‚ Tβ‚‚β‰²Tβ‚ , β‰²-Ref _ _ _ _ β© =
    let π“β‚~π“β‚‚ = _β‡”_.from (π“~π“β€²β‡”π“β‰Ύπ“β€²Γ—π“β€²β‰Ύπ“ _ _) β¨ π“β‚β‰Ύπ“β‚‚ , π“β‚‚β‰Ύπ“β‚ β© in
    let Tβ‚βΌTβ‚‚ = _β‡”_.from (SβΌTβ‡”Sβ‰²TΓ—Tβ‰²S _ _) β¨ Tβ‚β‰²Tβ‚‚ , Tβ‚‚β‰²Tβ‚ β© in
      βΌ-Ref π“β‚~π“β‚‚ Tβ‚βΌTβ‚‚
  from β¨ β‰²-Lab π“β‚β‰Ύπ“β‚‚ Tβ‚β‰²Tβ‚‚ , β‰²-Lab π“β‚‚β‰Ύπ“β‚ Tβ‚‚β‰²Tβ‚ β© =
    let π“β‚~π“β‚‚ = _β‡”_.from (π“~π“β€²β‡”π“β‰Ύπ“β€²Γ—π“β€²β‰Ύπ“ _ _) β¨ π“β‚β‰Ύπ“β‚‚ , π“β‚‚β‰Ύπ“β‚ β© in
    let Tβ‚βΌTβ‚‚ = _β‡”_.from (SβΌTβ‡”Sβ‰²TΓ—Tβ‰²S _ _) β¨ Tβ‚β‰²Tβ‚‚ , Tβ‚‚β‰²Tβ‚ β© in
      βΌ-Lab π“β‚~π“β‚‚ Tβ‚βΌTβ‚‚
  from β¨ β‰²-β‡’ π“β‚β€²β‰Ύπ“β‚ π“β‚‚β‰Ύπ“β‚‚β€² Tβ‚β€²β‰²Tβ‚ Tβ‚‚β‰²Tβ‚‚β€² , β‰²-β‡’ π“β‚β‰Ύπ“β‚β€² π“β‚‚β€²β‰Ύπ“β‚‚ Tβ‚β‰²Tβ‚β€² Tβ‚‚β€²β‰²Tβ‚‚ β© =
    let π“β‚~π“β‚β€² = _β‡”_.from (π“~π“β€²β‡”π“β‰Ύπ“β€²Γ—π“β€²β‰Ύπ“ _ _) β¨ π“β‚β‰Ύπ“β‚β€² , π“β‚β€²β‰Ύπ“β‚ β© in
    let π“β‚‚~π“β‚‚β€² = _β‡”_.from (π“~π“β€²β‡”π“β‰Ύπ“β€²Γ—π“β€²β‰Ύπ“ _ _) β¨ π“β‚‚β‰Ύπ“β‚‚β€² , π“β‚‚β€²β‰Ύπ“β‚‚ β© in
    let Tβ‚βΌTβ‚β€² = _β‡”_.from (SβΌTβ‡”Sβ‰²TΓ—Tβ‰²S _ _) β¨ Tβ‚β‰²Tβ‚β€² , Tβ‚β€²β‰²Tβ‚ β© in
    let Tβ‚‚βΌTβ‚‚β€² = _β‡”_.from (SβΌTβ‡”Sβ‰²TΓ—Tβ‰²S _ _) β¨ Tβ‚‚β‰²Tβ‚‚β€² , Tβ‚‚β€²β‰²Tβ‚‚ β© in
      βΌ-β‡’ π“β‚~π“β‚β€² π“β‚‚~π“β‚‚β€² Tβ‚βΌTβ‚β€² Tβ‚‚βΌTβ‚‚β€²
