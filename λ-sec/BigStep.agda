module BigStep where

open import Data.Nat using (â„•; zero; suc; _â‰¤_) renaming (_âŠ”_ to _âŠ”â‚™_)
import Relation.Binary.PropositionalEquality as Eq
open Eq using (_â‰¡_; _â‰¢_; refl; sym; cong; congâ‚‚; subst)

open import Statics



Rename : Context â†’ Context â†’ Set
Rename Î“ Î” = âˆ€ {X} â†’ Î“ âˆ‹ X â†’ Î” âˆ‹ X

Subst : Context â†’ Context â†’ Set
Subst Î“ Î” = âˆ€ {X} â†’ Î“ âˆ‹ X â†’ Î” âŠ¢â‚‘ X

-- we first define substitution
-- extension lemma
ext : âˆ€ {Î“ Î” A}
  â†’ Rename Î“ Î”
    ---------------------------------
  â†’ Rename (Î“ , A) (Î” , A)
ext Ï Z      =  Z
ext Ï (S x)  =  S (Ï x)

-- renaming
renameáµ¥ : âˆ€ {Î“ Î”}
  â†’ Rename Î“ Î”
    -----------------------
  â†’ (âˆ€ {A} â†’ Î“ âŠ¢áµ¥ A â†’ Î” âŠ¢áµ¥ A)
renameâ‚‘ : âˆ€ {Î“ Î”}
  â†’ Rename Î“ Î”
    -----------------------
  â†’ (âˆ€ {A} â†’ Î“ âŠ¢â‚‘ A â†’ Î” âŠ¢â‚‘ A)
renameáµ¥ Ï (Æ› N / ğ“)            = Æ› (renameâ‚‘ (ext Ï) N) / ğ“
renameáµ¥ Ï (`true/ ğ“)           = `true/ ğ“
renameáµ¥ Ï (`false/ ğ“)          = `false/ ğ“
renameâ‚‘ Ï (` x)                =  ` (Ï x)
renameâ‚‘ Ï (val v)              =  val (renameáµ¥ Ï v)
renameâ‚‘ Ï (L Â· M)              =  (renameâ‚‘ Ï L) Â· (renameâ‚‘ Ï M)
renameâ‚‘ Ï (if L M N)           =  if (renameâ‚‘ Ï L) (renameâ‚‘ Ï M) (renameâ‚‘ Ï N)
renameâ‚‘ Ï (M `âˆ§ N)             =  (renameâ‚‘ Ï M) `âˆ§ (renameâ‚‘ Ï N)
renameâ‚‘ Ï (M `âˆ¨ N)             =  (renameâ‚‘ Ï M) `âˆ¨ (renameâ‚‘ Ï N)
renameâ‚‘ Ï (sub M âŠ¢â‰¤)           =  sub (renameâ‚‘ Ï M) âŠ¢â‰¤

-- extension (in terms of well-formedness)
exts : âˆ€ {Î“ Î” A}
  â†’ Subst Î“ Î”
    ---------------------------------
  â†’ Subst (Î“ , A) (Î” , A)
exts Ïƒ Z      =  ` Z
exts Ïƒ (S x)  =  renameâ‚‘ S_ (Ïƒ x)

-- substitution
substáµ¥ : âˆ€ {Î“ Î”}
  â†’ Subst Î“ Î”
    -----------------------
  â†’ (âˆ€ {A} â†’ Î“ âŠ¢áµ¥ A â†’ Î” âŠ¢áµ¥ A)
substâ‚‘ : âˆ€ {Î“ Î”}
  â†’ Subst Î“ Î”
    -----------------------
  â†’ (âˆ€ {A} â†’ Î“ âŠ¢â‚‘ A â†’ Î” âŠ¢â‚‘ A)
substáµ¥ Ïƒ (Æ› N / ğ“)          = Æ› (substâ‚‘ (exts Ïƒ) N) / ğ“
substáµ¥ Ïƒ (`true/ ğ“)         = `true/ ğ“
substáµ¥ Ïƒ (`false/ ğ“)        = `false/ ğ“
substâ‚‘ Ïƒ (` k)              =  Ïƒ k
substâ‚‘ Ïƒ (val v)            =  val (substáµ¥ Ïƒ v)
substâ‚‘ Ïƒ (L Â· M)            =  (substâ‚‘ Ïƒ L) Â· (substâ‚‘ Ïƒ M)
substâ‚‘ Ïƒ (if L M N)         =  if (substâ‚‘ Ïƒ L) (substâ‚‘ Ïƒ M) (substâ‚‘ Ïƒ N)
substâ‚‘ Ïƒ (M `âˆ§ N)           =  (substâ‚‘ Ïƒ M) `âˆ§ (substâ‚‘ Ïƒ N)
substâ‚‘ Ïƒ (M `âˆ¨ N)           =  (substâ‚‘ Ïƒ M) `âˆ¨ (substâ‚‘ Ïƒ N)
substâ‚‘ Ïƒ (sub M âŠ¢â‰¤)         =  sub (substâ‚‘ Ïƒ M) âŠ¢â‰¤

_â€¢_ : âˆ€ {Î“ Î” A}
  â†’ Subst Î“ Î”
  â†’ Î” âŠ¢â‚‘ A
  â†’ Subst (Î“ , A) Î”
_â€¢_ Ïƒ M Z = M
_â€¢_ Ïƒ M (S x) = Ïƒ x

Ïƒâ‚€ : âˆ€ {Î“ A} â†’ Î“ âŠ¢â‚‘ A â†’ Subst (Î“ , A) Î“
Ïƒâ‚€ M Z      =  M
Ïƒâ‚€ M (S x)  =  ` x

_[_] : âˆ€ {Î“ A B}
  â†’ Î“ , A âŠ¢â‚‘ B
  â†’ Î“ âŠ¢â‚‘ A
    ---------
  â†’ Î“ âŠ¢â‚‘ B
_[_] {Î“} {A} {B} N M =  substâ‚‘ {Î“ , A} {Î“} (Ïƒâ‚€ M) N

subst-dist-âˆ§ : âˆ€ {Î“ Î” ğ“â‚ ğ“â‚‚}
  â†’ (Ïƒ : Subst Î“ Î”)
  â†’ (M : Î“ âŠ¢â‚‘ `ğ”¹ / ğ“â‚)
  â†’ (N : Î“ âŠ¢â‚‘ `ğ”¹ / ğ“â‚‚)
  â†’ substâ‚‘ Ïƒ (M `âˆ§ N) â‰¡ (substâ‚‘ Ïƒ M) `âˆ§ (substâ‚‘ Ïƒ N)
subst-dist-âˆ§ Ïƒ M N = refl

subst-dist-Â· : âˆ€ {Î“ Î” tâ‚ tâ‚‚ ğ“â‚ ğ“â‚‚ ğ“}
  â†’ (Ïƒ : Subst Î“ Î”)
  â†’ (M : Î“ âŠ¢â‚‘ ((tâ‚ / ğ“â‚) â‡’ (tâ‚‚ / ğ“â‚‚)) / ğ“)
  â†’ (N : Î“ âŠ¢â‚‘ (tâ‚ / ğ“â‚))
  â†’ substâ‚‘ Ïƒ (M Â· N) â‰¡ (substâ‚‘ Ïƒ M) Â· (substâ‚‘ Ïƒ N)
subst-dist-Â· Ïƒ M N = refl


_âŸ¦âˆ§âŸ§_ : âˆ€ {ğ“â‚˜ ğ“â‚™}
      â†’ (M : âˆ… âŠ¢áµ¥ `ğ”¹ / ğ“â‚˜)
      â†’ (N : âˆ… âŠ¢áµ¥ `ğ”¹ / ğ“â‚™)
        -----------------------
      â†’ âˆ… âŠ¢áµ¥ `ğ”¹ / (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ§âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`true/ ğ“â‚˜)  (`true/ ğ“â‚™)   = `true/  (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ§âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`true/ ğ“â‚˜)  (`false/ ğ“â‚™)  = `false/ (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ§âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`false/ ğ“â‚˜) (`true/ ğ“â‚™)   = `false/ (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ§âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`false/ ğ“â‚˜) (`false/ ğ“â‚™)  = `false/ (ğ“â‚˜ âŠ” ğ“â‚™)

_âŸ¦âˆ¨âŸ§_ : âˆ€ {ğ“â‚˜ ğ“â‚™}
      â†’ (M : âˆ… âŠ¢áµ¥ `ğ”¹ / ğ“â‚˜)
      â†’ (N : âˆ… âŠ¢áµ¥ `ğ”¹ / ğ“â‚™)
        -----------------------
      â†’ âˆ… âŠ¢áµ¥ `ğ”¹ / (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ¨âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`true/ ğ“â‚˜)  (`true/ ğ“â‚™)   = `true/  (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ¨âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`true/ ğ“â‚˜)  (`false/ ğ“â‚™)  = `true/  (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ¨âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`false/ ğ“â‚˜) (`true/ ğ“â‚™)   = `true/  (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ¨âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`false/ ğ“â‚˜) (`false/ ğ“â‚™)  = `false/ (ğ“â‚˜ âŠ” ğ“â‚™)


data _â‡“_ : âˆ€ {A} â†’ âˆ… âŠ¢â‚‘ A â†’ âˆ… âŠ¢áµ¥ A â†’ Set where -- only run on closed terms

  -- v â‡“ v
  â‡“-val : âˆ€ {A} {v : âˆ… âŠ¢áµ¥ A}
        --------------
        â†’ (val v) â‡“ v  -- simply get rid of the `val`

  -- binops
  â‡“-âˆ§ : âˆ€ {ğ“â‚˜ ğ“â‚™ Vâ‚˜ Vâ‚™} {M : âˆ… âŠ¢â‚‘ `ğ”¹ / ğ“â‚˜} {N : âˆ… âŠ¢â‚‘ `ğ”¹ / ğ“â‚™}
      â†’ M â‡“ Vâ‚˜
      â†’ N â‡“ Vâ‚™
        ------------------------
      â†’ (M `âˆ§ N) â‡“ (Vâ‚˜ âŸ¦âˆ§âŸ§ Vâ‚™)

  â‡“-âˆ¨ : âˆ€ {ğ“â‚˜ ğ“â‚™ Vâ‚˜ Vâ‚™} {M : âˆ… âŠ¢â‚‘ `ğ”¹ / ğ“â‚˜} {N : âˆ… âŠ¢â‚‘ `ğ”¹ / ğ“â‚™}
      â†’ M â‡“ Vâ‚˜
      â†’ N â‡“ Vâ‚™
        ------------------------
      â†’ (M `âˆ¨ N) â‡“ (Vâ‚˜ âŸ¦âˆ¨âŸ§ Vâ‚™)

  â‡“-condâ‚ : âˆ€ {t ğ“â‚— ğ“ Vâ‚˜} {L : âˆ… âŠ¢â‚‘ `ğ”¹ / ğ“â‚—} {M : âˆ… âŠ¢â‚‘ t / (ğ“ âŠ” ğ“â‚—)} {N : âˆ… âŠ¢â‚‘ t / (ğ“ âŠ” ğ“â‚—)}
      â†’ L â‡“ (`true/ ğ“â‚—)
      â†’ M â‡“ Vâ‚˜
        ------------------------
      â†’ if L M N â‡“ Vâ‚˜  -- note that `Vâ‚˜` already inhebits type `A âŠ”â‚› ğ“â‚—`

  â‡“-condâ‚‚ : âˆ€ {t ğ“â‚— ğ“ Vâ‚™} {L : âˆ… âŠ¢â‚‘ `ğ”¹ / ğ“â‚—} {M : âˆ… âŠ¢â‚‘ t / (ğ“ âŠ” ğ“â‚—)} {N : âˆ… âŠ¢â‚‘ t / (ğ“ âŠ” ğ“â‚—)}
      â†’ L â‡“ (`false/ ğ“â‚—)
      â†’ N â‡“ Vâ‚™
        ------------------------
      â†’ if L M N â‡“ Vâ‚™  -- note that `Vâ‚™` already inhebits type `A âŠ”â‚› ğ“â‚—`

  â‡“-app : âˆ€ {tâ‚ tâ‚‚ ğ“â‚ ğ“â‚‚ ğ“ Vâ‚™ V Mâ€²} {M : âˆ… âŠ¢â‚‘ ((tâ‚ / ğ“â‚) â‡’ (tâ‚‚ / ğ“â‚‚)) / ğ“} {N : âˆ… âŠ¢â‚‘ tâ‚ / ğ“â‚}
      â†’ M â‡“ (Æ› Mâ€² / ğ“)
      â†’ N â‡“ Vâ‚™
      â†’ (Mâ€² [ (val Vâ‚™) ]) â‡“ V
        ------------------------
      â†’ (M Â· N) â‡“ (V âŠ”áµ¥ ğ“)
