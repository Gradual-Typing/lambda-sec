open import Data.Empty
open import Data.Product
  using (Î£; âˆƒ; Î£-syntax; âˆƒ-syntax; _Ã—_; projâ‚; projâ‚‚)
  renaming (_,_ to âŸ¨_,_âŸ©)
open import Data.Nat.Properties
  using (mâŠ”nâ‰¤oâ‡’mâ‰¤o; mâ‰¤nâ‡’mâŠ”nâ‰¡n; mâŠ”nâ‰¤oâ‡’nâ‰¤o)
  renaming (âŠ”-assoc to âŠ”â‚™-assoc)
open import Relation.Nullary using (Dec; yes; no; Â¬_)
open import Relation.Nullary.Negation using (contradiction)
import Relation.Binary.PropositionalEquality as Eq
open Eq using (_â‰¡_; _â‰¢_; refl; sym; cong; congâ‚‚; subst)

open import Statics
open import BigStep


_/_â¦‚_â‰ˆáµ¥â¦…_â¦†_ : (t : ğ•‹) â†’ (â„“ : â„’) â†’ (vâ‚ : âˆ… âŠ¢áµ¥ (t / â„“)) â†’ (Î¶ : â„’) â†’ (vâ‚‚ : âˆ… âŠ¢áµ¥ (t / â„“)) â†’ Set
_/_â¦‚_â‰ˆâ‚‘â¦…_â¦†_ : (t : ğ•‹) â†’ (â„“ : â„’) â†’ (eâ‚ : âˆ… âŠ¢â‚‘ (t / â„“)) â†’ (Î¶ : â„’) â†’ (eâ‚‚ : âˆ… âŠ¢â‚‘ (t / â„“)) â†’ Set

`ğ”¹ / â„“ â¦‚ vâ‚ â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚ = â„“ âŠ‘ Î¶ â†’ vâ‚ â‰¡ vâ‚‚
((tâ‚ / â„“â‚) â‡’ (tâ‚‚ / â„“â‚‚)) / â„“ â¦‚ vâ‚ â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚ =
    â„“ âŠ‘ Î¶
  â†’ (âˆ€ {vâ‚â€² vâ‚‚â€²}
       â†’ tâ‚ / â„“â‚ â¦‚ vâ‚â€² â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚â€²
       â†’ tâ‚‚ / â„“â‚‚ âŠ” â„“ â¦‚ ((val vâ‚) Â· (val vâ‚â€²)) â‰ˆâ‚‘â¦… Î¶ â¦† ((val vâ‚‚) Â· (val vâ‚‚â€²)))

t / â„“ â¦‚ eâ‚ â‰ˆâ‚‘â¦… Î¶ â¦† eâ‚‚ =
  (âˆ€ {vâ‚ vâ‚‚}
    â†’ eâ‚ â‡“ vâ‚
    â†’ eâ‚‚ â‡“ vâ‚‚
    â†’ t / â„“ â¦‚ vâ‚ â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚)


{- Related substitutions, under typing context Î“ -}
_âŠ¢_â‰ˆâ‚›â¦…_â¦†_ : âˆ€ Î“ â†’ Subst Î“ âˆ… â†’ â„’ â†’ Subst Î“ âˆ… â†’ Set
Î“ âŠ¢ Ïƒâ‚ â‰ˆâ‚›â¦… Î¶ â¦† Ïƒâ‚‚ = âˆ€ {t â„“} â†’ (x : Î“ âˆ‹ (t / â„“)) â†’ t / â„“ â¦‚ (Ïƒâ‚ x) â‰ˆâ‚‘â¦… Î¶ â¦† (Ïƒâ‚‚ x)

â‡“â‰¡ : âˆ€ {s v vâ‚ vâ‚‚} â†’ (_â‡“_ {s} (val v) vâ‚) â†’ (_â‡“_ {s} (val v) vâ‚‚) â†’ vâ‚ â‰¡ vâ‚‚
â‡“â‰¡ â‡“-val â‡“-val = refl


postulate
  exts-sub-cons : âˆ€ {Î“ Î” A Aâ€²}
    â†’ (Ïƒ : Subst Î“ Î”)
    â†’ (M : Î“ , Aâ€² âŠ¢â‚‘ A)
    â†’ (N : Î” âŠ¢â‚‘ Aâ€²)
    â†’ (substâ‚‘ (exts Ïƒ) M) [ N ] â‰¡ substâ‚‘ (Ïƒ â€¢ N) M

â‰ˆâ‚›-â€¢ : âˆ€ {Î“ t â„“ Î¶ eâ‚ eâ‚‚}
    â†’ (Ïƒâ‚ : Subst Î“ âˆ…)
    â†’ (Ïƒâ‚‚ : Subst Î“ âˆ…)
    â†’ Î“ âŠ¢ Ïƒâ‚ â‰ˆâ‚›â¦… Î¶ â¦† Ïƒâ‚‚
    â†’ t / â„“ â¦‚ eâ‚ â‰ˆâ‚‘â¦… Î¶ â¦† eâ‚‚
    â†’ (Î“ , t / â„“) âŠ¢ (Ïƒâ‚ â€¢ eâ‚) â‰ˆâ‚›â¦… Î¶ â¦† (Ïƒâ‚‚ â€¢ eâ‚‚)
â‰ˆâ‚›-â€¢ Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚â‰ˆÏƒâ‚‚ eâ‚â‰ˆeâ‚‚ {t} {â„“} Z = eâ‚â‰ˆeâ‚‚
â‰ˆâ‚›-â€¢ {Î“} {Î¶ = Î¶} Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚â‰ˆÏƒâ‚‚ eâ‚â‰ˆeâ‚‚ {t} {â„“} (S x) = Ïƒâ‚â‰ˆÏƒâ‚‚ {t} {â„“} x

â„“âŠ‘â„“â€²â‡’â„“âŠ”â„“â€²â‰¡â„“â€² : âˆ€ {â„“ â„“â€²}
  â†’ â„“ âŠ‘ â„“â€² â†’ â„“ âŠ” â„“â€² â‰¡ â„“â€²
â„“âŠ‘â„“â€²â‡’â„“âŠ”â„“â€²â‰¡â„“â€² {Label n} {Label nâ€²} (âŠ‘-l nâ‰¤nâ€²) = cong Label (mâ‰¤nâ‡’mâŠ”nâ‰¡n nâ‰¤nâ€²)

âŠ”-assoc : âˆ€ {â„“â‚ â„“â‚‚ â„“â‚ƒ}
  â†’ (â„“â‚ âŠ” â„“â‚‚) âŠ” â„“â‚ƒ â‰¡ â„“â‚ âŠ” (â„“â‚‚ âŠ” â„“â‚ƒ)
âŠ”-assoc {Label nâ‚} {Label nâ‚‚} {Label nâ‚ƒ} = cong (Î» â–¡ â†’ Label â–¡) (âŠ”â‚™-assoc nâ‚ nâ‚‚ nâ‚ƒ)

âŠ”áµ¥-assoc : âˆ€ {Î“ t â„“â‚} {v : Î“ âŠ¢áµ¥ t / â„“â‚} {â„“â‚‚ â„“â‚ƒ}
  â†’ (v âŠ”áµ¥ â„“â‚‚) âŠ”áµ¥ â„“â‚ƒ â‰¡ (subst (Î» â–¡ â†’ Î“ âŠ¢áµ¥ t / â–¡) (sym âŠ”-assoc) (v âŠ”áµ¥ (â„“â‚‚ âŠ” â„“â‚ƒ)))
âŠ”áµ¥-assoc {t = `ğ”¹} {â„“â‚} {`true/ â„“â‚} {â„“â‚‚} {â„“â‚ƒ} = cong-true âŠ”-assoc
  where
  cong-true : âˆ€ {Î“ â„“ â„“â€²}
    â†’ (â„“â‰¡â„“â€² : â„“ â‰¡ â„“â€²)
    â†’ `true/ â„“ â‰¡ subst (Î» â–¡ â†’ Î“ âŠ¢áµ¥ `ğ”¹ / â–¡) (sym â„“â‰¡â„“â€²) (`true/ â„“â€²)
  cong-true refl = refl
âŠ”áµ¥-assoc {t = `ğ”¹} {â„“â‚} {`false/ â„“â‚} {â„“â‚‚} {â„“â‚ƒ} = cong-false âŠ”-assoc
  where
  cong-false : âˆ€ {Î“ â„“ â„“â€²}
    â†’ (â„“â‰¡â„“â€² : â„“ â‰¡ â„“â€²)
    â†’ `false/ â„“ â‰¡ subst (Î» â–¡ â†’ Î“ âŠ¢áµ¥ `ğ”¹ / â–¡) (sym â„“â‰¡â„“â€²) (`false/ â„“â€²)
  cong-false refl = refl
âŠ”áµ¥-assoc {t = sâ‚ â‡’ sâ‚‚} {â„“â‚} {Æ› N / â„“â‚} {â„“â‚‚} {â„“â‚ƒ} = cong-Æ› âŠ”-assoc
  where
  cong-Æ› : âˆ€ {Î“ sâ‚ sâ‚‚ â„“ â„“â€²} {N : Î“ , sâ‚ âŠ¢â‚‘ sâ‚‚}
    â†’ (â„“â‰¡â„“â€² : â„“ â‰¡ â„“â€²)
    â†’ Æ› N / â„“ â‰¡ subst (Î» â–¡ â†’ Î“ âŠ¢áµ¥ (sâ‚ â‡’ sâ‚‚) / â–¡) (sym â„“â‰¡â„“â€²) (Æ› N / â„“â€²)
  cong-Æ› refl = refl

cong-label : âˆ€ {t} {â„“ â„“â€² Î¶ : â„’} {vâ‚ vâ‚‚ : âˆ… âŠ¢áµ¥ (t / â„“)} {vâ‚â€² vâ‚‚â€² : âˆ… âŠ¢áµ¥ (t / â„“â€²)}
  â†’ (â„“â‰¡â„“â€² : â„“ â‰¡ â„“â€²)
  â†’ vâ‚ â‰¡ (subst (Î» â–¡ â†’ âˆ… âŠ¢áµ¥ (t / â–¡)) (sym â„“â‰¡â„“â€²) vâ‚â€²)
  â†’ vâ‚‚ â‰¡ (subst (Î» â–¡ â†’ âˆ… âŠ¢áµ¥ (t / â–¡)) (sym â„“â‰¡â„“â€²) vâ‚‚â€²)
  â†’ t / â„“ â¦‚ vâ‚ â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚ â‰¡ t / â„“â€² â¦‚ vâ‚â€² â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚â€²
cong-label refl refl refl = refl

âŠ”-âŠ‘-inv : âˆ€ {â„“â‚ â„“â‚‚ â„“}
  â†’ (â„“â‚ âŠ” â„“â‚‚) âŠ‘ â„“ â†’ (â„“â‚ âŠ‘ â„“) Ã— (â„“â‚‚ âŠ‘ â„“)
âŠ”-âŠ‘-inv {Label nâ‚} {Label nâ‚‚} {Label n} (âŠ‘-l nâ‚âŠ”nâ‚‚â‰¤n) = âŸ¨ left , right âŸ©
  where
  left : _
  left = âŠ‘-l {nâ‚} {n} (mâŠ”nâ‰¤oâ‡’mâ‰¤o nâ‚ nâ‚‚ nâ‚âŠ”nâ‚‚â‰¤n)
  right : _
  right = âŠ‘-l {nâ‚‚} {n} (mâŠ”nâ‰¤oâ‡’nâ‰¤o nâ‚ nâ‚‚ nâ‚âŠ”nâ‚‚â‰¤n)

-- Value stamping âŠ”áµ¥ preserves the logical relation â‰ˆáµ¥ .
value-stamp-pres : âˆ€ {t â„“ Î¶ vâ‚ vâ‚‚}
  â†’ (â„“â€² : â„’)
  â†’ t / â„“ â¦‚ vâ‚ â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚
    -----------------------------------------------
  â†’ t / (â„“ âŠ” â„“â€²) â¦‚ (vâ‚ âŠ”áµ¥ â„“â€²) â‰ˆáµ¥â¦… Î¶ â¦† (vâ‚‚ âŠ”áµ¥ â„“â€²)
value-stamp-pres {â„“ = â„“} {vâ‚ = `true/ â„“} {vâ‚‚ = `true/ â„“} â„“â€² vâ‚â‰ˆvâ‚‚ =
  Î» _ â†’ refl
value-stamp-pres {â„“ = â„“} {vâ‚ = `true/ â„“} {vâ‚‚ = `false/ â„“} â„“â€² vâ‚â‰ˆvâ‚‚ â„“âŠ”â„“â€²âŠ‘Î¶ =
  let â„“âŠ‘Î¶ = projâ‚ (âŠ”-âŠ‘-inv â„“âŠ”â„“â€²âŠ‘Î¶) in
  let trueâ‰¡false = vâ‚â‰ˆvâ‚‚ â„“âŠ‘Î¶ in
    contradiction trueâ‰¡false (Î» ())
value-stamp-pres {â„“ = â„“} {vâ‚ = `false/ â„“} {vâ‚‚ = `true/ â„“} â„“â€² vâ‚â‰ˆvâ‚‚ â„“âŠ”â„“â€²âŠ‘Î¶ =
  let â„“âŠ‘Î¶ = projâ‚ (âŠ”-âŠ‘-inv â„“âŠ”â„“â€²âŠ‘Î¶) in
  let falseâ‰¡true = vâ‚â‰ˆvâ‚‚ â„“âŠ‘Î¶ in
    contradiction falseâ‰¡true (Î» ())
value-stamp-pres {â„“ = â„“} {vâ‚ = `false/ â„“} {vâ‚‚ = `false/ â„“} â„“â€² vâ‚â‰ˆvâ‚‚ =
  Î» _ â†’ refl
value-stamp-pres {(tâ‚ / â„“â‚) â‡’ (tâ‚‚ / â„“â‚‚)} {â„“} {Î¶} {Æ› M / â„“} {Æ› N / â„“} â„“â€² vâ‚â‰ˆvâ‚‚
  with â„“â€² âŠ‘? Î¶ | â„“ âŠ‘? Î¶
... | yes â„“â€²âŠ‘Î¶ | yes â„“âŠ‘Î¶ =
  Î» { â„“âŠ”â„“â€²âŠ‘Î¶ {vâ‚â€²} {vâ‚‚â€²} vâ‚â€²â‰ˆvâ‚‚â€²
      (â‡“-app {V = vâ‚} â‡“-val â‡“-val â‡“vâ‚)
      (â‡“-app {V = vâ‚‚} â‡“-val â‡“-val â‡“vâ‚‚) â†’
    let h = vâ‚â‰ˆvâ‚‚ â„“âŠ‘Î¶ vâ‚â€²â‰ˆvâ‚‚â€² in
    let â‡“vâ‚ƒ = â‡“-app {M = val (Æ› M / â„“)} {N = val vâ‚â€²} â‡“-val â‡“-val â‡“vâ‚ in
    let â‡“vâ‚„ = â‡“-app {M = val (Æ› N / â„“)} {N = val vâ‚‚â€²} â‡“-val â‡“-val â‡“vâ‚‚ in
    let hâ€² = h â‡“vâ‚ƒ â‡“vâ‚„ in
    let hâ€³ = value-stamp-pres â„“â€² hâ€² in
      subst (Î» â–¡ â†’ â–¡) eq hâ€³
  }
  where
  eq : âˆ€ {t â„“â‚ â„“â‚‚ â„“â‚ƒ Î¶} {vâ‚ vâ‚‚ : âˆ… âŠ¢áµ¥ t / â„“â‚}
      â†’ t / (â„“â‚ âŠ” â„“â‚‚) âŠ” â„“â‚ƒ â¦‚ ((vâ‚ âŠ”áµ¥ â„“â‚‚) âŠ”áµ¥ â„“â‚ƒ) â‰ˆáµ¥â¦… Î¶ â¦† ((vâ‚‚ âŠ”áµ¥ â„“â‚‚) âŠ”áµ¥ â„“â‚ƒ) â‰¡
        t / â„“â‚ âŠ” (â„“â‚‚ âŠ” â„“â‚ƒ) â¦‚ (vâ‚ âŠ”áµ¥ (â„“â‚‚  âŠ” â„“â‚ƒ)) â‰ˆáµ¥â¦… Î¶ â¦† (vâ‚‚ âŠ”áµ¥ (â„“â‚‚  âŠ” â„“â‚ƒ))
  eq {t} {â„“â‚} {â„“â‚‚} {â„“â‚ƒ} {Î¶} {vâ‚} {vâ‚‚} =
    cong-label (âŠ”-assoc {â„“â‚} {â„“â‚‚} {â„“â‚ƒ}) âŠ”áµ¥-assoc âŠ”áµ¥-assoc
... | no Â¬â„“â€²âŠ‘Î¶ | yes â„“âŠ‘Î¶ =
  Î» â„“âŠ”â„“â€²âŠ‘Î¶ â†’
    let âŸ¨ _ , â„“â€²âŠ‘Î¶ âŸ© = âŠ”-âŠ‘-inv â„“âŠ”â„“â€²âŠ‘Î¶ in
      contradiction â„“â€²âŠ‘Î¶ Â¬â„“â€²âŠ‘Î¶
... | yes â„“â€²âŠ‘Î¶ | no Â¬â„“âŠ‘Î¶ =
  Î» â„“âŠ”â„“â€²âŠ‘Î¶ â†’
    let âŸ¨ â„“âŠ‘Î¶ , _ âŸ© = âŠ”-âŠ‘-inv â„“âŠ”â„“â€²âŠ‘Î¶ in
      contradiction â„“âŠ‘Î¶ Â¬â„“âŠ‘Î¶
... | no Â¬â„“â€²âŠ‘Î¶ | no Â¬â„“âŠ‘Î¶ =
  Î» â„“âŠ”â„“â€²âŠ‘Î¶ â†’
    let âŸ¨ â„“âŠ‘Î¶ , _ âŸ© = âŠ”-âŠ‘-inv â„“âŠ”â„“â€²âŠ‘Î¶ in
      contradiction â„“âŠ‘Î¶ Â¬â„“âŠ‘Î¶

â‰ˆáµ¥â†’â‰ˆâ‚‘ : âˆ€ {t â„“ Î¶ vâ‚ vâ‚‚}
  â†’ t / â„“ â¦‚ vâ‚ â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚
  â†’ t / â„“ â¦‚ (val vâ‚) â‰ˆâ‚‘â¦… Î¶ â¦† (val vâ‚‚)
â‰ˆáµ¥â†’â‰ˆâ‚‘ vâ‚â‰ˆvâ‚‚ = Î» {â‡“-val â‡“-val â†’ vâ‚â‰ˆvâ‚‚}

{- Fundamental property:
   If Î“ âŠ¢ e : s and Î“ âŠ¢ Ïƒâ‚ â‰ˆÎ¶ Ïƒâ‚‚, Ïƒâ‚(e) â‰ˆÎ¶ Ïƒâ‚‚(e) : s
-}
fundamental : âˆ€ {Î“ t â„“ Î¶}
  â†’ (Ïƒâ‚ : Subst Î“ âˆ…)
  â†’ (Ïƒâ‚‚ : Subst Î“ âˆ…)
  â†’ (e : Î“ âŠ¢â‚‘ (t / â„“))
  â†’ Î“ âŠ¢ Ïƒâ‚ â‰ˆâ‚›â¦… Î¶ â¦† Ïƒâ‚‚
    -----------------------------------------------
  â†’ t / â„“ â¦‚ (substâ‚‘ Ïƒâ‚ e) â‰ˆâ‚‘â¦… Î¶ â¦† (substâ‚‘ Ïƒâ‚‚ e)
fundamental Ïƒâ‚ Ïƒâ‚‚ (` x) Ïƒâ‚â‰ˆÏƒâ‚‚ = Ïƒâ‚â‰ˆÏƒâ‚‚ x
fundamental Ïƒâ‚ Ïƒâ‚‚ (val (`true/ â„“)) Ïƒâ‚â‰ˆÏƒâ‚‚ â‡“-val â‡“-val _ = refl
fundamental Ïƒâ‚ Ïƒâ‚‚ (val (`false/ â„“)) Ïƒâ‚â‰ˆÏƒâ‚‚ â‡“-val â‡“-val _ = refl
fundamental {t = ((tâ‚ / â„“â‚) â‡’ (tâ‚‚ / â„“â‚‚))} Ïƒâ‚ Ïƒâ‚‚ (val (Æ› N / â„“)) Ïƒâ‚â‰ˆÏƒâ‚‚ =
  Î» {â‡“-val â‡“-val â†’ fundamental-Æ› {N = N} Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚â‰ˆÏƒâ‚‚ }
  where
  fundamental-Æ› : âˆ€ {Î“ Î¶ tâ‚ tâ‚‚ â„“â‚ â„“â‚‚ â„“ N}
    â†’ (Ïƒâ‚ Ïƒâ‚‚ : Subst Î“ âˆ…)
    â†’ Î“ âŠ¢ Ïƒâ‚ â‰ˆâ‚›â¦… Î¶ â¦† Ïƒâ‚‚
    â†’ ((tâ‚ / â„“â‚) â‡’ (tâ‚‚ / â„“â‚‚)) / â„“ â¦‚ (Æ› (substâ‚‘ (exts Ïƒâ‚) N) / â„“) â‰ˆáµ¥â¦… Î¶ â¦† (Æ› (substâ‚‘ (exts Ïƒâ‚‚) N) / â„“)
  fundamental-Æ› {Î“} {Î¶} {tâ‚} {tâ‚‚} {â„“â‚} {â„“â‚‚} {â„“} {N} Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚â‰ˆÏƒâ‚‚ = Î» â„“âŠ‘Î¶ {vâ‚â€²} {vâ‚‚â€²} vâ‚â€²â‰ˆvâ‚‚â€² â†’
    Î» { (â‡“-app {V = vâ‚â€³} â‡“-val â‡“-val â‡“vâ‚â€³) (â‡“-app {V = vâ‚‚â€³} â‡“-val â‡“-val â‡“vâ‚‚â€³) â†’
      let Ïƒâ‚â€¢â‰ˆÏƒâ‚‚â€¢ = â‰ˆâ‚›-â€¢ {Î“} {tâ‚} {â„“â‚} {Î¶} {val vâ‚â€²} {val vâ‚‚â€²} Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚â‰ˆÏƒâ‚‚ (â‰ˆáµ¥â†’â‰ˆâ‚‘ vâ‚â€²â‰ˆvâ‚‚â€²)
          Ïƒâ‚â€¢Nâ‡“vâ‚â€³ = (subst (Î» â–¡ â†’ â–¡ â‡“ vâ‚â€³) (exts-sub-cons Ïƒâ‚ N (val vâ‚â€²)) â‡“vâ‚â€³)
          Ïƒâ‚‚â€¢Nâ‡“vâ‚‚â€³ = (subst (Î» â–¡ â†’ â–¡ â‡“ vâ‚‚â€³) (exts-sub-cons Ïƒâ‚‚ N (val vâ‚‚â€²)) â‡“vâ‚‚â€³)
          ih = fundamental {Î¶ = Î¶} (Ïƒâ‚ â€¢ (val vâ‚â€²)) (Ïƒâ‚‚ â€¢ (val vâ‚‚â€²)) N Ïƒâ‚â€¢â‰ˆÏƒâ‚‚â€¢ Ïƒâ‚â€¢Nâ‡“vâ‚â€³ Ïƒâ‚‚â€¢Nâ‡“vâ‚‚â€³ in
        value-stamp-pres â„“ ih }
fundamental {Î¶ = Î¶} Ïƒâ‚ Ïƒâ‚‚ (_Â·_ {tâ‚ = tâ‚} {tâ‚‚} {â„“â‚} {â„“â‚‚} {â„“} L N) Ïƒâ‚â‰ˆÏƒâ‚‚
  (â‡“-app {Vâ‚™ = Vâ‚™â‚} {V = Vâ‚} {Mâ€² = Mâ‚} Ïƒâ‚Lâ‡“Æ›Mâ‚ Ïƒâ‚Nâ‡“Vâ‚™â‚ Mâ‚[Vâ‚™â‚]â‡“Vâ‚) (â‡“-app {Vâ‚™ = Vâ‚™â‚‚} {V = Vâ‚‚} {Mâ€² = Mâ‚‚} Ïƒâ‚‚Lâ‡“Æ›Mâ‚‚ Ïƒâ‚‚Nâ‡“Vâ‚™â‚‚ Mâ‚‚[Vâ‚™â‚‚]â‡“Vâ‚‚)
  with â„“ âŠ‘? Î¶
... | yes â„“âŠ‘Î¶ =
  let Ïƒâ‚Lâ‰ˆÏƒâ‚‚L = fundamental Ïƒâ‚ Ïƒâ‚‚ L Ïƒâ‚â‰ˆÏƒâ‚‚ in
  let Ïƒâ‚Nâ‰ˆÏƒâ‚‚N = fundamental Ïƒâ‚ Ïƒâ‚‚ N Ïƒâ‚â‰ˆÏƒâ‚‚ in
  let Æ›Mâ‚â‰ˆÆ›Mâ‚‚ = Ïƒâ‚Lâ‰ˆÏƒâ‚‚L Ïƒâ‚Lâ‡“Æ›Mâ‚ Ïƒâ‚‚Lâ‡“Æ›Mâ‚‚ in
  let Vâ‚™â‚â‰ˆVâ‚™â‚‚ = Ïƒâ‚Nâ‰ˆÏƒâ‚‚N Ïƒâ‚Nâ‡“Vâ‚™â‚ Ïƒâ‚‚Nâ‡“Vâ‚™â‚‚ in
  let Æ›Mâ‚Â·Vâ‚™â‚â‰ˆÆ›Mâ‚‚Â·Vâ‚™â‚‚ = Æ›Mâ‚â‰ˆÆ›Mâ‚‚ â„“âŠ‘Î¶ Vâ‚™â‚â‰ˆVâ‚™â‚‚ in
  let Æ›Mâ‚Â·Vâ‚™â‚â‡“Vâ‚ = â‡“-app {â„“ = â„“} {Vâ‚™ = Vâ‚™â‚} {V = Vâ‚} {Mâ€² = Mâ‚} â‡“-val â‡“-val Mâ‚[Vâ‚™â‚]â‡“Vâ‚ in
  let Æ›Mâ‚‚Â·Vâ‚™â‚‚â‡“Vâ‚‚ = â‡“-app {â„“ = â„“} {Vâ‚™ = Vâ‚™â‚‚} {V = Vâ‚‚} {Mâ€² = Mâ‚‚} â‡“-val â‡“-val Mâ‚‚[Vâ‚™â‚‚]â‡“Vâ‚‚ in
    Æ›Mâ‚Â·Vâ‚™â‚â‰ˆÆ›Mâ‚‚Â·Vâ‚™â‚‚ Æ›Mâ‚Â·Vâ‚™â‚â‡“Vâ‚ Æ›Mâ‚‚Â·Vâ‚™â‚‚â‡“Vâ‚‚
-- â„“ âŠ‘ Î¶ means that we can see nothing ...
... | no Â¬â„“âŠ‘Î¶ with tâ‚‚
...   | `ğ”¹ = Î» â„“â‚‚âŠ”â„“âŠ‘Î¶ â†’ âŠ¥-elim (Â¬â„“âŠ‘Î¶ (projâ‚‚ (âŠ”-âŠ‘-inv â„“â‚‚âŠ”â„“âŠ‘Î¶)))
...   | (_ / _) â‡’ (_ / _) = Î» â„“â‚‚âŠ”â„“âŠ‘Î¶ â†’ âŠ¥-elim (Â¬â„“âŠ‘Î¶ (projâ‚‚ (âŠ”-âŠ‘-inv â„“â‚‚âŠ”â„“âŠ‘Î¶)))
fundamental {Î¶ = Î¶} Ïƒâ‚ Ïƒâ‚‚ (_`âˆ§_ {â„“â‚ = â„“â‚} {â„“â‚‚} M N) Ïƒâ‚â‰ˆÏƒâ‚‚
  (â‡“-âˆ§ {Vâ‚˜ = Vâ‚˜â‚} {Vâ‚™ = Vâ‚™â‚} Ïƒâ‚Mâ‡“Vâ‚˜â‚ Ïƒâ‚Nâ‡“Vâ‚™â‚) (â‡“-âˆ§ {Vâ‚˜ = Vâ‚˜â‚‚} {Vâ‚™ = Vâ‚™â‚‚} Ïƒâ‚‚Mâ‡“Vâ‚˜â‚‚ Ïƒâ‚‚Nâ‡“Vâ‚™â‚‚)
  with (â„“â‚ âŠ” â„“â‚‚) âŠ‘? Î¶
... | yes â„“â‚âŠ”â„“â‚‚âŠ‘Î¶ =
  let Ïƒâ‚Mâ‰ˆÏƒâ‚‚M = fundamental Ïƒâ‚ Ïƒâ‚‚ M Ïƒâ‚â‰ˆÏƒâ‚‚ in
  let Ïƒâ‚Nâ‰ˆÏƒâ‚‚N = fundamental Ïƒâ‚ Ïƒâ‚‚ N Ïƒâ‚â‰ˆÏƒâ‚‚ in
  let Vâ‚˜â‚â‰ˆVâ‚˜â‚‚ = Ïƒâ‚Mâ‰ˆÏƒâ‚‚M Ïƒâ‚Mâ‡“Vâ‚˜â‚ Ïƒâ‚‚Mâ‡“Vâ‚˜â‚‚ in
  let Vâ‚™â‚â‰ˆVâ‚™â‚‚ = Ïƒâ‚Nâ‰ˆÏƒâ‚‚N Ïƒâ‚Nâ‡“Vâ‚™â‚ Ïƒâ‚‚Nâ‡“Vâ‚™â‚‚ in
  let â„“â‚âŠ‘Î¶ = projâ‚ (âŠ”-âŠ‘-inv â„“â‚âŠ”â„“â‚‚âŠ‘Î¶) in
  let â„“â‚‚âŠ‘Î¶ = projâ‚‚ (âŠ”-âŠ‘-inv â„“â‚âŠ”â„“â‚‚âŠ‘Î¶) in
  let Vâ‚˜â‚â‰¡Vâ‚˜â‚‚ = Vâ‚˜â‚â‰ˆVâ‚˜â‚‚ â„“â‚âŠ‘Î¶ in
  let Vâ‚™â‚â‰¡Vâ‚™â‚‚ = Vâ‚™â‚â‰ˆVâ‚™â‚‚ â„“â‚‚âŠ‘Î¶ in
  Î» _ â†’ congâ‚‚ (Î» â–¡â‚ â–¡â‚‚ â†’ (â–¡â‚ âŸ¦âˆ§âŸ§ â–¡â‚‚)) Vâ‚˜â‚â‰¡Vâ‚˜â‚‚ Vâ‚™â‚â‰¡Vâ‚™â‚‚
... | no Â¬â„“â‚âŠ”â„“â‚‚âŠ‘Î¶ = Î» â„“â‚âŠ”â„“â‚‚âŠ‘Î¶ â†’ âŠ¥-elim (Â¬â„“â‚âŠ”â„“â‚‚âŠ‘Î¶ â„“â‚âŠ”â„“â‚‚âŠ‘Î¶)
fundamental {Î¶ = Î¶} Ïƒâ‚ Ïƒâ‚‚ (_`âˆ¨_ {â„“â‚ = â„“â‚} {â„“â‚‚} M N) Ïƒâ‚â‰ˆÏƒâ‚‚
  (â‡“-âˆ¨ {Vâ‚˜ = Vâ‚˜â‚} {Vâ‚™ = Vâ‚™â‚} Ïƒâ‚Mâ‡“Vâ‚˜â‚ Ïƒâ‚Nâ‡“Vâ‚™â‚) (â‡“-âˆ¨ {Vâ‚˜ = Vâ‚˜â‚‚} {Vâ‚™ = Vâ‚™â‚‚} Ïƒâ‚‚Mâ‡“Vâ‚˜â‚‚ Ïƒâ‚‚Nâ‡“Vâ‚™â‚‚)
  with (â„“â‚ âŠ” â„“â‚‚) âŠ‘? Î¶
... | yes â„“â‚âŠ”â„“â‚‚âŠ‘Î¶ =
  let Ïƒâ‚Mâ‰ˆÏƒâ‚‚M = fundamental Ïƒâ‚ Ïƒâ‚‚ M Ïƒâ‚â‰ˆÏƒâ‚‚ in
  let Ïƒâ‚Nâ‰ˆÏƒâ‚‚N = fundamental Ïƒâ‚ Ïƒâ‚‚ N Ïƒâ‚â‰ˆÏƒâ‚‚ in
  let Vâ‚˜â‚â‰ˆVâ‚˜â‚‚ = Ïƒâ‚Mâ‰ˆÏƒâ‚‚M Ïƒâ‚Mâ‡“Vâ‚˜â‚ Ïƒâ‚‚Mâ‡“Vâ‚˜â‚‚ in
  let Vâ‚™â‚â‰ˆVâ‚™â‚‚ = Ïƒâ‚Nâ‰ˆÏƒâ‚‚N Ïƒâ‚Nâ‡“Vâ‚™â‚ Ïƒâ‚‚Nâ‡“Vâ‚™â‚‚ in
  let â„“â‚âŠ‘Î¶ = projâ‚ (âŠ”-âŠ‘-inv â„“â‚âŠ”â„“â‚‚âŠ‘Î¶) in
  let â„“â‚‚âŠ‘Î¶ = projâ‚‚ (âŠ”-âŠ‘-inv â„“â‚âŠ”â„“â‚‚âŠ‘Î¶) in
  let Vâ‚˜â‚â‰¡Vâ‚˜â‚‚ = Vâ‚˜â‚â‰ˆVâ‚˜â‚‚ â„“â‚âŠ‘Î¶ in
  let Vâ‚™â‚â‰¡Vâ‚™â‚‚ = Vâ‚™â‚â‰ˆVâ‚™â‚‚ â„“â‚‚âŠ‘Î¶ in
  Î» _ â†’ congâ‚‚ (Î» â–¡â‚ â–¡â‚‚ â†’ (â–¡â‚ âŸ¦âˆ¨âŸ§ â–¡â‚‚)) Vâ‚˜â‚â‰¡Vâ‚˜â‚‚ Vâ‚™â‚â‰¡Vâ‚™â‚‚
... | no Â¬â„“â‚âŠ”â„“â‚‚âŠ‘Î¶ = Î» â„“â‚âŠ”â„“â‚‚âŠ‘Î¶ â†’ âŠ¥-elim (Â¬â„“â‚âŠ”â„“â‚‚âŠ‘Î¶ â„“â‚âŠ”â„“â‚‚âŠ‘Î¶)
fundamental {Î¶ = Î¶} Ïƒâ‚ Ïƒâ‚‚ (if {t = t} {â„“} {â„“â€²} L M N) Ïƒâ‚â‰ˆÏƒâ‚‚
  with (â„“ âŠ” â„“â€²) âŠ‘? Î¶
... | yes â„“âŠ”â„“â€²âŠ‘Î¶ = Î» { (â‡“-condâ‚ _ Ïƒâ‚Mâ‡“Vâ‚) (â‡“-condâ‚ _ Ïƒâ‚‚Mâ‡“Vâ‚‚) â†’
        let Ïƒâ‚Mâ‰ˆÏƒâ‚‚M = fundamental Ïƒâ‚ Ïƒâ‚‚ M Ïƒâ‚â‰ˆÏƒâ‚‚ in
          Ïƒâ‚Mâ‰ˆÏƒâ‚‚M Ïƒâ‚Mâ‡“Vâ‚ Ïƒâ‚‚Mâ‡“Vâ‚‚ ;
      (â‡“-condâ‚ Ïƒâ‚Lâ‡“true _) (â‡“-condâ‚‚ Ïƒâ‚‚Lâ‡“false _) â†’
        let Ïƒâ‚Lâ‰ˆÏƒâ‚‚L = fundamental Ïƒâ‚ Ïƒâ‚‚ L Ïƒâ‚â‰ˆÏƒâ‚‚ in
        let trueâ‰ˆfalse = Ïƒâ‚Lâ‰ˆÏƒâ‚‚L Ïƒâ‚Lâ‡“true Ïƒâ‚‚Lâ‡“false in
        let â„“â€²âŠ‘Î¶ = projâ‚‚ (âŠ”-âŠ‘-inv â„“âŠ”â„“â€²âŠ‘Î¶) in
        let trueâ‰¡false = trueâ‰ˆfalse â„“â€²âŠ‘Î¶ in
          contradiction trueâ‰¡false (Î» ()) ;
      (â‡“-condâ‚‚ Ïƒâ‚Lâ‡“false _) (â‡“-condâ‚ Ïƒâ‚‚Lâ‡“true _) â†’
        let Ïƒâ‚Lâ‰ˆÏƒâ‚‚L = fundamental Ïƒâ‚ Ïƒâ‚‚ L Ïƒâ‚â‰ˆÏƒâ‚‚ in
        let falseâ‰ˆtrue = Ïƒâ‚Lâ‰ˆÏƒâ‚‚L Ïƒâ‚Lâ‡“false Ïƒâ‚‚Lâ‡“true in
        let â„“â€²âŠ‘Î¶ = projâ‚‚ (âŠ”-âŠ‘-inv â„“âŠ”â„“â€²âŠ‘Î¶) in
        let falseâ‰¡true = falseâ‰ˆtrue â„“â€²âŠ‘Î¶ in
          contradiction falseâ‰¡true (Î» ()) ;
      (â‡“-condâ‚‚ _ Ïƒâ‚Nâ‡“Vâ‚) (â‡“-condâ‚‚ _ Ïƒâ‚‚Nâ‡“Vâ‚‚) â†’
        let Ïƒâ‚Nâ‰ˆÏƒâ‚‚N = fundamental Ïƒâ‚ Ïƒâ‚‚ N Ïƒâ‚â‰ˆÏƒâ‚‚ in
          Ïƒâ‚Nâ‰ˆÏƒâ‚‚N Ïƒâ‚Nâ‡“Vâ‚ Ïƒâ‚‚Nâ‡“Vâ‚‚}
... | no Â¬â„“âŠ”â„“â€²âŠ‘Î¶ with t
...   | `ğ”¹ = Î» _ _ â„“âŠ”â„“â€²âŠ‘Î¶ â†’ âŠ¥-elim (Â¬â„“âŠ”â„“â€²âŠ‘Î¶ â„“âŠ”â„“â€²âŠ‘Î¶)
...   | (_ / _) â‡’ (_ / _) = Î» _ _ â„“âŠ”â„“â€²âŠ‘Î¶ â†’ âŠ¥-elim (Â¬â„“âŠ”â„“â€²âŠ‘Î¶ â„“âŠ”â„“â€²âŠ‘Î¶)


-- Noninterference is a corollary of the fundamental property.
noninterference : âˆ€ {táµ¢â‚™ tâ‚’áµ¤â‚œ â„“áµ¢â‚™ â„“â‚’áµ¤â‚œ Î¶} {M : âˆ… , táµ¢â‚™ / â„“áµ¢â‚™ âŠ¢â‚‘ tâ‚’áµ¤â‚œ / â„“â‚’áµ¤â‚œ} {Vâ‚ Vâ‚‚ : âˆ… âŠ¢áµ¥ táµ¢â‚™ / â„“áµ¢â‚™}
  â†’ Â¬ â„“áµ¢â‚™  âŠ‘ Î¶
  â†’   â„“â‚’áµ¤â‚œ âŠ‘ Î¶
    --------------------------------------------------------
  â†’ tâ‚’áµ¤â‚œ / â„“â‚’áµ¤â‚œ â¦‚ (M [ (val Vâ‚) ]) â‰ˆâ‚‘â¦… Î¶ â¦† (M [ (val Vâ‚‚) ])
noninterference {táµ¢â‚™} {tâ‚’áµ¤â‚œ} {â„“áµ¢â‚™} {â„“â‚’áµ¤â‚œ} {Î¶} {M} {Vâ‚} {Vâ‚‚} Â¬â„“áµ¢â‚™âŠ‘Î¶ â„“â‚’áµ¤â‚œâŠ‘Î¶ =
  let [Vâ‚]â‰ˆ[Vâ‚‚] = Ïƒâ‚â‰ˆÏƒâ‚‚ {táµ¢â‚™} {â„“áµ¢â‚™} {Î¶} {Vâ‚} {Vâ‚‚} Â¬â„“áµ¢â‚™âŠ‘Î¶ in
    fundamental {Î¶ = Î¶} (Ïƒâ‚€ (val Vâ‚)) (Ïƒâ‚€ (val Vâ‚‚)) M [Vâ‚]â‰ˆ[Vâ‚‚]
  where
  Ïƒâ‚â‰ˆÏƒâ‚‚ : âˆ€ {t â„“ Î¶ Vâ‚ Vâ‚‚} â†’ (Â¬â„“âŠ‘Î¶ : Â¬ â„“ âŠ‘ Î¶) â†’ (âˆ… , t / â„“) âŠ¢ Ïƒâ‚€ (val Vâ‚) â‰ˆâ‚›â¦… Î¶ â¦† Ïƒâ‚€ (val Vâ‚‚)
  Ïƒâ‚â‰ˆÏƒâ‚‚ {t} Â¬â„“âŠ‘Î¶ Z â‡“-val â‡“-val with t
  ... | `ğ”¹ = Î» â„“âŠ‘Î¶ â†’ âŠ¥-elim (Â¬â„“âŠ‘Î¶ â„“âŠ‘Î¶)
  ... | (_ / _) â‡’ (_ / _) = Î» â„“âŠ‘Î¶ â†’ âŠ¥-elim (Â¬â„“âŠ‘Î¶ â„“âŠ‘Î¶)

noninterference-high-and-low :
  âˆ€ {t} {M : âˆ… , t / High âŠ¢â‚‘ `ğ”¹ / Low }
        {Vâ‚ Vâ‚‚ : âˆ… âŠ¢áµ¥ t / High} {Vâ‚â€² Vâ‚‚â€² : âˆ… âŠ¢áµ¥ `ğ”¹ / Low}
  â†’ (M [ (val Vâ‚) ]) â‡“ Vâ‚â€² -- input Vâ‚ â‡’ output Vâ‚â€²
  â†’ (M [ (val Vâ‚‚) ]) â‡“ Vâ‚‚â€² -- input Vâ‚‚ â‡’ output Vâ‚‚â€²
    ----------------------------------------------------
  â†’ Vâ‚â€² â‰¡ Vâ‚‚â€²               -- then they are the same ğ”¹
noninterference-high-and-low {t} {M} {Vâ‚} {Vâ‚‚} {Vâ‚â€²} {Vâ‚‚â€²} =
  let noninterf = noninterference {t} {`ğ”¹} {High} {Low} {Low} {M} {Vâ‚} {Vâ‚‚} (Î» {(âŠ‘-l ())}) âŠ‘-refl in
    Î» M[Vâ‚]â‡“Vâ‚â€² M[Vâ‚‚]â‡“Vâ‚‚â€² â†’ noninterf M[Vâ‚]â‡“Vâ‚â€² M[Vâ‚‚]â‡“Vâ‚‚â€² âŠ‘-refl
