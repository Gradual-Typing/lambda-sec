open import Data.Nat.Properties using (mâŠ”nâ‰¤oâ‡’mâ‰¤o; mâ‰¤nâ‡’mâŠ”nâ‰¡n; mâŠ”nâ‰¤oâ‡’nâ‰¤o) renaming (âŠ”-assoc to âŠ”â‚™-assoc)
open import Data.Empty using (âŠ¥; âŠ¥-elim)
open import Relation.Nullary using (Dec; yes; no; Â¬_)
open import Data.Product using (Î£; âˆƒ; Î£-syntax; âˆƒ-syntax; _Ã—_; projâ‚; projâ‚‚) renaming (_,_ to âŸ¨_,_âŸ©)
import Relation.Binary.PropositionalEquality as Eq
open Eq using (_â‰¡_; _â‰¢_; refl; sym; cong; congâ‚‚; subst)
open Eq.â‰¡-Reasoning using (_â‰¡âŸ¨âŸ©_; _â‰¡âŸ¨_âŸ©_; begin_; _âˆ)

open import Statics
open import BigStep


-- Logical relations: related terms and values.
_/_â¦‚_â‰ˆáµ¥â¦…_â¦†_ : (t : ğ•‹) â†’ (ğ“ : â„’) â†’ (vâ‚ : âˆ… âŠ¢áµ¥ (t / ğ“)) â†’ (Î¶ : â„’) â†’ (vâ‚‚ : âˆ… âŠ¢áµ¥ (t / ğ“)) â†’ Set
_/_â¦‚_â‰ˆâ‚‘â¦…_â¦†_ : (t : ğ•‹) â†’ (ğ“ : â„’) â†’ (eâ‚ : âˆ… âŠ¢â‚‘ (t / ğ“)) â†’ (Î¶ : â„’) â†’ (eâ‚‚ : âˆ… âŠ¢â‚‘ (t / ğ“)) â†’ Set

`ğ”¹ / ğ“ â¦‚ vâ‚ â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚ = ğ“ âŠ‘ Î¶ â†’ vâ‚ â‰¡ vâ‚‚
((tâ‚ / ğ“â‚) â‡’ (tâ‚‚ / ğ“â‚‚)) / ğ“ â¦‚ vâ‚ â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚ =
    ğ“ âŠ‘ Î¶
  â†’ (âˆ€ {vâ‚â€² vâ‚‚â€²}
       â†’ tâ‚ / ğ“â‚ â¦‚ vâ‚â€² â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚â€²
       â†’ tâ‚‚ / ğ“â‚‚ âŠ” ğ“ â¦‚ ((val vâ‚) Â· (val vâ‚â€²)) â‰ˆâ‚‘â¦… Î¶ â¦† ((val vâ‚‚) Â· (val vâ‚‚â€²)))

t / ğ“ â¦‚ eâ‚ â‰ˆâ‚‘â¦… Î¶ â¦† eâ‚‚ =
  (âˆ€ {vâ‚ vâ‚‚}
    â†’ eâ‚ â‡“ vâ‚
    â†’ eâ‚‚ â‡“ vâ‚‚
    â†’ t / ğ“ â¦‚ vâ‚ â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚)


-- Related substitutions under a typing context Î“
_âŠ¢_â‰ˆâ‚›â¦…_â¦†_ : âˆ€ Î“ â†’ Subst Î“ âˆ… â†’ â„’ â†’ Subst Î“ âˆ… â†’ Set
Î“ âŠ¢ Ïƒâ‚ â‰ˆâ‚›â¦… Î¶ â¦† Ïƒâ‚‚ = âˆ€ {t ğ“} â†’ (x : Î“ âˆ‹ (t / ğ“)) â†’ t / ğ“ â¦‚ (Ïƒâ‚ x) â‰ˆâ‚‘â¦… Î¶ â¦† (Ïƒâ‚‚ x)

â‡“â‰¡ : âˆ€ {s v vâ‚ vâ‚‚} â†’ (_â‡“_ {s} (val v) vâ‚) â†’ (_â‡“_ {s} (val v) vâ‚‚) â†’ vâ‚ â‰¡ vâ‚‚
â‡“â‰¡ â‡“-val â‡“-val = refl


-- NOTE: this is proved in the abt library - Tianyu
postulate
  exts-sub-cons : âˆ€ {Î“ Î” A Aâ€²}
    â†’ (Ïƒ : Subst Î“ Î”)
    â†’ (M : Î“ , Aâ€² âŠ¢â‚‘ A)
    â†’ (N : Î” âŠ¢â‚‘ Aâ€²)
    â†’ (substâ‚‘ (exts Ïƒ) M) [ N ] â‰¡ substâ‚‘ (Ïƒ â€¢ N) M

-- Cons â€¢ preserves related substitution â‰ˆâ‚› .
â‰ˆâ‚›-â€¢ : âˆ€ {Î“ t ğ“ Î¶ eâ‚ eâ‚‚}
    â†’ (Ïƒâ‚ : Subst Î“ âˆ…)
    â†’ (Ïƒâ‚‚ : Subst Î“ âˆ…)
    â†’ Î“ âŠ¢ Ïƒâ‚ â‰ˆâ‚›â¦… Î¶ â¦† Ïƒâ‚‚
    â†’ t / ğ“ â¦‚ eâ‚ â‰ˆâ‚‘â¦… Î¶ â¦† eâ‚‚
    â†’ (Î“ , t / ğ“) âŠ¢ (Ïƒâ‚ â€¢ eâ‚) â‰ˆâ‚›â¦… Î¶ â¦† (Ïƒâ‚‚ â€¢ eâ‚‚)
â‰ˆâ‚›-â€¢ Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚â‰ˆÏƒâ‚‚ eâ‚â‰ˆeâ‚‚ {t} {ğ“} Z = eâ‚â‰ˆeâ‚‚
â‰ˆâ‚›-â€¢ {Î“} {Î¶ = Î¶} Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚â‰ˆÏƒâ‚‚ eâ‚â‰ˆeâ‚‚ {t} {ğ“} (S x) = Ïƒâ‚â‰ˆÏƒâ‚‚ {t} {ğ“} x

âŠ‘-relax : âˆ€ {ğ“ ğ“â€² Î¶ : â„’}
  â†’ (ğ“ âŠ” ğ“â€²) âŠ‘ Î¶
  â†’ ğ“ âŠ‘ Î¶
âŠ‘-relax {Label n} {Label nâ€²} {Label z} (âŠ‘-l nâŠ”nâ€²â‰¤z) =  âŠ‘-l {n} {nâ€²} (mâŠ”nâ‰¤oâ‡’mâ‰¤o n nâ€² nâŠ”nâ€²â‰¤z)

ğ“âŠ‘ğ“â€²â‡’ğ“âŠ”ğ“â€²â‰¡ğ“â€² : âˆ€ {ğ“ ğ“â€²}
  â†’ ğ“ âŠ‘ ğ“â€² â†’ ğ“ âŠ” ğ“â€² â‰¡ ğ“â€²
ğ“âŠ‘ğ“â€²â‡’ğ“âŠ”ğ“â€²â‰¡ğ“â€² {Label n} {Label nâ€²} (âŠ‘-l nâ‰¤nâ€²) = cong Label (mâ‰¤nâ‡’mâŠ”nâ‰¡n nâ‰¤nâ€²)

-- Label join âŠ” is associative.
âŠ”-assoc : âˆ€ {ğ“â‚ ğ“â‚‚ ğ“â‚ƒ}
  â†’ (ğ“â‚ âŠ” ğ“â‚‚) âŠ” ğ“â‚ƒ â‰¡ ğ“â‚ âŠ” (ğ“â‚‚ âŠ” ğ“â‚ƒ)
âŠ”-assoc {Label nâ‚} {Label nâ‚‚} {Label nâ‚ƒ} = cong (Î» â–¡ â†’ Label â–¡) (âŠ”â‚™-assoc nâ‚ nâ‚‚ nâ‚ƒ)

âŠ”áµ¥-assoc : âˆ€ {Î“ t ğ“â‚} {v : Î“ âŠ¢áµ¥ t / ğ“â‚} {ğ“â‚‚ ğ“â‚ƒ}
  â†’ (v âŠ”áµ¥ ğ“â‚‚) âŠ”áµ¥ ğ“â‚ƒ â‰¡ (subst (Î» â–¡ â†’ Î“ âŠ¢áµ¥ t / â–¡) (sym âŠ”-assoc) (v âŠ”áµ¥ (ğ“â‚‚ âŠ” ğ“â‚ƒ)))
âŠ”áµ¥-assoc {t = `ğ”¹} {ğ“â‚} {`true/ ğ“â‚} {ğ“â‚‚} {ğ“â‚ƒ} = cong-true âŠ”-assoc
  where
  cong-true : âˆ€ {Î“ ğ“ ğ“â€²}
    â†’ (ğ“â‰¡ğ“â€² : ğ“ â‰¡ ğ“â€²)
    â†’ `true/ ğ“ â‰¡ subst (Î» â–¡ â†’ Î“ âŠ¢áµ¥ `ğ”¹ / â–¡) (sym ğ“â‰¡ğ“â€²) (`true/ ğ“â€²)
  cong-true refl = refl
âŠ”áµ¥-assoc {t = `ğ”¹} {ğ“â‚} {`false/ ğ“â‚} {ğ“â‚‚} {ğ“â‚ƒ} = cong-false âŠ”-assoc
  where
  cong-false : âˆ€ {Î“ ğ“ ğ“â€²}
    â†’ (ğ“â‰¡ğ“â€² : ğ“ â‰¡ ğ“â€²)
    â†’ `false/ ğ“ â‰¡ subst (Î» â–¡ â†’ Î“ âŠ¢áµ¥ `ğ”¹ / â–¡) (sym ğ“â‰¡ğ“â€²) (`false/ ğ“â€²)
  cong-false refl = refl
âŠ”áµ¥-assoc {t = sâ‚ â‡’ sâ‚‚} {ğ“â‚} {Æ› N / ğ“â‚} {ğ“â‚‚} {ğ“â‚ƒ} = cong-Æ› âŠ”-assoc
  where
  cong-Æ› : âˆ€ {Î“ sâ‚ sâ‚‚ ğ“ ğ“â€²} {N : Î“ , sâ‚ âŠ¢â‚‘ sâ‚‚}
    â†’ (ğ“â‰¡ğ“â€² : ğ“ â‰¡ ğ“â€²)
    â†’ Æ› N / ğ“ â‰¡ subst (Î» â–¡ â†’ Î“ âŠ¢áµ¥ (sâ‚ â‡’ sâ‚‚) / â–¡) (sym ğ“â‰¡ğ“â€²) (Æ› N / ğ“â€²)
  cong-Æ› refl = refl

cong-label : âˆ€ {t} {ğ“ ğ“â€² Î¶ : â„’} {vâ‚ vâ‚‚ : âˆ… âŠ¢áµ¥ (t / ğ“)} {vâ‚â€² vâ‚‚â€² : âˆ… âŠ¢áµ¥ (t / ğ“â€²)}
  â†’ (ğ“â‰¡ğ“â€² : ğ“ â‰¡ ğ“â€²)
  â†’ vâ‚ â‰¡ (subst (Î» â–¡ â†’ âˆ… âŠ¢áµ¥ (t / â–¡)) (sym ğ“â‰¡ğ“â€²) vâ‚â€²)
  â†’ vâ‚‚ â‰¡ (subst (Î» â–¡ â†’ âˆ… âŠ¢áµ¥ (t / â–¡)) (sym ğ“â‰¡ğ“â€²) vâ‚‚â€²)
  â†’ t / ğ“ â¦‚ vâ‚ â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚ â‰¡ t / ğ“â€² â¦‚ vâ‚â€² â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚â€²
cong-label refl refl refl = refl

âŠ”-âŠ‘-inv : âˆ€ {ğ“â‚ ğ“â‚‚ ğ“}
  â†’ (ğ“â‚ âŠ” ğ“â‚‚) âŠ‘ ğ“ â†’ (ğ“â‚ âŠ‘ ğ“) Ã— (ğ“â‚‚ âŠ‘ ğ“)
âŠ”-âŠ‘-inv {Label nâ‚} {Label nâ‚‚} {Label n} (âŠ‘-l nâ‚âŠ”nâ‚‚â‰¤n) = âŸ¨ left , right âŸ©
  where
  left : _
  left = âŠ‘-l {nâ‚} {n} (mâŠ”nâ‰¤oâ‡’mâ‰¤o nâ‚ nâ‚‚ nâ‚âŠ”nâ‚‚â‰¤n)
  right : _
  right = âŠ‘-l {nâ‚‚} {n} (mâŠ”nâ‰¤oâ‡’nâ‰¤o nâ‚ nâ‚‚ nâ‚âŠ”nâ‚‚â‰¤n)

-- The terms `true/ ğ“` and `false/ ğ“` can never be the same for all ğ“ .
trueâ‰¢false : âˆ€ {Î“ ğ“} {M : Î“ âŠ¢áµ¥ `ğ”¹ / ğ“} {N : Î“ âŠ¢áµ¥ `ğ”¹ / ğ“}
  â†’ (eqâ‚˜ : M â‰¡ `true/ ğ“)
  â†’ (eqâ‚™ : N â‰¡ `false/ ğ“)
  â†’ M â‰¢ N
trueâ‰¢false refl refl ()


-- Value stamping âŠ”áµ¥ preserves the logical relation â‰ˆáµ¥ .
value-stamp-pres : âˆ€ {t ğ“ Î¶ vâ‚ vâ‚‚}
  â†’ (ğ“â€² : â„’)
  â†’ t / ğ“ â¦‚ vâ‚ â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚
    -----------------------------------------------
  â†’ t / (ğ“ âŠ” ğ“â€²) â¦‚ (vâ‚ âŠ”áµ¥ ğ“â€²) â‰ˆáµ¥â¦… Î¶ â¦† (vâ‚‚ âŠ”áµ¥ ğ“â€²)
value-stamp-pres {ğ“ = ğ“} {vâ‚ = `true/ ğ“} {vâ‚‚ = `true/ ğ“} ğ“â€² vâ‚â‰ˆvâ‚‚ = Î» _ â†’ refl
value-stamp-pres {ğ“ = ğ“} {vâ‚ = `true/ ğ“} {vâ‚‚ = `false/ ğ“} ğ“â€² vâ‚â‰ˆvâ‚‚ ğ“âŠ”ğ“â€²âŠ‘Î¶ =
  let ğ“âŠ‘Î¶ = âŠ‘-relax ğ“âŠ”ğ“â€²âŠ‘Î¶ in
  let eq = vâ‚â‰ˆvâ‚‚ ğ“âŠ‘Î¶ in
    âŠ¥-elim (trueâ‰¢false refl refl eq)
value-stamp-pres {ğ“ = ğ“} {vâ‚ = `false/ ğ“} {vâ‚‚ = `true/ ğ“} ğ“â€² vâ‚â‰ˆvâ‚‚ ğ“âŠ”ğ“â€²âŠ‘Î¶ =
  let ğ“âŠ‘Î¶ = âŠ‘-relax ğ“âŠ”ğ“â€²âŠ‘Î¶ in
  let eq = vâ‚â‰ˆvâ‚‚ ğ“âŠ‘Î¶ in
    âŠ¥-elim (trueâ‰¢false refl refl (sym eq))
value-stamp-pres {ğ“ = ğ“} {vâ‚ = `false/ ğ“} {vâ‚‚ = `false/ ğ“} ğ“â€² vâ‚â‰ˆvâ‚‚ = Î» _ â†’ refl
value-stamp-pres {(tâ‚ / ğ“â‚) â‡’ (tâ‚‚ / ğ“â‚‚)} {ğ“} {Î¶} {Æ› M / ğ“} {Æ› N / ğ“} ğ“â€² vâ‚â‰ˆvâ‚‚ with âŠ‘-dec ğ“â€² Î¶ | âŠ‘-dec ğ“ Î¶
... | yes ğ“â€²âŠ‘Î¶ | yes ğ“âŠ‘Î¶ =  Î» ğ“âŠ”ğ“â€²âŠ‘Î¶ {vâ‚â€²} {vâ‚‚â€²} vâ‚â€²â‰ˆvâ‚‚â€² â†’
  Î» {(â‡“-app {V = vâ‚} â‡“-val â‡“-val â‡“vâ‚) (â‡“-app {V = vâ‚‚} â‡“-val â‡“-val â‡“vâ‚‚) â†’
    let h = vâ‚â‰ˆvâ‚‚ ğ“âŠ‘Î¶ vâ‚â€²â‰ˆvâ‚‚â€² in
    let â‡“vâ‚ƒ = â‡“-app {M = val (Æ› M / ğ“)} {N = val vâ‚â€²} â‡“-val â‡“-val â‡“vâ‚ in
    let â‡“vâ‚„ = â‡“-app {M = val (Æ› N / ğ“)} {N = val vâ‚‚â€²} â‡“-val â‡“-val â‡“vâ‚‚ in
    let hâ€² = h â‡“vâ‚ƒ â‡“vâ‚„ in
    let hâ€³ = value-stamp-pres ğ“â€² hâ€² in
      subst (Î» â–¡ â†’ â–¡) eq hâ€³
  }
  where
  eq : âˆ€ {t ğ“â‚ ğ“â‚‚ ğ“â‚ƒ Î¶} {vâ‚ vâ‚‚ : âˆ… âŠ¢áµ¥ t / ğ“â‚}
      â†’ t / (ğ“â‚ âŠ” ğ“â‚‚) âŠ” ğ“â‚ƒ â¦‚ ((vâ‚ âŠ”áµ¥ ğ“â‚‚) âŠ”áµ¥ ğ“â‚ƒ) â‰ˆáµ¥â¦… Î¶ â¦† ((vâ‚‚ âŠ”áµ¥ ğ“â‚‚) âŠ”áµ¥ ğ“â‚ƒ) â‰¡
        t / ğ“â‚ âŠ” (ğ“â‚‚ âŠ” ğ“â‚ƒ) â¦‚ (vâ‚ âŠ”áµ¥ (ğ“â‚‚  âŠ” ğ“â‚ƒ)) â‰ˆáµ¥â¦… Î¶ â¦† (vâ‚‚ âŠ”áµ¥ (ğ“â‚‚  âŠ” ğ“â‚ƒ))
  eq {t} {ğ“â‚} {ğ“â‚‚} {ğ“â‚ƒ} {Î¶} {vâ‚} {vâ‚‚} = cong-label (âŠ”-assoc {ğ“â‚} {ğ“â‚‚} {ğ“â‚ƒ}) âŠ”áµ¥-assoc âŠ”áµ¥-assoc
... | no Â¬ğ“â€²âŠ‘Î¶ | yes ğ“âŠ‘Î¶ = Î» ğ“âŠ”ğ“â€²âŠ‘Î¶ â†’ let ğ“â€²âŠ‘Î¶ = (projâ‚‚ (âŠ”-âŠ‘-inv ğ“âŠ”ğ“â€²âŠ‘Î¶)) in âŠ¥-elim (Â¬ğ“â€²âŠ‘Î¶ ğ“â€²âŠ‘Î¶)
... | yes ğ“â€²âŠ‘Î¶ | no Â¬ğ“âŠ‘Î¶ = Î» ğ“âŠ”ğ“â€²âŠ‘Î¶ â†’ let ğ“âŠ‘Î¶ = (projâ‚ (âŠ”-âŠ‘-inv ğ“âŠ”ğ“â€²âŠ‘Î¶)) in âŠ¥-elim (Â¬ğ“âŠ‘Î¶ ğ“âŠ‘Î¶)
... | no Â¬ğ“â€²âŠ‘Î¶ | no Â¬ğ“âŠ‘Î¶ = Î» ğ“âŠ”ğ“â€²âŠ‘Î¶ â†’ let ğ“âŠ‘Î¶ = (projâ‚ (âŠ”-âŠ‘-inv ğ“âŠ”ğ“â€²âŠ‘Î¶)) in âŠ¥-elim (Â¬ğ“âŠ‘Î¶ ğ“âŠ‘Î¶)

â‰ˆáµ¥â†’â‰ˆâ‚‘ : âˆ€ {t ğ“ Î¶ vâ‚ vâ‚‚}
  â†’ t / ğ“ â¦‚ vâ‚ â‰ˆáµ¥â¦… Î¶ â¦† vâ‚‚
  â†’ t / ğ“ â¦‚ (val vâ‚) â‰ˆâ‚‘â¦… Î¶ â¦† (val vâ‚‚)
â‰ˆáµ¥â†’â‰ˆâ‚‘ vâ‚â‰ˆvâ‚‚ = Î» {â‡“-val â‡“-val â†’ vâ‚â‰ˆvâ‚‚}



-- Fundamental property:
--   If Î“ âŠ¢ e : s and Î“ âŠ¢ Ïƒâ‚ â‰ˆÎ¶ Ïƒâ‚‚ then Ïƒâ‚(e) â‰ˆÎ¶ Ïƒâ‚‚(e) : s
fundamental : âˆ€ {Î“ t ğ“ Î¶}
  â†’ (Ïƒâ‚ : Subst Î“ âˆ…)
  â†’ (Ïƒâ‚‚ : Subst Î“ âˆ…)
  â†’ (e : Î“ âŠ¢â‚‘ (t / ğ“))
  â†’ Î“ âŠ¢ Ïƒâ‚ â‰ˆâ‚›â¦… Î¶ â¦† Ïƒâ‚‚
    -----------------------------------------------
  â†’ t / ğ“ â¦‚ (substâ‚‘ Ïƒâ‚ e) â‰ˆâ‚‘â¦… Î¶ â¦† (substâ‚‘ Ïƒâ‚‚ e)
fundamental Ïƒâ‚ Ïƒâ‚‚ (` x) Ïƒâ‚â‰ˆÏƒâ‚‚ = Ïƒâ‚â‰ˆÏƒâ‚‚ x
fundamental {Î¶ = Î¶} Ïƒâ‚ Ïƒâ‚‚ (val (`true/ ğ“)) Ïƒâ‚â‰ˆÏƒâ‚‚ â‡“-val â‡“-val _ = refl
fundamental Ïƒâ‚ Ïƒâ‚‚ (val (`false/ ğ“)) Ïƒâ‚â‰ˆÏƒâ‚‚ â‡“-val â‡“-val _ = refl
fundamental {t = ((tâ‚ / ğ“â‚) â‡’ (tâ‚‚ / ğ“â‚‚))} Ïƒâ‚ Ïƒâ‚‚ (val (Æ› N / ğ“)) Ïƒâ‚â‰ˆÏƒâ‚‚ = Î» {â‡“-val â‡“-val â†’ fundamental-Æ› {N = N} Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚â‰ˆÏƒâ‚‚ }
  where
  fundamental-Æ› : âˆ€ {Î“ Î¶ tâ‚ tâ‚‚ ğ“â‚ ğ“â‚‚ ğ“ N}
    â†’ (Ïƒâ‚ Ïƒâ‚‚ : Subst Î“ âˆ…)
    â†’ Î“ âŠ¢ Ïƒâ‚ â‰ˆâ‚›â¦… Î¶ â¦† Ïƒâ‚‚
    â†’ ((tâ‚ / ğ“â‚) â‡’ (tâ‚‚ / ğ“â‚‚)) / ğ“ â¦‚ (Æ› (substâ‚‘ (exts Ïƒâ‚) N) / ğ“) â‰ˆáµ¥â¦… Î¶ â¦† (Æ› (substâ‚‘ (exts Ïƒâ‚‚) N) / ğ“)
  fundamental-Æ› {Î“} {Î¶} {tâ‚} {tâ‚‚} {ğ“â‚} {ğ“â‚‚} {ğ“} {N} Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚â‰ˆÏƒâ‚‚ = Î» ğ“âŠ‘Î¶ {vâ‚â€²} {vâ‚‚â€²} vâ‚â€²â‰ˆvâ‚‚â€² â†’
    Î» {(â‡“-app {V = vâ‚â€³} â‡“-val â‡“-val â‡“vâ‚â€³) (â‡“-app {V = vâ‚‚â€³} â‡“-val â‡“-val â‡“vâ‚‚â€³) â†’
      let Ïƒâ‚â€¢â‰ˆÏƒâ‚‚â€¢ = â‰ˆâ‚›-â€¢ {Î“} {tâ‚} {ğ“â‚} {Î¶} {val vâ‚â€²} {val vâ‚‚â€²} Ïƒâ‚ Ïƒâ‚‚ Ïƒâ‚â‰ˆÏƒâ‚‚ (â‰ˆáµ¥â†’â‰ˆâ‚‘ vâ‚â€²â‰ˆvâ‚‚â€²) in
      let Ïƒâ‚â€¢Nâ‡“vâ‚â€³ = (subst (Î» â–¡ â†’ â–¡ â‡“ vâ‚â€³) (exts-sub-cons Ïƒâ‚ N (val vâ‚â€²)) â‡“vâ‚â€³) in
      let Ïƒâ‚‚â€¢Nâ‡“vâ‚‚â€³ = (subst (Î» â–¡ â†’ â–¡ â‡“ vâ‚‚â€³) (exts-sub-cons Ïƒâ‚‚ N (val vâ‚‚â€²)) â‡“vâ‚‚â€³) in
      let ih = fundamental {Î¶ = Î¶} (Ïƒâ‚ â€¢ (val vâ‚â€²)) (Ïƒâ‚‚ â€¢ (val vâ‚‚â€²)) N Ïƒâ‚â€¢â‰ˆÏƒâ‚‚â€¢ Ïƒâ‚â€¢Nâ‡“vâ‚â€³ Ïƒâ‚‚â€¢Nâ‡“vâ‚‚â€³ in value-stamp-pres ğ“ ih}
fundamental {Î¶ = Î¶} Ïƒâ‚ Ïƒâ‚‚ (_Â·_ {tâ‚ = tâ‚} {tâ‚‚} {ğ“â‚} {ğ“â‚‚} {ğ“} L N) Ïƒâ‚â‰ˆÏƒâ‚‚
  (â‡“-app {Vâ‚™ = Vâ‚™â‚} {V = Vâ‚} {Mâ€² = Mâ‚} Ïƒâ‚Lâ‡“Æ›Mâ‚ Ïƒâ‚Nâ‡“Vâ‚™â‚ Mâ‚[Vâ‚™â‚]â‡“Vâ‚) (â‡“-app {Vâ‚™ = Vâ‚™â‚‚} {V = Vâ‚‚} {Mâ€² = Mâ‚‚} Ïƒâ‚‚Lâ‡“Æ›Mâ‚‚ Ïƒâ‚‚Nâ‡“Vâ‚™â‚‚ Mâ‚‚[Vâ‚™â‚‚]â‡“Vâ‚‚)
  with âŠ‘-dec ğ“ Î¶
... | yes ğ“âŠ‘Î¶ =
  let Ïƒâ‚Lâ‰ˆÏƒâ‚‚L = fundamental Ïƒâ‚ Ïƒâ‚‚ L Ïƒâ‚â‰ˆÏƒâ‚‚ in
  let Ïƒâ‚Nâ‰ˆÏƒâ‚‚N = fundamental Ïƒâ‚ Ïƒâ‚‚ N Ïƒâ‚â‰ˆÏƒâ‚‚ in
  let Æ›Mâ‚â‰ˆÆ›Mâ‚‚ = Ïƒâ‚Lâ‰ˆÏƒâ‚‚L Ïƒâ‚Lâ‡“Æ›Mâ‚ Ïƒâ‚‚Lâ‡“Æ›Mâ‚‚ in
  let Vâ‚™â‚â‰ˆVâ‚™â‚‚ = Ïƒâ‚Nâ‰ˆÏƒâ‚‚N Ïƒâ‚Nâ‡“Vâ‚™â‚ Ïƒâ‚‚Nâ‡“Vâ‚™â‚‚ in
  let Æ›Mâ‚Â·Vâ‚™â‚â‰ˆÆ›Mâ‚‚Â·Vâ‚™â‚‚ = Æ›Mâ‚â‰ˆÆ›Mâ‚‚ ğ“âŠ‘Î¶ Vâ‚™â‚â‰ˆVâ‚™â‚‚ in
  let Æ›Mâ‚Â·Vâ‚™â‚â‡“Vâ‚ = â‡“-app {ğ“ = ğ“} {Vâ‚™ = Vâ‚™â‚} {V = Vâ‚} {Mâ€² = Mâ‚} â‡“-val â‡“-val Mâ‚[Vâ‚™â‚]â‡“Vâ‚ in
  let Æ›Mâ‚‚Â·Vâ‚™â‚‚â‡“Vâ‚‚ = â‡“-app {ğ“ = ğ“} {Vâ‚™ = Vâ‚™â‚‚} {V = Vâ‚‚} {Mâ€² = Mâ‚‚} â‡“-val â‡“-val Mâ‚‚[Vâ‚™â‚‚]â‡“Vâ‚‚ in
    Æ›Mâ‚Â·Vâ‚™â‚â‰ˆÆ›Mâ‚‚Â·Vâ‚™â‚‚ Æ›Mâ‚Â·Vâ‚™â‚â‡“Vâ‚ Æ›Mâ‚‚Â·Vâ‚™â‚‚â‡“Vâ‚‚
-- ğ“ âŠ‘ Î¶ means that we can see nothing ...
... | no Â¬ğ“âŠ‘Î¶ with tâ‚‚
...   | `ğ”¹ = Î» ğ“â‚‚âŠ”ğ“âŠ‘Î¶ â†’ âŠ¥-elim (Â¬ğ“âŠ‘Î¶ (projâ‚‚ (âŠ”-âŠ‘-inv ğ“â‚‚âŠ”ğ“âŠ‘Î¶)))
...   | (_ / _) â‡’ (_ / _) = Î» ğ“â‚‚âŠ”ğ“âŠ‘Î¶ â†’ âŠ¥-elim (Â¬ğ“âŠ‘Î¶ (projâ‚‚ (âŠ”-âŠ‘-inv ğ“â‚‚âŠ”ğ“âŠ‘Î¶)))
fundamental {Î¶ = Î¶} Ïƒâ‚ Ïƒâ‚‚ (_`âˆ§_ {ğ“â‚ = ğ“â‚} {ğ“â‚‚} M N) Ïƒâ‚â‰ˆÏƒâ‚‚
  (â‡“-âˆ§ {Vâ‚˜ = Vâ‚˜â‚} {Vâ‚™ = Vâ‚™â‚} Ïƒâ‚Mâ‡“Vâ‚˜â‚ Ïƒâ‚Nâ‡“Vâ‚™â‚) (â‡“-âˆ§ {Vâ‚˜ = Vâ‚˜â‚‚} {Vâ‚™ = Vâ‚™â‚‚} Ïƒâ‚‚Mâ‡“Vâ‚˜â‚‚ Ïƒâ‚‚Nâ‡“Vâ‚™â‚‚)
  with âŠ‘-dec (ğ“â‚ âŠ” ğ“â‚‚) Î¶
... | yes ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶ =
  let Ïƒâ‚Mâ‰ˆÏƒâ‚‚M = fundamental Ïƒâ‚ Ïƒâ‚‚ M Ïƒâ‚â‰ˆÏƒâ‚‚ in
  let Ïƒâ‚Nâ‰ˆÏƒâ‚‚N = fundamental Ïƒâ‚ Ïƒâ‚‚ N Ïƒâ‚â‰ˆÏƒâ‚‚ in
  let Vâ‚˜â‚â‰ˆVâ‚˜â‚‚ = Ïƒâ‚Mâ‰ˆÏƒâ‚‚M Ïƒâ‚Mâ‡“Vâ‚˜â‚ Ïƒâ‚‚Mâ‡“Vâ‚˜â‚‚ in
  let Vâ‚™â‚â‰ˆVâ‚™â‚‚ = Ïƒâ‚Nâ‰ˆÏƒâ‚‚N Ïƒâ‚Nâ‡“Vâ‚™â‚ Ïƒâ‚‚Nâ‡“Vâ‚™â‚‚ in
  let ğ“â‚âŠ‘Î¶ = projâ‚ (âŠ”-âŠ‘-inv ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶) in
  let ğ“â‚‚âŠ‘Î¶ = projâ‚‚ (âŠ”-âŠ‘-inv ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶) in
  let Vâ‚˜â‚â‰¡Vâ‚˜â‚‚ = Vâ‚˜â‚â‰ˆVâ‚˜â‚‚ ğ“â‚âŠ‘Î¶ in
  let Vâ‚™â‚â‰¡Vâ‚™â‚‚ = Vâ‚™â‚â‰ˆVâ‚™â‚‚ ğ“â‚‚âŠ‘Î¶ in
  Î» _ â†’ congâ‚‚ (Î» â–¡â‚ â–¡â‚‚ â†’ (â–¡â‚ âŸ¦âˆ§âŸ§ â–¡â‚‚)) Vâ‚˜â‚â‰¡Vâ‚˜â‚‚ Vâ‚™â‚â‰¡Vâ‚™â‚‚
... | no Â¬ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶ = Î» ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶ â†’ âŠ¥-elim (Â¬ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶ ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶)
fundamental {Î¶ = Î¶} Ïƒâ‚ Ïƒâ‚‚ (_`âˆ¨_ {ğ“â‚ = ğ“â‚} {ğ“â‚‚} M N) Ïƒâ‚â‰ˆÏƒâ‚‚
  (â‡“-âˆ¨ {Vâ‚˜ = Vâ‚˜â‚} {Vâ‚™ = Vâ‚™â‚} Ïƒâ‚Mâ‡“Vâ‚˜â‚ Ïƒâ‚Nâ‡“Vâ‚™â‚) (â‡“-âˆ¨ {Vâ‚˜ = Vâ‚˜â‚‚} {Vâ‚™ = Vâ‚™â‚‚} Ïƒâ‚‚Mâ‡“Vâ‚˜â‚‚ Ïƒâ‚‚Nâ‡“Vâ‚™â‚‚)
  with âŠ‘-dec (ğ“â‚ âŠ” ğ“â‚‚) Î¶
... | yes ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶ =
  let Ïƒâ‚Mâ‰ˆÏƒâ‚‚M = fundamental Ïƒâ‚ Ïƒâ‚‚ M Ïƒâ‚â‰ˆÏƒâ‚‚ in
  let Ïƒâ‚Nâ‰ˆÏƒâ‚‚N = fundamental Ïƒâ‚ Ïƒâ‚‚ N Ïƒâ‚â‰ˆÏƒâ‚‚ in
  let Vâ‚˜â‚â‰ˆVâ‚˜â‚‚ = Ïƒâ‚Mâ‰ˆÏƒâ‚‚M Ïƒâ‚Mâ‡“Vâ‚˜â‚ Ïƒâ‚‚Mâ‡“Vâ‚˜â‚‚ in
  let Vâ‚™â‚â‰ˆVâ‚™â‚‚ = Ïƒâ‚Nâ‰ˆÏƒâ‚‚N Ïƒâ‚Nâ‡“Vâ‚™â‚ Ïƒâ‚‚Nâ‡“Vâ‚™â‚‚ in
  let ğ“â‚âŠ‘Î¶ = projâ‚ (âŠ”-âŠ‘-inv ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶) in
  let ğ“â‚‚âŠ‘Î¶ = projâ‚‚ (âŠ”-âŠ‘-inv ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶) in
  let Vâ‚˜â‚â‰¡Vâ‚˜â‚‚ = Vâ‚˜â‚â‰ˆVâ‚˜â‚‚ ğ“â‚âŠ‘Î¶ in
  let Vâ‚™â‚â‰¡Vâ‚™â‚‚ = Vâ‚™â‚â‰ˆVâ‚™â‚‚ ğ“â‚‚âŠ‘Î¶ in
  Î» _ â†’ congâ‚‚ (Î» â–¡â‚ â–¡â‚‚ â†’ (â–¡â‚ âŸ¦âˆ¨âŸ§ â–¡â‚‚)) Vâ‚˜â‚â‰¡Vâ‚˜â‚‚ Vâ‚™â‚â‰¡Vâ‚™â‚‚
... | no Â¬ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶ = Î» ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶ â†’ âŠ¥-elim (Â¬ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶ ğ“â‚âŠ”ğ“â‚‚âŠ‘Î¶)
fundamental {Î¶ = Î¶} Ïƒâ‚ Ïƒâ‚‚ (if {t = t} {ğ“} {ğ“â€²} L M N) Ïƒâ‚â‰ˆÏƒâ‚‚
  with âŠ‘-dec (ğ“ âŠ” ğ“â€²) Î¶
... | yes ğ“âŠ”ğ“â€²âŠ‘Î¶ = Î» { (â‡“-condâ‚ _ Ïƒâ‚Mâ‡“Vâ‚) (â‡“-condâ‚ _ Ïƒâ‚‚Mâ‡“Vâ‚‚) â†’
        let Ïƒâ‚Mâ‰ˆÏƒâ‚‚M = fundamental Ïƒâ‚ Ïƒâ‚‚ M Ïƒâ‚â‰ˆÏƒâ‚‚ in
          Ïƒâ‚Mâ‰ˆÏƒâ‚‚M Ïƒâ‚Mâ‡“Vâ‚ Ïƒâ‚‚Mâ‡“Vâ‚‚ ;
      (â‡“-condâ‚ Ïƒâ‚Lâ‡“true _) (â‡“-condâ‚‚ Ïƒâ‚‚Lâ‡“false _) â†’
        let Ïƒâ‚Lâ‰ˆÏƒâ‚‚L = fundamental Ïƒâ‚ Ïƒâ‚‚ L Ïƒâ‚â‰ˆÏƒâ‚‚ in
        let trueâ‰ˆfalse = Ïƒâ‚Lâ‰ˆÏƒâ‚‚L Ïƒâ‚Lâ‡“true Ïƒâ‚‚Lâ‡“false in
        let ğ“â€²âŠ‘Î¶ = projâ‚‚ (âŠ”-âŠ‘-inv ğ“âŠ”ğ“â€²âŠ‘Î¶) in
        let trueâ‰¡false = trueâ‰ˆfalse ğ“â€²âŠ‘Î¶ in
          âŠ¥-elim (trueâ‰¢false refl refl trueâ‰¡false) ;
      (â‡“-condâ‚‚ Ïƒâ‚Lâ‡“false _) (â‡“-condâ‚ Ïƒâ‚‚Lâ‡“true _) â†’
        let Ïƒâ‚Lâ‰ˆÏƒâ‚‚L = fundamental Ïƒâ‚ Ïƒâ‚‚ L Ïƒâ‚â‰ˆÏƒâ‚‚ in
        let falseâ‰ˆtrue = Ïƒâ‚Lâ‰ˆÏƒâ‚‚L Ïƒâ‚Lâ‡“false Ïƒâ‚‚Lâ‡“true in
        let ğ“â€²âŠ‘Î¶ = projâ‚‚ (âŠ”-âŠ‘-inv ğ“âŠ”ğ“â€²âŠ‘Î¶) in
        let falseâ‰¡true = falseâ‰ˆtrue ğ“â€²âŠ‘Î¶ in
          âŠ¥-elim (trueâ‰¢false refl refl (sym falseâ‰¡true)) ;
      (â‡“-condâ‚‚ _ Ïƒâ‚Nâ‡“Vâ‚) (â‡“-condâ‚‚ _ Ïƒâ‚‚Nâ‡“Vâ‚‚) â†’
        let Ïƒâ‚Nâ‰ˆÏƒâ‚‚N = fundamental Ïƒâ‚ Ïƒâ‚‚ N Ïƒâ‚â‰ˆÏƒâ‚‚ in
          Ïƒâ‚Nâ‰ˆÏƒâ‚‚N Ïƒâ‚Nâ‡“Vâ‚ Ïƒâ‚‚Nâ‡“Vâ‚‚}
... | no Â¬ğ“âŠ”ğ“â€²âŠ‘Î¶ with t
...   | `ğ”¹ = Î» _ _ ğ“âŠ”ğ“â€²âŠ‘Î¶ â†’ âŠ¥-elim (Â¬ğ“âŠ”ğ“â€²âŠ‘Î¶ ğ“âŠ”ğ“â€²âŠ‘Î¶)
...   | (_ / _) â‡’ (_ / _) = Î» _ _ ğ“âŠ”ğ“â€²âŠ‘Î¶ â†’ âŠ¥-elim (Â¬ğ“âŠ”ğ“â€²âŠ‘Î¶ ğ“âŠ”ğ“â€²âŠ‘Î¶)


-- Noninterference is a corollary of the fundamental property.
noninterference : âˆ€ {táµ¢â‚™ tâ‚’áµ¤â‚œ ğ“áµ¢â‚™ ğ“â‚’áµ¤â‚œ Î¶} {M : âˆ… , táµ¢â‚™ / ğ“áµ¢â‚™ âŠ¢â‚‘ tâ‚’áµ¤â‚œ / ğ“â‚’áµ¤â‚œ} {Vâ‚ : âˆ… âŠ¢áµ¥ táµ¢â‚™ / ğ“áµ¢â‚™} {Vâ‚‚ : âˆ… âŠ¢áµ¥ táµ¢â‚™ / ğ“áµ¢â‚™}
  â†’ Â¬ ğ“áµ¢â‚™  âŠ‘ Î¶
  â†’   ğ“â‚’áµ¤â‚œ âŠ‘ Î¶
    --------------------------------------------------------
  â†’ tâ‚’áµ¤â‚œ / ğ“â‚’áµ¤â‚œ â¦‚ (M [ (val Vâ‚) ]) â‰ˆâ‚‘â¦… Î¶ â¦† (M [ (val Vâ‚‚) ])
noninterference {táµ¢â‚™} {tâ‚’áµ¤â‚œ} {ğ“áµ¢â‚™} {ğ“â‚’áµ¤â‚œ} {Î¶} {M} {Vâ‚} {Vâ‚‚} Â¬ğ“áµ¢â‚™âŠ‘Î¶ ğ“â‚’áµ¤â‚œâŠ‘Î¶ =
  let [Vâ‚]â‰ˆ[Vâ‚‚] = Ïƒâ‚â‰ˆÏƒâ‚‚ {táµ¢â‚™} {ğ“áµ¢â‚™} {Î¶} {Vâ‚} {Vâ‚‚} Â¬ğ“áµ¢â‚™âŠ‘Î¶ in
    fundamental {Î¶ = Î¶} (Ïƒâ‚€ (val Vâ‚)) (Ïƒâ‚€ (val Vâ‚‚)) M [Vâ‚]â‰ˆ[Vâ‚‚]
  where
  Ïƒâ‚â‰ˆÏƒâ‚‚ : âˆ€ {t ğ“ Î¶ Vâ‚ Vâ‚‚} â†’ (Â¬ğ“âŠ‘Î¶ : Â¬ ğ“ âŠ‘ Î¶) â†’ (âˆ… , t / ğ“) âŠ¢ Ïƒâ‚€ (val Vâ‚) â‰ˆâ‚›â¦… Î¶ â¦† Ïƒâ‚€ (val Vâ‚‚)
  Ïƒâ‚â‰ˆÏƒâ‚‚ {t} Â¬ğ“âŠ‘Î¶ Z â‡“-val â‡“-val with t
  ... | `ğ”¹ = Î» ğ“âŠ‘Î¶ â†’ âŠ¥-elim (Â¬ğ“âŠ‘Î¶ ğ“âŠ‘Î¶)
  ... | (_ / _) â‡’ (_ / _) = Î» ğ“âŠ‘Î¶ â†’ âŠ¥-elim (Â¬ğ“âŠ‘Î¶ ğ“âŠ‘Î¶)
