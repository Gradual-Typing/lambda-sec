module BigStep where

open import Statics
open Context


-- we first define substitution
-- extension lemma
ext : âˆ€ {Î“ Î”}
  â†’ (âˆ€ {A} â†’       Î“ âˆ‹ A â†’     Î” âˆ‹ A)
    ---------------------------------
  â†’ (âˆ€ {A B} â†’ Î“ , B âˆ‹ A â†’ Î” , B âˆ‹ A)
ext Ï Z      =  Z
ext Ï (S x)  =  S (Ï x)

-- renaming
rename : âˆ€ {Î“ Î”}
  â†’ (âˆ€ {A} â†’ Î“ âˆ‹ A â†’ Î” âˆ‹ A)
    -----------------------
  â†’ (âˆ€ {A} â†’ Î“ âŠ¢â‚‘ A â†’ Î” âŠ¢â‚‘ A)
rename Ï (` x)                  =  ` (Ï x)
rename Ï (val (Æ› N / ğ“))        =  val ( Æ› (rename (ext Ï) N) / ğ“ )
rename Ï (val (`true/ ğ“))       =  val (`true/ ğ“)
rename Ï (val (`false/ ğ“))      =  val (`false/ ğ“)
rename Ï (L Â· M)                =  (rename Ï L) Â· (rename Ï M)
rename Ï (if L M N)             =  if (rename Ï L) (rename Ï M) (rename Ï N)
rename Ï (M `âˆ§ N)               =  (rename Ï M) `âˆ§ (rename Ï N)
rename Ï (M `âˆ¨ N)               =  (rename Ï M) `âˆ¨ (rename Ï N)
rename Ï (sub M âŠ¢â‰¤)             =  sub (rename Ï M) âŠ¢â‰¤

-- extension (in terms of well-formedness)
exts : âˆ€ {Î“ Î”}
  â†’ (âˆ€ {A} â†’       Î“ âˆ‹ A â†’     Î” âŠ¢â‚‘ A)
    ---------------------------------
  â†’ (âˆ€ {A B} â†’ Î“ , B âˆ‹ A â†’ Î” , B âŠ¢â‚‘ A)
exts Ïƒ Z      =  ` Z
exts Ïƒ (S x)  =  rename S_ (Ïƒ x)

-- substitution
subst : âˆ€ {Î“ Î”}
  â†’ (âˆ€ {A} â†’ Î“ âˆ‹ A â†’ Î” âŠ¢â‚‘ A)
    -----------------------
  â†’ (âˆ€ {A} â†’ Î“ âŠ¢â‚‘ A â†’ Î” âŠ¢â‚‘ A)
subst Ïƒ (` k)          =  Ïƒ k
subst Ïƒ (val (Æ› N / ğ“))      =  val (Æ› (subst (exts Ïƒ) N) / ğ“)
subst Ïƒ (val (`true/ ğ“))     =  val (`true/ ğ“)
subst Ïƒ (val (`false/ ğ“))    =  val (`false/ ğ“)
subst Ïƒ (L Â· M)              =  (subst Ïƒ L) Â· (subst Ïƒ M)
subst Ïƒ (if L M N)           =  if (subst Ïƒ L) (subst Ïƒ M) (subst Ïƒ N)
subst Ïƒ (M `âˆ§ N)             =  (subst Ïƒ M) `âˆ§ (subst Ïƒ N)
subst Ïƒ (M `âˆ¨ N)             =  (subst Ïƒ M) `âˆ¨ (subst Ïƒ N)
subst Ïƒ (sub M âŠ¢â‰¤)           =  sub (subst Ïƒ M) âŠ¢â‰¤

_[_] : âˆ€ {Î“ A B}
        â†’ Î“ , B âŠ¢â‚‘ A
        â†’ Î“ âŠ¢â‚‘ B
          ---------
        â†’ Î“ âŠ¢â‚‘ A
_[_] {Î“} {A} {B} N M =  subst {Î“ , B} {Î“} Ïƒ {A} N
  where
  Ïƒ : âˆ€ {A} â†’ Î“ , B âˆ‹ A â†’ Î“ âŠ¢â‚‘ A
  Ïƒ Z      =  M
  Ïƒ (S x)  =  ` x

_âŸ¦âˆ§âŸ§_ : âˆ€ {ğ“â‚˜ ğ“â‚™}
      â†’ (M : âˆ… âŠ¢áµ¥ `ğ”¹ / ğ“â‚˜)
      â†’ (N : âˆ… âŠ¢áµ¥ `ğ”¹ / ğ“â‚™)
        -----------------------
      â†’ âˆ… âŠ¢áµ¥ `ğ”¹ / (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ§âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`true/ ğ“â‚˜)  (`true/ ğ“â‚™)   = `true/  (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ§âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`true/ ğ“â‚˜)  (`false/ ğ“â‚™)  = `false/ (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ§âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`false/ ğ“â‚˜) (`true/ ğ“â‚™)   = `false/ (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ§âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`false/ ğ“â‚˜) (`false/ ğ“â‚™)  = `false/ (ğ“â‚˜ âŠ” ğ“â‚™)

_âŸ¦âˆ¨âŸ§_ : âˆ€ {ğ“â‚˜ ğ“â‚™}
      â†’ (M : âˆ… âŠ¢áµ¥ `ğ”¹ / ğ“â‚˜)
      â†’ (N : âˆ… âŠ¢áµ¥ `ğ”¹ / ğ“â‚™)
        -----------------------
      â†’ âˆ… âŠ¢áµ¥ `ğ”¹ / (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ¨âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`true/ ğ“â‚˜)  (`true/ ğ“â‚™)   = `true/  (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ¨âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`true/ ğ“â‚˜)  (`false/ ğ“â‚™)  = `true/  (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ¨âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`false/ ğ“â‚˜) (`true/ ğ“â‚™)   = `true/  (ğ“â‚˜ âŠ” ğ“â‚™)
_âŸ¦âˆ¨âŸ§_ {ğ“â‚˜} {ğ“â‚™} (`false/ ğ“â‚˜) (`false/ ğ“â‚™)  = `false/ (ğ“â‚˜ âŠ” ğ“â‚™)


data _â‡“_ : âˆ€ {A} â†’ âˆ… âŠ¢â‚‘ A â†’ âˆ… âŠ¢áµ¥ A â†’ Set where -- only run on closed terms

  -- v â‡“ v
  â‡“-val : âˆ€ {A} {V : âˆ… âŠ¢áµ¥ A}
        --------------
        â†’ (val V) â‡“ V  -- simply get rid of the `val`

  -- binops
  â‡“-âˆ§ : âˆ€ {ğ“â‚˜ ğ“â‚™ Vâ‚˜ Vâ‚™} {M : âˆ… âŠ¢â‚‘ `ğ”¹ / ğ“â‚˜} {N : âˆ… âŠ¢â‚‘ `ğ”¹ / ğ“â‚™}
      â†’ M â‡“ Vâ‚˜
      â†’ N â‡“ Vâ‚™
        ------------------------
      â†’ (M `âˆ§ N) â‡“ (Vâ‚˜ âŸ¦âˆ§âŸ§ Vâ‚™)

  â‡“-âˆ¨ : âˆ€ {ğ“â‚˜ ğ“â‚™ Vâ‚˜ Vâ‚™} {M : âˆ… âŠ¢â‚‘ `ğ”¹ / ğ“â‚˜} {N : âˆ… âŠ¢â‚‘ `ğ”¹ / ğ“â‚™}
      â†’ M â‡“ Vâ‚˜
      â†’ N â‡“ Vâ‚™
        ------------------------
      â†’ (M `âˆ¨ N) â‡“ (Vâ‚˜ âŸ¦âˆ¨âŸ§ Vâ‚™)

  â‡“-condâ‚ : âˆ€ {ğ“â‚— A Vâ‚˜} {L : âˆ… âŠ¢â‚‘ `ğ”¹ / ğ“â‚—} {M : âˆ… âŠ¢â‚‘ A âŠ”â‚› ğ“â‚—} {N : âˆ… âŠ¢â‚‘ A âŠ”â‚› ğ“â‚—}
      â†’ L â‡“ (`true/ ğ“â‚—)
      â†’ M â‡“ Vâ‚˜
        ------------------------
      â†’ if L M N â‡“ Vâ‚˜  -- note that `Vâ‚˜` already inhebits type `A âŠ”â‚› ğ“â‚—`

  â‡“-condâ‚‚ : âˆ€ {ğ“â‚— A Vâ‚™} {L : âˆ… âŠ¢â‚‘ `ğ”¹ / ğ“â‚—} {M : âˆ… âŠ¢â‚‘ A âŠ”â‚› ğ“â‚—} {N : âˆ… âŠ¢â‚‘ A âŠ”â‚› ğ“â‚—}
      â†’ L â‡“ (`false/ ğ“â‚—)
      â†’ N â‡“ Vâ‚™
        ------------------------
      â†’ if L M N â‡“ Vâ‚™  -- note that `Vâ‚™` already inhebits type `A âŠ”â‚› ğ“â‚—`

  â‡“-app : âˆ€ {ğ“â‚˜ A B Vâ‚™ V Mâ€²} {M : âˆ… âŠ¢â‚‘ (A â‡’ B) / ğ“â‚˜} {N : âˆ… âŠ¢â‚‘ A}
      â†’ M â‡“ (Æ› Mâ€² / ğ“â‚˜)
      â†’ N â‡“ Vâ‚™
      â†’ (Mâ€² [ (val Vâ‚™) ]) â‡“ V
        ------------------------
      â†’ (M Â· N) â‡“ (V âŠ”áµ¥ ğ“â‚˜)
